<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>CSFramework的引出 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CSFramework的引出：几个简单的网络通信例子&amp;emsp;&amp;emsp;现如今，互联网几乎在我身边随处可见，早已深入我们人类生活中。如今的软件如果没有网络功能，那是很不可思议的事情。(单机游戏都有局域网功能，小时候和朋友联机打的红警就是例子)。许多语言都支持网络编程，我见过C与Java有关网络的程序代码，从中深刻感受到有工具和没工具编代码效率是多么天差地别。就相当于在赛跑，C还在那里造车轮子，">
<meta property="og:type" content="article">
<meta property="og:title" content="CSFramework的引出">
<meta property="og:url" content="https://honorzmj98.github.io/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="CSFramework的引出：几个简单的网络通信例子&amp;emsp;&amp;emsp;现如今，互联网几乎在我身边随处可见，早已深入我们人类生活中。如今的软件如果没有网络功能，那是很不可思议的事情。(单机游戏都有局域网功能，小时候和朋友联机打的红警就是例子)。许多语言都支持网络编程，我见过C与Java有关网络的程序代码，从中深刻感受到有工具和没工具编代码效率是多么天差地别。就相当于在赛跑，C还在那里造车轮子，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://honorzmj98.github.io/img/CSFramework/1.png">
<meta property="article:published_time" content="2020-03-11T00:36:59.000Z">
<meta property="article:modified_time" content="2020-03-11T01:03:42.642Z">
<meta property="article:author" content="HonorZmj98">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://honorzmj98.github.io/img/CSFramework/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://HonorZmj98.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-CSFramework的引出" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" class="article-date">
  <time datetime="2020-03-11T00:36:59.000Z" itemprop="datePublished">2020-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CSFramework的引出
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="CSFramework的引出：几个简单的网络通信例子"><a href="#CSFramework的引出：几个简单的网络通信例子" class="headerlink" title="CSFramework的引出：几个简单的网络通信例子"></a>CSFramework的引出：几个简单的网络通信例子</h2><p>&emsp;&emsp;现如今，互联网几乎在我身边随处可见，早已深入我们人类生活中。如今的软件如果没有网络功能，那是很不可思议的事情。(单机游戏都有局域网功能，小时候和朋友联机打的红警就是例子)。许多语言都支持网络编程，我见过C与Java有关网络的程序代码，从中深刻感受到有工具和没工具编代码效率是多么天差地别。就相当于在赛跑，C还在那里造车轮子，Java已经开始用别人给的车开始跑了。<br>&emsp;&emsp;最近一直在学习Java，因此用Java学习网络编程。C/S模式，又称客户端服务器模式。至少用两台计算机来分别充当客户机和服务器角色。C/S模式将应用（对于客户端来说）与服务（对于服务器来说）分离，两边各自开发自己的，两套程序。对于服务器，Java提供一个ServerSocket类来创建服务器，对于客户端，Java提供一个Socket类可以连接服务器。<br>&emsp;&emsp;接下来，就先写三个简单的网络通信的例子（一对一单次通信和一对一多次通信）来熟悉下相关类。</p>
<h3 id="一对一单次通信"><a href="#一对一单次通信" class="headerlink" title="一对一单次通信"></a>一对一单次通信</h3><p>&emsp;&emsp;一对一单次通信：一个服务器和一个客户端单次通信</p>
<p>服务器方代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> port = <span class="number">54188</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"开始启动服务器..."</span>);</span><br><span class="line">			ServerSocket server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">			System.out.println(<span class="string">"服务器启动成功!"</span>);</span><br><span class="line">			System.out.println(<span class="string">"开始侦听客户端连接请求..."</span>);</span><br><span class="line">			Socket client = server.accept();</span><br><span class="line">			InetAddress inetaddress = client.getInetAddress();</span><br><span class="line">			String clientIp = inetaddress.getHostAddress();	<span class="comment">//客户端ip地址</span></span><br><span class="line">			String clientName = inetaddress.getHostName(); <span class="comment">//客户端名称</span></span><br><span class="line">			System.out.println(<span class="string">"发现客户端(ip: "</span> + clientIp	+ <span class="string">", 主机名:"</span> + clientName + <span class="string">")请求连接服务器"</span>);</span><br><span class="line">			DataInputStream dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());  <span class="comment">//开始建立通信信道</span></span><br><span class="line">			DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">            System.out.println(<span class="string">"通信信道已建立完成"</span>);</span><br><span class="line">			</span><br><span class="line">			String message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自客户端的消息["</span> + message + <span class="string">"]"</span>);</span><br><span class="line">			dos.writeUTF(<span class="string">"我收到你的消息了"</span>);</span><br><span class="line">			</span><br><span class="line">			dis.close();</span><br><span class="line">			dos.close();</span><br><span class="line">			client.close();</span><br><span class="line">			server.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		String serverIp = <span class="string">"127.0.0.1"</span>;	</span><br><span class="line">        <span class="comment">//服务器ip地址，因为本地测试所以127.0.0.1</span></span><br><span class="line">		<span class="keyword">int</span> serverPort = <span class="number">54188</span>;</span><br><span class="line">        <span class="comment">//和服务器协商好的</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"开始连接服务器....."</span>);</span><br><span class="line">			Socket socket = <span class="keyword">new</span> Socket(serverIp, serverPort);</span><br><span class="line">			System.out.println(<span class="string">"连接成功"</span>);</span><br><span class="line">			DataInputStream dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			</span><br><span class="line">			dos.writeUTF(<span class="string">"你好，我是一个客户端"</span>);</span><br><span class="line">			String message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自服务器的消息:"</span> + message);</span><br><span class="line">			</span><br><span class="line">			dis.close();</span><br><span class="line">			dos.close();</span><br><span class="line">			socket.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;			<span class="comment">//服务器名称或地址不存在。未知主机异常</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">开始启动服务器...</span></span><br><span class="line"><span class="attr">服务器启动成功!</span></span><br><span class="line"><span class="attr">开始侦听客户端连接请求...</span></span><br><span class="line"><span class="meta">发现客户端(ip</span>: <span class="string">127.0.0.1, 主机名:127.0.0.1)请求连接服务器</span></span><br><span class="line"><span class="attr">通信信道已建立完成</span></span><br><span class="line"><span class="attr">来自客户端的消息[你好，我是一个客户端]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line"><span class="attr">开始连接服务器.....</span></span><br><span class="line"><span class="attr">连接成功</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">我收到你的消息了</span></span><br></pre></td></tr></table></figure>

<p>从上面一对一通信程序，希望你能了解到以下几点。</p>
<p>服务器方面:</p>
<ul>
<li>ServerSocket的建立需要port（端口号），且这个端口号必须和连接的客户端保持一直，也就是说要和客户端协商好。</li>
<li>如果没有客户端连接，程序会卡在accept()那个地方，可以类似于scanf函数，若没有客户端连接则程序会停在accept()那个地方，有客户端连接才会让程序向下进行</li>
<li>可以让客户端先不发消息（把发消息那里注释掉），观察情况，发现两个程序都卡住了，都卡在dis.readUTF()这里。所以dis.readUTF()这个方法也是类似于scanf函数，没有收到对端的消息就卡在这，程序不往下走。dis.readUTF()这个方法是读对端发来的消息，是被动的等，一直等，没有就停在这里</li>
<li>dos.writeUTF()相当于给对端发消息，主动的发消息。</li>
</ul>
<p>客户端方面:</p>
<ul>
<li>Socket的建立需要服务器的ip地址和和服务器协商好的port</li>
<li>也需要建立DataInputStream和DataOutputStream</li>
</ul>
<p>总结一下服务器和客户端都需要DataInputStream和DataOutputStream。它俩相当于什么呢？可以这么说就相当于我们学的通信原理里面的信道那个概念，两端进行信息交换的通信信道；也可以举个现实生活中的例子，就是我们的座机电话，他有两端，上面是听筒端（DataInputStream）和说话端（DataOutputStream）。</p>
<hr>
<h3 id="一对一多次通信"><a href="#一对一多次通信" class="headerlink" title="一对一多次通信"></a>一对一多次通信</h3><p>&emsp;&emsp;一对一多次通信:一个服务器和一个客户端多次通信</p>
<p>&emsp;&emsp;上述一对一单次通信的代码很简单，我们要从中熟悉一些需要用的类。但是，我相信肯定不是上面我们最终的目的吧？不可能通信只通信一句话吧？所以来进一步实现一个客户端和一个服务器多次通信。</p>
<p>&emsp;&emsp;如何进行多次通信呢？经过思考只要通信信道不关闭，就可以多次发送消息。但不能一直通信下去，要有办法停止，也就是可控性。所以定发特定的字符串就停止下来。</p>
<p>服务器代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> Socket client;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始建立服务器"</span>);</span><br><span class="line">		serverSocket = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		System.out.println(<span class="string">"服务器建立完成"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (client != <span class="keyword">null</span> &amp;&amp; !client.isClosed()) &#123;</span><br><span class="line">				client.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			client = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (serverSocket != <span class="keyword">null</span> &amp;&amp; !serverSocket.isClosed()) &#123;</span><br><span class="line">				serverSocket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			serverSocket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listeningClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">		client = serverSocket.accept();</span><br><span class="line">		System.out.println(<span class="string">"客户端["</span> + client.getInetAddress().getHostAddress() + <span class="string">", "</span> + client.getInetAddress().getHostName()</span><br><span class="line">				+ <span class="string">"]连入服务器"</span>);</span><br><span class="line">		</span><br><span class="line">		dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());</span><br><span class="line">		dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">		</span><br><span class="line">		String message = <span class="string">""</span>;</span><br><span class="line">        System.out.println(<span class="string">"接受来自客户端的消息..."</span>);</span><br><span class="line">		<span class="keyword">while</span> (!message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">			message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自客户端的消息:"</span> + message);</span><br><span class="line">			dos.writeUTF(<span class="string">"["</span> + message + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, IOException </span>&#123;</span><br><span class="line">		ip = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始连接服务器..."</span>);</span><br><span class="line">		socket = <span class="keyword">new</span> Socket(ip, port);</span><br><span class="line">		System.out.println(<span class="string">"连接服务器成功"</span>);</span><br><span class="line">		dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">		dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		String message = <span class="string">""</span>;</span><br><span class="line">		String messageFromServer;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">while</span>(!message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">				message = in.nextLine();</span><br><span class="line">				dos.writeUTF(message);</span><br><span class="line">				messageFromServer = dis.readUTF();</span><br><span class="line">				System.out.println(<span class="string">"来自服务器的消息:"</span> +messageFromServer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		in.close();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行代码。<strong>注意:</strong>要先运行服务器，在运行客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">new</span> SimpleServer().listeningClient();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">new</span> SimpleClient().talking();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显示结果如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">开始建立服务器</span></span><br><span class="line"><span class="attr">服务器建立完成</span></span><br><span class="line"><span class="attr">开始侦听客户端连接请求</span></span><br><span class="line"><span class="meta">客户端[127.0.0.1,</span> <span class="string">127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">接受来自客户端的消息...</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">你好</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">我是一个客户端</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">byebye</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line"><span class="attr">开始连接服务器...</span></span><br><span class="line"><span class="attr">连接服务器成功</span></span><br><span class="line"><span class="attr">你好</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[你好]</span></span><br><span class="line"><span class="attr">我是一个客户端</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[我是一个客户端]</span></span><br><span class="line"><span class="attr">byebye</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[byebye]</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="一对多多次通信"><a href="#一对多多次通信" class="headerlink" title="一对多多次通信"></a>一对多多次通信</h3><p>&emsp;&emsp;一对多多次通信:一个服务器和多个客户端的多次通信</p>
<p>&emsp;&emsp;前面的代码不是我们最终的目的，如果一个服务器只能接入一个客户端，你说他还能称为服务器吗？服务器作为网络节点中心管理者，要实现接入多个客户端的功能。经过分析上述代码得知之所以只接入了一个客户端的原因是，accept()方法只运行了一次，要想接入多个客户端，必须让accept()方法重复执行，我们可以把它放在循环里，条件是服务器关闭与否。但是还是有问题，前面说过accept()方法相当于scanf函数，没有接入它的客户端，程序会卡在那里阻止下面通信的代码。解决方法:用<font color= red><strong>线程</strong></font>。服务器accept()侦听客户端连接用线程并行去跑，不要影响我下面的代码。</p>
<p>&emsp;&emsp;同时分析上述代码我们可以知道每连接一个新的客户端都要新造一个独立的通信信道，这是当然啦，你要和服务器建立联系，就得造通信信道，该通信信道是只有你和服务器用的，独立的，不能让别人用。两端都要有通信信道(DataInputStream和DataOutputStream)所以我们最好把它单独拎出来做成一个类。同时我们知道dis.read()方法也相当于scanf函数，程序卡在这里不会运行以后的代码，你等待对端消息不能干扰我主动给对端发消息吧。因此，也用<font color= red><strong>线程</strong></font>解决。</p>
<p>&emsp;&emsp;只有做到以上两点，才能完成一对多多次通信。才能实现服务器边听（侦听客户端连接）边说（给对端发消息）！可以用以下图示来说明。</p>
<img src="/img/CSFramework/1.png" style="zoom: 50%;" />



<p>先写双方都需要建立的通信信道类Communcation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Communcation</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;	<span class="comment">//volatitle关键字:拒绝内存优化，这是线程安全相关问题</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communcation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socket = socket;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			goon = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"通信层"</span>).start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dos.writeUTF(message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				message = dis.readUTF();</span><br><span class="line">				dealPeerMessage(message);	<span class="comment">//处理对端消息具体做法让外面来决定</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">					dealPeerAbnoramlDrop();	<span class="comment">//当goon还是true的时候，说明是对端异常掉线，做法让外面来决定</span></span><br><span class="line">				&#125;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulServer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MulServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		System.out.println(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		goon = <span class="keyword">true</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始侦听客户端连接..."</span>);</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">false</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">		System.out.println(<span class="string">"服务器正常宕机"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> goon;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				System.out.println(<span class="string">"客户端["</span> + client.getInetAddress().getHostAddress() + </span><br><span class="line">						client.getInetAddress().getHostName() + <span class="string">"]连入服务器"</span>);</span><br><span class="line">				<span class="keyword">new</span> Communcation(client) &#123;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">						<span class="keyword">if</span> (message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">							System.out.println(<span class="string">"客户端正常下线"</span>);</span><br><span class="line">							close();</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						System.out.println(<span class="string">"收到来自客户端的消息:"</span> + message);</span><br><span class="line">						send(<span class="string">"["</span> + message +<span class="string">"]"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						System.out.println(<span class="string">"客户端异常掉线"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> Communcation communcation;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MulClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		serverIp = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (communcation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		communcation.send(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (communcation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		communcation.close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, IOException </span>&#123;</span><br><span class="line">		socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">		communcation = <span class="keyword">new</span> Communcation(socket) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"来自服务器的消息:"</span> + message);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"服务器异常宕机，服务停止"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		MulServer mulServer = <span class="keyword">new</span> MulServer();</span><br><span class="line">		Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		String command = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">boolean</span> finshed = <span class="keyword">false</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (!finshed) &#123;</span><br><span class="line">			command = in.next();</span><br><span class="line">			<span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"st"</span>)) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					mulServer.startUp();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"sd"</span>)) &#123;</span><br><span class="line">				mulServer.shutDown();</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"x"</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!mulServer.isStartup()) &#123;</span><br><span class="line">					finshed = <span class="keyword">true</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					System.out.println(<span class="string">"服务器尚未宕机!"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		in.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		MulClient client = <span class="keyword">new</span> MulClient();</span><br><span class="line">		<span class="keyword">boolean</span> finished = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client.connectToServer();</span><br><span class="line">			</span><br><span class="line">			Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">			</span><br><span class="line">			String message = <span class="string">""</span>;</span><br><span class="line">			<span class="keyword">while</span> (!finished) &#123;</span><br><span class="line">				message = in.next();</span><br><span class="line">				client.send(message);</span><br><span class="line">				<span class="keyword">if</span> (message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">					client.close();</span><br><span class="line">					finished = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			in.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行服务器测试代码，在运行客户端测试代码。进行测试结果如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">st</span></span><br><span class="line"><span class="attr">开始建立服务器...</span></span><br><span class="line"><span class="attr">服务器建立成功</span></span><br><span class="line"><span class="attr">开始侦听客户端连接...</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">123</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">456</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">789</span></span><br><span class="line"><span class="attr">客户端正常下线</span></span><br><span class="line"><span class="attr">客户端异常掉线</span></span><br><span class="line"><span class="attr">客户端正常下线</span></span><br><span class="line"><span class="attr">sd</span></span><br><span class="line"><span class="attr">服务器正常宕机</span></span><br><span class="line"><span class="attr">x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端1</span></span><br><span class="line"><span class="attr">123</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[123]</span></span><br><span class="line"><span class="attr">byebye</span></span><br><span class="line"><span class="comment">#客户端2 故意强制关闭</span></span><br><span class="line"><span class="attr">456</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[456]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端3</span></span><br><span class="line"><span class="attr">789</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[789]</span></span><br><span class="line"><span class="attr">byebye</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;&emsp;一对多多次通信就完成了。服务器可以接入多个客户端，客户端可以发消息给服务器。但是，这就完了吗？这就是我们想要的吗？我并不认为就完了，我们做的功能太简陋了，完全不够用。同时思考可不可以将底层通信的代码做成工具，做成普适性工具，这样以后开发不同需求的C/S程序就会方便很多。这就是框架的含义，也就是我们要做的工具CSFramework。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" data-id="ckf11woqa0007b0i2fgcc7ugz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CSFramework小型开发工具
        
      </div>
    </a>
  
  
    <a href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">XML文件与Properites文件解析工具</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/12/20200912@swing/">20200912@swing</a>
          </li>
        
          <li>
            <a href="/2020/09/11/20200911@%E6%8E%A5%E5%8F%A3@%E6%8E%92%E5%BA%8F/">20200911@接口@排序</a>
          </li>
        
          <li>
            <a href="/2020/04/08/20200408@%E6%A8%A1%E6%8B%9F%E7%AE%80%E6%98%93Spring/">20200408@模拟简易Spring</a>
          </li>
        
          <li>
            <a href="/2020/04/05/20200405@%E5%AE%9A%E6%97%B6%E5%99%A8@%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6@%E5%8C%85%E6%89%AB%E6%8F%8F/">20200405@定时器@代理机制@包扫描</a>
          </li>
        
          <li>
            <a href="/2020/04/03/20200403@%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5@BS@%E5%BA%95%E5%B1%82%E9%80%9A%E4%BF%A1%E4%BF%A1%E6%81%AF@%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C@Communication%E5%88%9D%E6%AD%A5/">20200403@淘汰策略@BS@底层通信信息@文件操作@Communication初步</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 HonorZmj98<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>