<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>CSFramework小型开发工具 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;emsp;&amp;emsp;我们在计算机网络课程中学过网络的OSI的七层模型，但只是理解其描述的一些概念，并没有真正的实现，只是个概念性框架。而另一种提出的TCP&#x2F;IP参考模型被投入应用了。参考前两种层次模型，我们可以提出CSFramework使用的层次模型，如下图。   &amp;emsp;&amp;emsp;首先是最底层通信层（Communication），该层只关心最底层通信的事和对端异常掉线问题，但不关心接收">
<meta property="og:type" content="article">
<meta property="og:title" content="CSFramework小型开发工具">
<meta property="og:url" content="https://honorzmj98.github.io/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="&amp;emsp;&amp;emsp;我们在计算机网络课程中学过网络的OSI的七层模型，但只是理解其描述的一些概念，并没有真正的实现，只是个概念性框架。而另一种提出的TCP&#x2F;IP参考模型被投入应用了。参考前两种层次模型，我们可以提出CSFramework使用的层次模型，如下图。   &amp;emsp;&amp;emsp;首先是最底层通信层（Communication），该层只关心最底层通信的事和对端异常掉线问题，但不关心接收">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://honorzmj98.github.io/img/CSFramework/2.png">
<meta property="og:image" content="https://honorzmj98.github.io/img/CSFramework/3.png">
<meta property="article:published_time" content="2020-03-17T06:48:00.000Z">
<meta property="article:modified_time" content="2020-03-30T01:33:54.313Z">
<meta property="article:author" content="HonorZmj98">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://honorzmj98.github.io/img/CSFramework/2.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://HonorZmj98.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-CSFramework小型开发工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-03-17T06:48:00.000Z" itemprop="datePublished">2020-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CSFramework小型开发工具
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;我们在计算机网络课程中学过网络的OSI的七层模型，但只是理解其描述的一些概念，并没有真正的实现，只是个概念性框架。而另一种提出的TCP/IP参考模型被投入应用了。参考前两种层次模型，我们可以提出CSFramework使用的层次模型，如下图。</p>
<img src="/img/CSFramework/2.png" alt="2" style="zoom: 67%;" />

<p>&emsp;&emsp;首先是最底层<font color= red><strong>通信层</strong>（Communication）</font>，该层只关心最底层通信的事和对端异常掉线问题，但不关心接收到的相关信息该如何处理。信息的处理不在这一层，这一层没有权利处理信息，只是将信息发给对端的作用。</p>
<p>&emsp;&emsp;下来是<font color= red><strong>会话层</strong>（Conversation）</font>,该层会收到来自下层的包装好的信息（协议），根据信息的内容去处理信息。该层可以看出对等层的概念，ServerConversation和ClientConversation之间的交锋。在sever这边看ServerConversation就是客户端，在client这边看ClientConversation就是服务器。</p>
<p>&emsp;&emsp;工具的最后一层是<font color= red><strong>Server层</strong>和<strong>Client层</strong></font>，该层是提供给外面使用的，而下面层都是工具的内部东西，不提供给外面用。所以，层是一步步建立起来的，你虽然只看到最高层用的简单，却不知道底下要有多少层在默默支持着。工具也是这样，最后用户使用的十分方便，可工具制造者才能直到建立的艰辛。<em>“辛苦我一人，幸福千万家！”</em>工具制造者最终的追求。话题扯远了，因为是CSFramework的最后一层，那就要包括CS一些普遍且必要的一些内容。例如，服务器这边的启动服务器和关闭服务器，客户端那边的连接服务器和下线，单发消息，群发消息等功能。</p>
<p>&emsp;&emsp;再高层称为<font color= red><strong>应用层</strong></font>，该层的实现不管因为会因为不同的APP而不同，所以更高层的开发由CSFramework工具的使用者去完成，就不用关心我底层的实现了。</p>
<p>&emsp;&emsp;先把整体要搭建的框架一说，接下来就开始造我们的工具。<em>友情提示：可能有些类会突兀的出现，先不要纠结于此，因为我把这个代码已经写过好几次了，一步步实现叙述太麻烦了，所以给最终代码，当然期间细节思想会讲的</em></p>
<h2 id="CSFramework"><a href="#CSFramework" class="headerlink" title="CSFramework"></a>CSFramework</h2><h3 id="com-mec-csframework-core包"><a href="#com-mec-csframework-core包" class="headerlink" title="com.mec.csframework.core包"></a>com.mec.csframework.core包</h3><p>第一个肯定是我们最底层且是Server和Client都共有的通信层Communication类，前面也说了，该类只关心信息的传输，因此该层就是建立通信信道和接受发信息的过程。</p>
<h4 id="Communication类（通信层）"><a href="#Communication类（通信层）" class="headerlink" title="Communication类（通信层）"></a>Communication类（通信层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Communication</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//方法几乎都是包权限，因为只在工具中用，工具的保护</span></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communication</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socket = socket;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			goon = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"通信层"</span>).start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span></span>;<span class="comment">//处理对端信息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span></span>;<span class="comment">//对端异常掉线</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				message = dis.readUTF();</span><br><span class="line">				dealPeerMessage(<span class="keyword">new</span> NetMessage(message));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">					peerAbnormalDrop();</span><br><span class="line">				&#125;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dos.writeUTF(message.toString());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在想这么一种情况，我一个客户端要给另一个客户端发送“byebye”消息，该消息被服务器接收到后，服务器误认为它要下线（如上篇博文规定的那样），就去做下线操作了，实际上我们只是想把信息发给另一个客户端，并无下线的意思。因此，我认为如果Communication仅仅只传字符串String类型有点不够，我们应该对网络消息规范化，将网络命令和真正的会话内容区分开了，因此有了NetMessage类。</p>
<h4 id="NetMessage类（传输的网络信息）"><a href="#NetMessage类（传输的网络信息）" class="headerlink" title="NetMessage类（传输的网络信息）"></a>NetMessage类（传输的网络信息）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetMessage</span> </span>&#123;</span><br><span class="line">	<span class="comment">//发送和接受的信息必须是该类对象</span></span><br><span class="line">	<span class="keyword">private</span> ENetCommand command;</span><br><span class="line">	<span class="keyword">private</span> String action;</span><br><span class="line">	<span class="keyword">private</span> String parameter;</span><br><span class="line">	</span><br><span class="line">	NetMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	NetMessage(String message) &#123;<span class="comment">//根据制订的规矩解析</span></span><br><span class="line">		<span class="keyword">int</span> colonIndex = message.indexOf(<span class="string">':'</span>);</span><br><span class="line">		<span class="keyword">this</span>.command = ENetCommand.valueOf(message.substring(<span class="number">0</span>, colonIndex));</span><br><span class="line">		message = message.substring(colonIndex + <span class="number">1</span>);</span><br><span class="line">		colonIndex = message.indexOf(<span class="string">':'</span>);</span><br><span class="line">		String actionStr = message.substring(<span class="number">0</span>, colonIndex).trim();</span><br><span class="line">		<span class="keyword">this</span>.action = (actionStr.length() &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : actionStr);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.parameter = message.substring(colonIndex + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;<span class="comment">//规矩 命令:动作:信息</span></span><br><span class="line">		<span class="keyword">return</span> command + <span class="string">":"</span> + (action == <span class="keyword">null</span> ? <span class="string">" "</span> : action) + <span class="string">":"</span> + parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">ENetCommand <span class="title">getCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> command;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setCommand</span><span class="params">(ENetCommand command)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.command = command;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> action;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setAction</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.action = action;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setParameter</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.parameter = parameter;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传输的信息由command（命令），action（动作，这个以后会用到不必深究），parameter（真正的消息）组成。其中带参构造是解析过程，toString方法是封装一个信息过程。为了表示网络命令的简单，我们可以使用Enum（枚举）。</p>
<h4 id="ENetCommand（枚举命令）"><a href="#ENetCommand（枚举命令）" class="headerlink" title="ENetCommand（枚举命令）"></a>ENetCommand（枚举命令）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ENetCommand &#123;</span><br><span class="line"></span><br><span class="line">	ServerFoeceDown,</span><br><span class="line">	ServerFull,</span><br><span class="line">	WhoAreYou,</span><br><span class="line">	IAm,</span><br><span class="line">	EnsureOnline,</span><br><span class="line">	Offline,</span><br><span class="line">	ToOne,</span><br><span class="line">	ToAll,</span><br><span class="line">	</span><br><span class="line">	Request,</span><br><span class="line">	Response,</span><br><span class="line">	</span><br><span class="line">	ClientAbnormalDrop,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个肯定不是未卜先知就知道所有的命令，这个是最终代码效果。</p>
<p>至此，一个编程手法就出现了。<strong>我通过NetMessage这个类屏蔽了底层真正传输的信息，我只接受NetMessage类的对象的结果。不允许你发任意String。这样约束了你的行为，我的解析变得有章可循。这就叫做<font color= red>协议</font></strong>。</p>
<p>接下来就建立下一层会话层(Conversation)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现它们是继承Communication来的，然后什么都写不了。是呀，你根本没有需求啊，没有需求让他们之间进行交锋，所以当然什么都写不了。那就去建立更高层Client和Server。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>);</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//TODO 做侦听到一个客户端连接要做的事</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里出现了三个接口，有必要解释一下。首先是IDefaultNetConfig</p>
<h4 id="IDefaultNetConfig接口（默认配置）"><a href="#IDefaultNetConfig接口（默认配置）" class="headerlink" title="IDefaultNetConfig接口（默认配置）"></a>IDefaultNetConfig接口（默认配置）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDefaultNetConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> DEFAULT_PORT = <span class="number">54188</span>;		<span class="comment">//默认的端口号</span></span><br><span class="line">	String DEFAULT_SERVER_IP = <span class="string">"127.0.0.1"</span>;	<span class="comment">//默认服务器ip地址，本地地址</span></span><br><span class="line">	<span class="keyword">int</span> DEFAULT_MAX_Client_COUNT = <span class="number">200</span>;	<span class="comment">//默认服务器最大连接数量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单理解是默认的设置，仅仅是本地的一般测试，用户可以使用相关init方法进行修改。</p>
<p>而接下来就是讲一个重要的思想，<font color= red><strong>观察者模式</strong></font>。</p>
<p>我们知道，server有许多信息例如服务器启动、客户端上线等信息是要处理的，很明显我们server工具对于这些信息不能插手，要交给上面APP层去处理，但是APP处理该信息我们做工具的根本不得而知，它可以System.out.println()在控制台输出下，也有可能是命令行模式，还有可能是我们以后写的界面显示一下。所以这么多不确定性该如何操作？这个时候就要使用接口了。让APP层提供一个能够处理在Server层信息的方法，我们Server调用这个方法，而APP具体如何处理信息我们不管，这和我工具Server无关。</p>
<h4 id="IListener接口（倾听者）"><a href="#IListener接口（倾听者）" class="headerlink" title="IListener接口（倾听者）"></a>IListener接口（倾听者）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">processMessage</span><span class="params">(String message)</span></span>;	<span class="comment">//处理消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APP层去实现这个接口，去具体实现如何处理消息</p>
<h4 id="ISpeaker接口（倾诉者）"><a href="#ISpeaker接口（倾诉者）" class="headerlink" title="ISpeaker接口（倾诉者）"></a>ISpeaker接口（倾诉者）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span></span>;		<span class="comment">//添加听众</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span></span>;	<span class="comment">//删除听众</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span></span>;	<span class="comment">//发布消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server实现这个接口，其中方法包括增加听众（IListener的实现类），删除听众（不再倾听就删除），发布消息，向每个听众发送消息，你如何处理是你的事，我反正都发，所有听众都发。</p>
<p>如果你还是不理解我再举个简单例子。ISpeaker相当于一个报社，IListener相当于一个订报纸的人。报社根本不管用户拿到报纸如何读报纸，报社只管增加订报纸的人，删除退订的人，和向每个订了报纸的人送报纸。而订报纸的用户处理得到的报纸信息，各自有各自的处理办法。</p>
<p>这就是<em>观察者模式</em>。</p>
<p>好，接下来继续写Server层。我们做到了侦听到一个客户端（Socket），接下来该怎么做？该client是Client层那个吗？不是的，服务器和客户端是分别开发的，Server层这边根本没有任何Client层的东西，再看最开始的结构图，Server与Client进行通信必须向下经过Conversation层，因此应该用这个client去实例化个serverConversation，正如我前面所说的Conversation是对等层，在Server这边看serverConversation就是一个客户端。同时，我们在此提个疑问，难道侦听到一个连接就真的是一个正常的客户端吗？如果这个客户端连接上服务器，半天不说话，就会占用相关有效资源。假如有很多这种“僵尸机”，服务器的性能将会大打折扣。所以我们要准备两个客户端池，一个是真正有效的用户连接池，一个是临时的用户连接池，够不够资格当我的有效用户，要经过我服务器的测试才可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>);</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;	<span class="comment">//TODO</span></span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//TODO 通知所有在线客户端要强制宕机了</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//TODO 通知该客户端服务器爆满</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">//TODO 先加到tempClientList中，符合条件再说</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到Server多了两个类ClientPool和TemporaryClientList。</p>
<h4 id="ClientPool类（客户端连接池）"><a href="#ClientPool类（客户端连接池）" class="headerlink" title="ClientPool类（客户端连接池）"></a>ClientPool类（客户端连接池）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, ServerConversation&gt; clientPool;</span><br><span class="line">	</span><br><span class="line">	ClientPool() &#123;</span><br><span class="line">		clientPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientPool.isEmpty();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientPool.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientPool.keySet().contains(serverConversation.getId())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientPool.put(serverConversation.getId(), serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.keySet().contains(serverConversation.getId())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientPool.remove(serverConversation.getId());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">ServerConversation <span class="title">getClientById</span><span class="params">(String id)</span> </span>&#123;	<span class="comment">//得到某个特定的client，单发</span></span><br><span class="line">		<span class="keyword">if</span> (!clientPool.keySet().contains(id)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> clientPool.get(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;ServerConversation&gt; <span class="title">getClientListExceptId</span><span class="params">(String id)</span> </span>&#123;	<span class="comment">//得到除了某个的所有client，群发</span></span><br><span class="line">		List&lt;ServerConversation&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (String key : clientPool.keySet()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (key.equals(id)) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			result.add(clientPool.get(key));</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;ServerConversation&gt; <span class="title">getAllClient</span><span class="params">()</span> </span>&#123;	<span class="comment">//得到所有client</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> getClientListExceptId(<span class="keyword">null</span>);	<span class="comment">//只要调用上面方法传个绝不存在的键就行了</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>id是区分ServerConversation的键值，这个id如何来等下讲。</p>
<h4 id="TemporaryClientList类（临时客户端连接）"><a href="#TemporaryClientList类（临时客户端连接）" class="headerlink" title="TemporaryClientList类（临时客户端连接）"></a>TemporaryClientList类（临时客户端连接）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemporaryClientList</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;ServerConversation&gt; tempClientList;</span><br><span class="line">	</span><br><span class="line">	TemporaryClientList() &#123;</span><br><span class="line">		tempClientList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tempClientList.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (tempClientList.contains(serverConversation)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		tempClientList.add(serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!tempClientList.contains(serverConversation)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		tempClientList.remove(serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TemporaryClientList设置为LinkedList是因为在此徘徊进入的客户端很多所以用链表比数组好一点。</p>
<p>这两个类完全体现了<em>Java面对对象思想</em>里的分而治之，化繁为简的思想。ClientPool和TemporaryClientList的核心是里面的成员，所有方法都是围绕成员走的，相对纯粹，且逻辑不深，仅仅add和remove等操作，把它单独拿出来做一个类。</p>
<p><strong>核心思想：小部件做好经过测试，组成一个大部件，该部件一定是成功的</strong></p>
<p>因为有了客户端连接池，所以宕机的时候如果还有在线的用户则不能宕机。同时增加个强制宕机的方法。</p>
<p>好了，现在所有的TODO都是通信方面的问题了，这个我们先别着急，先去把Client层完善下，其实我在在做这个类的时候，也是许多类之间的跨越，所以自己一定要清晰该做什么，沿着主干去做。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到Client目前很简单就是一些初始化和最重要的连接服务器。现在想这样一种情况，连接服务器可能失败（服务器没开或者未找到相应服务器），失败后要提醒用户并且询问用户是否继续连接。同时还有许多用户操作例如服务器强制宕机、服务器爆满、服务器异常掉线，这些一定是会发生的事，我们可以在底层捕获到信息，但是没有权力处理他，处理权力只能在APP层。对于这种能够预知到要发生的事，但不能实现且完成，我们还是用<font color= red><strong>接口</strong></font>。</p>
<h4 id="IClientAction接口（客户端可能触发的行为）"><a href="#IClientAction接口（客户端可能触发的行为）" class="headerlink" title="IClientAction接口（客户端可能触发的行为）"></a>IClientAction接口（客户端可能触发的行为）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IClientAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">afterOnline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnormalDrop</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">beforeOffline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">confirmOffline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">afterOffline</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String sourceId, String message)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String sourceId, String message)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">otherClientDrop</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述还是最终代码，不必在意为什么一下能写这么多。和它相关的两个辅助类异常和适配器。</p>
<h4 id="ClientActionNotSetException类（用户行为未设置异常）"><a href="#ClientActionNotSetException类（用户行为未设置异常）" class="headerlink" title="ClientActionNotSetException类（用户行为未设置异常）"></a>ClientActionNotSetException类（用户行为未设置异常）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActionNotSetException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5752188492855205231L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientActionAdapter类（用户行为适配器）"><a href="#ClientActionAdapter类（用户行为适配器）" class="headerlink" title="ClientActionAdapter类（用户行为适配器）"></a>ClientActionAdapter类（用户行为适配器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActionAdapter</span> <span class="keyword">implements</span> <span class="title">IClientAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String sourceId, String message)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String sourceId, String message)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">otherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientActionNotSetException异常类是为了规定用户对ClientAction进行设置，ClientActionAdapter适配器类就和界面部分的适配器一样，不同的时候要用不同的方法。</p>
<p>接下来就可以根据IClientAction去完善Client。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client基本设置就完成了。现在就是完成基本通信的问题了。可以看回Server类的三个TODO。接下来就是Server、ServerConversation、Client、ClientConversation之间的来回频繁切换了。始终记得Conversation收发会话信息，最终操作到Server或者Client。</p>
<ul>
<li><p>通知所有在线客户端强制宕机：得到所有在线用户相关的的ServerConversation，发送ENetCommand.ServerFoeceDown会话信息，ClientConversation接收到此信息，去做用户规定的服务器强制关闭的行为。</p>
</li>
<li><p>通知客户端服务器爆满：发送ENetCommand.ServerFull会话信息，ClientConversation接收到此信息，去做服务器满相关行为。</p>
</li>
<li><p>上线这个过程要好好说一下。此时情形是这个客户端（serverConversation）存在在临时连接里，还未加到真正的用户池里，目的是为了防止“僵尸主机”。到后期我们可以使用一个计时器如果不通信就踢出去。现在考虑真正的有效用户。服务器首先发送会话信息ENetCommand.WhoAreYou，clientConversation收到该信息，并返回发送信息ENetCommand.IAm且是带参的，参数是什么呢？在网络中标识各个主机的是ip地址，所以参数是ip地址。serverConversation收到消息，根据ip来创造id值，注意id是用在clientPool里的，因此要不能重复，ip可能重复呀，一个主机多次登陆怎么办，所以我们要找个一直在变的东西，现实生活中有这个东西，就是<font color= red><strong>时间</strong></font>。所以id就是ip + ：+当前时间组合而成的。clientconversation收到后设置下自己的id，以便和服务器一致。同时去做上线成功后的操作。</p>
</li>
<li><p>还有就是对端异常掉线问题。客户端这边服务器异常掉线具体操作不是工具应该考虑的，所以还是用clientAction。服务器这里客户端异常掉线，除了从用户池中删除。还要通知其他在线客户端有异常掉线的，会话信息是ENetCommand.ClientAbnormalDrop，参数是异常掉线客户端id的值。clientConversation这里接收到，上传到client层由clientAction去完成。</p>
</li>
<li><p>还有就是客户端正常下线的问题了。这个请求是由客户端提出来的，因此加下线操作。clientAction里的confirmOffline()可以询问用户是否真的要下线，同时还有下线前操作和下线后操作方便一些资源的回收。下线过程就是clientConversation发送ENetCommand.Offline信息，serverConversation接收到做相应从用户池清除。</p>
<p>Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端[ "</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerConversation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> IAm:</span><br><span class="line">			ensureOnline(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> Offline:</span><br><span class="line">			server.offline(<span class="keyword">this</span>);</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientConversation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> ServerFoeceDown:</span><br><span class="line">			client.serverForcedown();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ServerFull:</span><br><span class="line">			client.serverFull();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WhoAreYou:</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EnsureOnline:</span><br><span class="line">			<span class="keyword">this</span>.id = parameter;</span><br><span class="line">			client.ensureOnline();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ClientAbnormalDrop:</span><br><span class="line">			client.dealOtherClientDrop(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>上述代码仅仅只是完成了服务器和客户端最基础的操作，例如上线下线。现在我们就要考虑更为重要的功能了。单聊和群聊，这是以后开发出来的APP的共有特性。例如聊天室的私聊和群聊。棋牌室的向大家展示牌。</p>
<p>私聊（toOne）和群聊（toAll）传递的信息都有个特性，都有源id（谁发送的），目标id（谁接收的）和真正发的信息组成的。因此，根据分而治之，我们在做一个类。</p>
<h4 id="InteractiveMessage类（交互信息）"><a href="#InteractiveMessage类（交互信息）" class="headerlink" title="InteractiveMessage类（交互信息）"></a>InteractiveMessage类（交互信息）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InteractiveMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String sourceId;</span><br><span class="line">	<span class="keyword">private</span> String targetId;</span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line">	</span><br><span class="line">	InteractiveMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	InteractiveMessage(String sourceId, String targetId, String message) &#123;</span><br><span class="line">		<span class="keyword">this</span>.sourceId = sourceId;</span><br><span class="line">		<span class="keyword">this</span>.targetId = targetId;</span><br><span class="line">		<span class="keyword">this</span>.message = message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getSourceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sourceId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setSourceId</span><span class="params">(String sourceId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sourceId = sourceId;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getTargetId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> targetId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setTargetId</span><span class="params">(String targetId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.targetId = targetId;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.message = message;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"from "</span> + sourceId + <span class="string">"to "</span> + targetId + <span class="string">":"</span> + message;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们知道我们在Communcation层传递真正的信息是String类型的，可不是现在写出的InteractiveMessage类，如何将对象变为字符串呢？以后对端得到字符串又可以转换回成相应的对象呢？这就需要大名鼎鼎的<font color= red><strong>Gson</strong></font>了。</p>
<ul>
<li>私聊过程：首先是由Client提出来的，参数是目标id和要发的信息，通过clientConversation将相应的交互信息通过Gson发送过去，服务器得到相应的字符串，再用Gson得到发送的对象的id，从用户池中得到相应的serverConversation，在发回给相应的客户端，相应的客户端有clientAction有专门的dealToOne。</li>
<li>群聊过程：和上述类似，不过改变时服务器得到除了发送者的所有其他serverConversation进行。</li>
</ul>
<p>现在就有个问题了，Gson那么好用，为什么底层NetMessage不用Gson呢？原因是：Gson将对象变为字符串，将字符串变为对象，一定有许多操作，而我们底层希望速度快，下标定位比Gson快。</p>
<h4 id="Server类（服务器层）"><a href="#Server类（服务器层）" class="headerlink" title="Server类（服务器层）"></a>Server类（服务器层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String targetId = interactiveMessage.getTargetId();</span><br><span class="line">		ServerConversation serverConversation = clientPool.getClientById(targetId);</span><br><span class="line">		<span class="keyword">if</span> (serverConversation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			serverConversation.toOne(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;ServerConversation&gt; serverConversations = clientPool.getClientListExceptId(interactiveMessage.getSourceId());</span><br><span class="line">		<span class="keyword">if</span> (serverConversations == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : serverConversations) &#123;</span><br><span class="line">			serverConversation.toAll(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerConversation类（服务器端会话层）"><a href="#ServerConversation类（服务器端会话层）" class="headerlink" title="ServerConversation类（服务器端会话层）"></a>ServerConversation类（服务器端会话层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> IAm:</span><br><span class="line">			ensureOnline(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> Offline:</span><br><span class="line">			server.offline(<span class="keyword">this</span>);</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToOne:</span><br><span class="line">			server.toOne(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToAll:</span><br><span class="line">			server.toAll(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientConversation类（客户端会话层）"><a href="#ClientConversation类（客户端会话层）" class="headerlink" title="ClientConversation类（客户端会话层）"></a>ClientConversation类（客户端会话层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> ServerFoeceDown:</span><br><span class="line">			client.serverForcedown();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ServerFull:</span><br><span class="line">			client.serverFull();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WhoAreYou:</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EnsureOnline:</span><br><span class="line">			<span class="keyword">this</span>.id = parameter;</span><br><span class="line">			client.ensureOnline();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ClientAbnormalDrop:</span><br><span class="line">			client.dealOtherClientDrop(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToOne:</span><br><span class="line">			client.dealToOne(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToAll:</span><br><span class="line">			client.dealToAll(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), targetId, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), <span class="keyword">null</span>, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client类（客户端）"><a href="#Client类（客户端）" class="headerlink" title="Client类（客户端）"></a>Client类（客户端）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toOne(targetId, message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToOne(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toAll(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToAll(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做到现在，我们已经完成了客户端基本的上线下线和最简单的私聊和群聊。但是在验证客户端登陆的时候，这个问题没有解决。所谓用户登陆，是用户将账号和密码输入后，需要传给服务器这些信息，然后服务器再在数据库中查询，并返回客户端相应的数据。</p>
<p>那么，该如何完成呢？可能会想在ENetCommand里再加新的命令UserLogin，这样当然可以解决问题，但是如果这样做以后客户端有许许多多的要在服务器端完成的操作，那就需要在ENetCommand加更多命令了。但是首先ENetCommand是我们工具的内部东西，你怎么让使用工具的人往里面加东西呢？其次ENetCommand可以增加的话，那里面所有的东西都需要增加东西了，再次强调我们做的是工具，工具内部不提供给外面！因此，<font color= red><strong>我们只打算给APP层提供一个开发框架，不能照顾到所有APP层实现的功能，对于这些功能，我们只能提供APP层实现相关功能的途径。</strong></font></p>
<p>结局方法在NetMessage里的action里。以前写的命令，都是C（客户端）给其他C发消息，但并没有返回给自己的情况，现在有了。C向S（服务端）发送请求并且希望得到回复。我们统一称为C向S发的是<font color= red>Request</font>，S获取到这个请求获取数据进行一系列操作，再给C返回结果称为<font color= red>Response</font>。</p>
<p>Client加sendRequest(String action, String parameter)方法，经过ClientConversation传到ServerConversation，然后问题来了，服务器收到这个该如何操作？仿照IClientAction写个IServerAction吗？提供给外面让其实现？里面是switch case case下去？那么要写几万个？每一个个要写几万行？每一个都是一个MVC模式，这样不行。我们再仔细考虑下，这些Request不都大同小异吗？都是S获得Request里面的数据，进行一系列操作，并返回一个东西给C。所以我可不可以让他自动执行？只要配置好相关XML文件。因此，想要自动完成要做以下三件事。</p>
<ul>
<li>APP层发送请求。例如：client.sendRequest(“userLogin”, 参数)。</li>
<li>在APP层的userAction写相关方法</li>
<li>配置相关XML文件</li>
</ul>
<p>相关XML文件格式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>= <span class="string">"userLogin"</span> <span class="attr">class</span>= <span class="string">"com.mec.test.server.user.action.UserAction"</span> <span class="attr">method</span>=<span class="string">"userLogin"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>= <span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>= <span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签action里的属性name是这个action的名字，就是sendRequest里参数的名字；class是完成这个action方法的包名称，method完成这个action的方法名称。标签parameter是方法的参数，name是参数名称，type是参数类型（八大基本类型直接写，其他类型带包名称）。</p>
<p>当然这里只写了一个action，随着APP开发功能的丰富，会不断增加的，并且这个不是在工具内部是可以随后任意按规则增加的XML文件。</p>
<p>难道每遇见一次action，就去解析一次XML吗？解析是外存操作，浪费时间，能不能一次解析。再分析XML文件，我们可以让action的属性name作为key键，后面其他部分都为value值。</p>
<h3 id="com-mec-csframework-action"><a href="#com-mec-csframework-action" class="headerlink" title="com.mec.csframework.action"></a>com.mec.csframework.action</h3><h4 id="ActionBeanDefinition类"><a href="#ActionBeanDefinition类" class="headerlink" title="ActionBeanDefinition类"></a>ActionBeanDefinition类</h4><p>简简单单描述value具体是由哪些组成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBeanDefinition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	<span class="keyword">private</span> Method method;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; parameterNameList;</span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionBeanDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		parameterNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		index = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getParameterNameListSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> hasNext = index &lt; parameterNameList.size();</span><br><span class="line">		<span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">			index = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> hasNext;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList.get(index++);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; getKlass() &#123;</span><br><span class="line">		<span class="keyword">return</span> klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setKlass</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.klass = klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Method <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> method;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.method = method;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addParameterName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		parameterNameList.add(name);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;String&gt; <span class="title">getParameterNameList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> klass + <span class="string">"\n\t"</span> + method;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActionBeanFactory类"><a href="#ActionBeanFactory类" class="headerlink" title="ActionBeanFactory类"></a>ActionBeanFactory类</h4><p>扫描XML任务，将所有扫面到的有效的action放进池子里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ActionBeanDefinition&gt; actionPool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		actionPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> ActionBeanDefinition <span class="title">getActionBeanDefinition</span><span class="params">(String actionName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> actionPool.get(actionName);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setObject</span><span class="params">(String action, Object object)</span> </span>&#123;</span><br><span class="line">		ActionBeanDefinition abd = actionPool.get(action);</span><br><span class="line">		<span class="keyword">if</span> (abd != <span class="keyword">null</span> &amp;&amp; abd.getObject() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			abd.setObject(object);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanActionMappingXMLPath</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		scanActionMappingXMLPath(<span class="string">"/actionMapping.xml"</span>);	<span class="comment">//默认扫描位置</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanActionMappingXMLPath</span><span class="params">(String xmlPath)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Document document = XMLParse.getDocument(xmlPath);</span><br><span class="line">		<span class="keyword">if</span> (document == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"配置文件不对"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String actionName = element.getAttribute(<span class="string">"actionName"</span>);</span><br><span class="line">				String className = element.getAttribute(<span class="string">"className"</span>);</span><br><span class="line">				String methodName =element.getAttribute(<span class="string">"methodName"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Class&lt;?&gt; klass = Class.forName(className);</span><br><span class="line">					ActionBeanDefinition actionBeanDefinition = <span class="keyword">new</span> ActionBeanDefinition();</span><br><span class="line">					actionBeanDefinition.setKlass(klass);</span><br><span class="line">					setMethod(element, klass, methodName, actionBeanDefinition);</span><br><span class="line">					actionPool.put(actionName, actionBeanDefinition);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(document, <span class="string">"action"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(Element element, Class&lt;?&gt; klass, String methodName, ActionBeanDefinition abd)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException </span>&#123;</span><br><span class="line">		List&lt;String&gt; parameterTypeNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String parameterName = element.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">				String typeName = element.getAttribute(<span class="string">"type"</span>);</span><br><span class="line">				abd.addParameterName(parameterName);</span><br><span class="line">				parameterTypeNameList.add(typeName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(element, <span class="string">"parameter"</span>);</span><br><span class="line">		<span class="keyword">int</span> parameterCount = parameterTypeNameList.size();</span><br><span class="line">		Class&lt;?&gt;[] parameterTypeArray = parameterCount &lt;=<span class="number">0</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Class&lt;?&gt;[parameterCount];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterCount; i++) &#123;</span><br><span class="line">			parameterTypeArray[i] = MecType.toType(parameterTypeNameList.get(i));</span><br><span class="line">		&#125;</span><br><span class="line">		Method method = klass.getMethod(methodName, parameterTypeArray);</span><br><span class="line">		abd.setMethod(method);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中XML解析工具，可以在以前写的博文查看到。还有一个类MecType。</p>
<h4 id="MecType类（工具包中的）"><a href="#MecType类（工具包中的）" class="headerlink" title="MecType类（工具包中的）"></a>MecType类（工具包中的）</h4><p>将字符串类型的String、int、boolean变为真正的类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MecType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MecType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; toType(String typeName) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"string"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> String<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"int"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"char"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">char</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"boolean"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"double"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">double</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"float"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">float</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"long"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">long</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"byte"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">byte</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"short"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">short</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> Class.forName(typeName);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="IActionProcessor接口（处理器接口）"><a href="#IActionProcessor接口（处理器接口）" class="headerlink" title="IActionProcessor接口（处理器接口）"></a>IActionProcessor接口（处理器接口）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IActionProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">dealRequest</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActionProcessorNotFound类（处理器未设置异常）"><a href="#ActionProcessorNotFound类（处理器未设置异常）" class="headerlink" title="ActionProcessorNotFound类（处理器未设置异常）"></a>ActionProcessorNotFound类（处理器未设置异常）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionProcessorNotFound</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">108844566290027953L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DefaultActionProcessor类（默认处理器）"><a href="#DefaultActionProcessor类（默认处理器）" class="headerlink" title="DefaultActionProcessor类（默认处理器）"></a>DefaultActionProcessor类（默认处理器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultActionProcessor</span> <span class="keyword">implements</span> <span class="title">IActionProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">dealRequest</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound </span>&#123;</span><br><span class="line">		ActionBeanDefinition actionBeanDefinition = ActionBeanFactory.getActionBeanDefinition(action);</span><br><span class="line">		<span class="keyword">if</span> (actionBeanDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ActionProcessorNotFound(<span class="string">"未找到对应处理器"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object object = actionBeanDefinition.getObject();</span><br><span class="line">		<span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				object = actionBeanDefinition.getKlass().getConstructor().newInstance();</span><br><span class="line">				actionBeanDefinition.setObject(object);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			Method method = actionBeanDefinition.getMethod();</span><br><span class="line">			ArgumentMaker argumentMaker = <span class="keyword">new</span> ArgumentMaker(parameter);</span><br><span class="line">			<span class="keyword">int</span> size = actionBeanDefinition.getParameterNameListSize();</span><br><span class="line">			Object[] valueList = size &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Object[size];</span><br><span class="line">			<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">			Parameter[] parameters = method.getParameters();</span><br><span class="line">			<span class="keyword">while</span> (actionBeanDefinition.hasNext()) &#123;</span><br><span class="line">				valueList[index] = argumentMaker.getArgumentByName(actionBeanDefinition.next(), parameters[index].getParameterizedType());</span><br><span class="line">				index++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Object result = method.invoke(object, valueList);</span><br><span class="line">				<span class="keyword">return</span> ArgumentMaker.gson.toJson(result);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound </span>&#123;</span><br><span class="line">		ActionBeanDefinition abd = ActionBeanFactory.getActionBeanDefinition(action);</span><br><span class="line">		<span class="keyword">if</span> (abd == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ActionProcessorNotFound(<span class="string">"未找到对应处理器"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object object = abd.getObject();</span><br><span class="line">		Method method = abd.getMethod();</span><br><span class="line">		Object[] value = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">		Parameter[] paramters = method.getParameters();</span><br><span class="line">		value[<span class="number">0</span>] = ArgumentMaker.gson.fromJson(parameter, paramters[<span class="number">0</span>].getParameterizedType());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			method.invoke(object, value);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过配置文件的方式，允许用户自己定义自己的类，通过反射机制来处理远端请求，分解出里面的action，根据action，将传过来的参数交给某一个类的方法，并且反射调用执行。</p>
<p><strong>分发器核心：</strong>分析action，找到action相应的处理方法，这就是分发器。</p>
<p>dealRequest方法和dealResponse方法都是为了调用以后APP层上写相关动作的方法，且都是通过反射机制调用执行的。方法的执行需要对象和参数值数组。</p>
<p>对于服务器端需要处理客户的的Request，其有可能有返回值也有可能没有返回值，有返回值的话其返回值类型是千变万化的，根本不能确定。因此又需要借助Gson了，将返回值作为Gson字符串对象，到时候也可以转换回来。</p>
<p>对于客户端要处理来自服务器的Response，且这时候得到服务器返回回来的Gson字符串，有一也且仅有一个。</p>
<p>这时，问题就出现了。</p>
<p>反射机制调用方法，invoke（对象，参数值数组）。问题就出现在参数值数组这里，这里的参数是由用户方法中参数确定的，正因为是用户自定义的，那参数类型就会千奇百怪且数量不定。如何将多个参数揉合在一起，那就要使用容器了List或者Map了。我们知道invoke方法的参数值数组的值顺序必须与方法参数顺序保持一致，所以乍一看使用顺序结构List比较方便，但做到后期发现有问题，Parameter类得到参数名字都是arg0,arg1的。所以还是用Map，键为参数名字，值为参数值，这样对应起来找的话也好找。再把Map对象变为Gson字符串，将Gson字符串在网络间通信，解析的时候再由得到的字符串变回为Map，从Map取各自的值。</p>
<p>但是还是有问题，我们知道Java会有<font color= blue><em>泛型擦除机制</em></font>，对于Map这种带有泛型的容器发送到对端根本不能解析。</p>
<p>幸运的是，办法总是比困难多，在网上找到Gson的高级使用方法——Typetoken。因此下来有了重要的一个类ArgumentMaker。</p>
<h4 id="ArgumentMaker类（工具包中的）"><a href="#ArgumentMaker类（工具包中的）" class="headerlink" title="ArgumentMaker类（工具包中的）"></a>ArgumentMaker类（工具包中的）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; argumentMap;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson gson = <span class="keyword">new</span> GsonBuilder().create();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Type type = <span class="keyword">new</span> TypeToken&lt;Map&lt;String, String&gt;&gt; () &#123;&#125;.getType();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ArgumentMaker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		argumentMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ArgumentMaker</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		argumentMap = gson.fromJson(parameter, type);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getArgumentByName</span><span class="params">(String name, Type type)</span> </span>&#123;</span><br><span class="line">		String json = argumentMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> gson.fromJson(json, type);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getArgumentByName</span><span class="params">(String name, Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		String json = argumentMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> gson.fromJson(json, klass);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ArgumentMaker <span class="title">add</span><span class="params">(String name, Object value)</span> </span>&#123;</span><br><span class="line">		argumentMap.put(name, gson.toJson(value));</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> gson.toJson(argumentMap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类核心操作都是围绕argumentMap这个成员走的。toString是构造，而带参构造方法则是解析。</p>
<p>总体来说，ArgumentMaker类出现是因为dealRequest和dealResponse的parameter参数会很复杂，如何将众多参数做成一个合起来的。发现参数有K、V关系。K：参数名，V：参数值。做成一个Map，再将Map进行Gson化，但是有泛型擦除机制，要借助Gson高级用法TypeToken。就这样一个工具产生了。</p>
<p>至此，CSFramework工具的所有类基本都介绍完了。</p>
<p>关于优化，不知道大家怎么感觉switch语句那里。反正个人觉得挺恶心的，写的有点长一个屏幕看不完，并且还会造成以下问题。</p>
<img src="/img/CSFramework/3.png" alt="3" style="zoom: 67%;" />

<p>我们知道，以后肯定是有很多客户端的，会造成多个线程都在这里停步，一个个进行switch的比对，或者这样说<strong>多进一出</strong>。这肯定会对性能造成影响，为了解决这个问题再次采用分发器（分析command，找到command的处理方法）处理。</p>
<h4 id="PeerMessageProcessor类（对端消息处理器）"><a href="#PeerMessageProcessor类（对端消息处理器）" class="headerlink" title="PeerMessageProcessor类（对端消息处理器）"></a>PeerMessageProcessor类（对端消息处理器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeerMessageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	</span><br><span class="line">	PeerMessageProcessor() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">		<span class="keyword">this</span>.klass = object.getClass();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String commandStr = command.name();</span><br><span class="line">		String methodName = <span class="string">"deal"</span> + commandStr;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Method method = klass.getDeclaredMethod(methodName, NetMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			method.invoke(object, message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server类（完整）"><a href="#Server类（完整）" class="headerlink" title="Server类（完整）"></a>Server类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String targetId = interactiveMessage.getTargetId();</span><br><span class="line">		ServerConversation serverConversation = clientPool.getClientById(targetId);</span><br><span class="line">		<span class="keyword">if</span> (serverConversation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			serverConversation.toOne(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;ServerConversation&gt; serverConversations = clientPool.getClientListExceptId(interactiveMessage.getSourceId());</span><br><span class="line">		<span class="keyword">if</span> (serverConversations == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : serverConversations) &#123;</span><br><span class="line">			serverConversation.toAll(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerConversation类（完整）"><a href="#ServerConversation类（完整）" class="headerlink" title="ServerConversation类（完整）"></a>ServerConversation类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	<span class="keyword">private</span> IActionProcessor actionProcessor;</span><br><span class="line">	<span class="keyword">private</span> PeerMessageProcessor peerMessageProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">		peerMessageProcessor = <span class="keyword">new</span> PeerMessageProcessor();</span><br><span class="line">		peerMessageProcessor.setObject(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setActionProcessor</span><span class="params">(IActionProcessor actionProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.actionProcessor = actionProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		peerMessageProcessor.dealPeerMessage(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealIAm</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ensureOnline(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOffline</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.offline(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.toOne(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.toAll(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealRequest</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		String action = message.getAction();</span><br><span class="line">		<span class="keyword">if</span> (actionProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actionProcessor = <span class="keyword">new</span> DefaultActionProcessor();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String requestResult = actionProcessor.dealRequest(action, parameter);</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Response)</span><br><span class="line">					.setAction(action)</span><br><span class="line">					.setParameter(requestResult));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ActionProcessorNotFound e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientConversation类（完整）"><a href="#ClientConversation类（完整）" class="headerlink" title="ClientConversation类（完整）"></a>ClientConversation类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> IActionProcessor actionProcessor;</span><br><span class="line">	<span class="keyword">private</span> PeerMessageProcessor peerMessageProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">		peerMessageProcessor = <span class="keyword">new</span> PeerMessageProcessor();</span><br><span class="line">		peerMessageProcessor.setObject(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setActionProcessor</span><span class="params">(IActionProcessor actionProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.actionProcessor = actionProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		peerMessageProcessor.dealPeerMessage(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealServerFoeceDown</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.serverForcedown();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealServerFull</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.serverFull();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealWhoAreYou</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealEnsureOnline</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = message.getParameter();</span><br><span class="line">		client.ensureOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealClientAbnormalDrop</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealOtherClientDrop(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealToOne(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealToAll(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		String action = message.getAction();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">if</span> (actionProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actionProcessor = <span class="keyword">new</span> DefaultActionProcessor();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			actionProcessor.dealResponse(action, parameter);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ActionProcessorNotFound e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), targetId, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), <span class="keyword">null</span>, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String action, String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Request)</span><br><span class="line">				.setAction(action).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client类（完整）"><a href="#Client类（完整）" class="headerlink" title="Client类（完整）"></a>Client类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toOne(targetId, message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToOne(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toAll(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToAll(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String action, String parameter)</span> </span>&#123;</span><br><span class="line">		clientConversation.sendRequest(action, parameter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，关于CSFramework的长连接就到此结束了。其中遇到的问题、问题的解决方法和心路历程都在博文里面写了，谢谢阅读。</p>
<p>感谢<strong>铁血教主</strong>的细心指导。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" data-id="ck8bqrj0e0003t4i2fbp17nun" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CSFramework的引出</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">CSFramework小型开发工具</a>
          </li>
        
          <li>
            <a href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/">CSFramework的引出</a>
          </li>
        
          <li>
            <a href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/">XML文件与Properites文件解析工具</a>
          </li>
        
          <li>
            <a href="/2020/03/03/EasySwing%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90%E7%95%8C%E9%9D%A2%E7%9A%84%E5%B7%A5%E5%85%B7/">EasySwing一键生成界面的工具</a>
          </li>
        
          <li>
            <a href="/2020/03/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/">我的第一篇博客</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 HonorZmj98<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>