<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://honorzmj98.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="HonorZmj98">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://HonorZmj98.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-20200913@swing" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/13/20200913@swing/" class="article-date">
  <time datetime="2020-09-13T15:19:17.474Z" itemprop="datePublished">2020-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/13/20200913@swing/">20200913@swing</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Swing"><a href="#Swing" class="headerlink" title="Swing"></a>Swing</h1><p>GUI（Graphical User Interface）图形用户界面，它的三要素。</p>
<ul>
<li><p>控件类</p>
<p>控件类各式各样有很多中，我们的要求时见过就行，用过才算。</p>
<p>对于每一个控件基本三大步骤：</p>
<p>1.实例化控件对象</p>
<p>2.设置大小位置，内容等信息</p>
<p>3.增加到container里</p>
<p>对于上述基本固定的套路，为了使代码功能更加清晰，更方便对代码修改和维护，可设计一个接口，将这些套路规定下来。将有关字体设为常量，这样就在做到代码复用了。</p>
</li>
<li><p>定位技术</p>
<p>布局管理模式。例如流式布局，边界布局，网格布局模式。</p>
</li>
<li><p>交互技术</p>
<p>监听用户对界面的操作例如点击。面向事件编程，对于来自于键鼠输入数据行为，产生对事件的响应。</p>
</li>
</ul>
<p>  在编写响应事件程序时，关注以下三个点：</p>
<p>  1.在哪个控件上发生了事件</p>
<p>  2.具体是什么事件（键鼠操作）</p>
<p>  3.对这个事件要怎样处理</p>
<p>  以下是做的一个简单页面</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line">com.mec.studentInfoView包里</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentInfoView</span> <span class="keyword">implements</span> <span class="title">IMecView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> JFrame jfrmMain;</span><br><span class="line">	<span class="keyword">private</span> Container container;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnAdd;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnDelete;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnModify;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnExit;</span><br><span class="line">	<span class="keyword">private</span> JRadioButton jrdbtMale;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnAll;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnFlush;</span><br><span class="line">	<span class="keyword">private</span> JButton jbtnFanxuan;</span><br><span class="line">	<span class="keyword">private</span> JComboBox&lt;String&gt; jcmbMonth;</span><br><span class="line">	<span class="keyword">private</span> JComboBox&lt;String&gt; jcmbYear;</span><br><span class="line">	<span class="keyword">private</span> JComboBox&lt;String&gt; jcmbDay;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] hobbyList = &#123;<span class="string">"足球"</span>, <span class="string">"篮球"</span>, <span class="string">"睡觉"</span>, <span class="string">"游戏"</span>, <span class="string">"吃饭"</span>,<span class="string">"听歌"</span>, <span class="string">"玩手机"</span>, <span class="string">"游泳"</span>&#125;;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JCheckBox[] jckbHobby = <span class="keyword">new</span> JCheckBox[hobbyList.length];</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">StudentInfoView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		initView();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		jfrmMain = <span class="keyword">new</span> JFrame(<span class="string">"学生管理系统"</span>);</span><br><span class="line">		jfrmMain.setSize(<span class="number">680</span>, <span class="number">560</span>);</span><br><span class="line">		jfrmMain.setLocationRelativeTo(<span class="keyword">null</span>);</span><br><span class="line">		jfrmMain.setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);</span><br><span class="line">		<span class="keyword">this</span>.container = jfrmMain.getContentPane();</span><br><span class="line">		container.setLayout(<span class="keyword">new</span> BorderLayout());</span><br><span class="line">		</span><br><span class="line">		JLabel jlblTopic = <span class="keyword">new</span> JLabel(<span class="string">"学生管理系统界面"</span>);</span><br><span class="line">		jlblTopic.setFont(topicFont);</span><br><span class="line">		jlblTopic.setForeground(topicColor);</span><br><span class="line">		jlblTopic.setHorizontalAlignment(SwingConstants.CENTER);</span><br><span class="line">		container.add(jlblTopic, BorderLayout.NORTH);</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlLeftBlank = <span class="keyword">new</span> JPanel();</span><br><span class="line">		jpnlLeftBlank.setFont(normalFont);</span><br><span class="line">		JLabel jlblLeft = <span class="keyword">new</span> JLabel(<span class="string">" "</span>);</span><br><span class="line">		jpnlLeftBlank.add(jlblLeft);</span><br><span class="line">		container.add(jpnlLeftBlank, BorderLayout.WEST);</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlRightBlank = <span class="keyword">new</span> JPanel();</span><br><span class="line">		JLabel jlblRight = <span class="keyword">new</span> JLabel(<span class="string">" "</span>);</span><br><span class="line">		jpnlRightBlank.setFont(normalFont);</span><br><span class="line">		jpnlRightBlank.add(jlblRight);</span><br><span class="line">		container.add(jpnlRightBlank, BorderLayout.EAST);</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlFoot = <span class="keyword">new</span> JPanel();</span><br><span class="line">		jbtnAdd = <span class="keyword">new</span> JButton(<span class="string">"添加"</span>);</span><br><span class="line">		jbtnAdd.setFont(normalFont);</span><br><span class="line">		jpnlFoot.add(jbtnAdd);</span><br><span class="line">		</span><br><span class="line">		jbtnDelete = <span class="keyword">new</span> JButton(<span class="string">"删除"</span>);</span><br><span class="line">		jbtnDelete.setFont(normalFont);</span><br><span class="line">		jpnlFoot.add(jbtnDelete);</span><br><span class="line">		</span><br><span class="line">		jbtnModify = <span class="keyword">new</span> JButton(<span class="string">"修改"</span>);</span><br><span class="line">		jbtnModify.setFont(normalFont);</span><br><span class="line">		jpnlFoot.add(jbtnModify);</span><br><span class="line">		</span><br><span class="line">		jbtnExit = <span class="keyword">new</span> JButton(<span class="string">"退出"</span>);</span><br><span class="line">		jbtnExit.setFont(normalFont);</span><br><span class="line">		jpnlFoot.add(jbtnExit);</span><br><span class="line">		</span><br><span class="line">		container.add(jpnlFoot, BorderLayout.SOUTH);</span><br><span class="line"></span><br><span class="line">		JPanel jpnlBody = <span class="keyword">new</span> JPanel(<span class="keyword">new</span> GridLayout(<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">5</span>));</span><br><span class="line">		container.add(jpnlBody, BorderLayout.CENTER);</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlConsole = <span class="keyword">new</span> JPanel(<span class="keyword">new</span> FlowLayout(FlowLayout.LEFT));</span><br><span class="line">		jpnlBody.add(jpnlConsole);</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlStudentList = <span class="keyword">new</span> JPanel(<span class="keyword">new</span> GridLayout(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">		jpnlBody.add(jpnlStudentList);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblStudentId = <span class="keyword">new</span> JLabel(<span class="string">"学       号"</span>);</span><br><span class="line">		jlblStudentId.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblStudentId);</span><br><span class="line">		</span><br><span class="line">		JTextField jtxfStudentId = <span class="keyword">new</span> JTextField(<span class="number">12</span>);</span><br><span class="line">		jtxfStudentId.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jtxfStudentId);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblStudentName = <span class="keyword">new</span> JLabel(<span class="string">"姓       名"</span>);</span><br><span class="line">		jlblStudentName.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblStudentName);</span><br><span class="line">		</span><br><span class="line">		JTextField jtxfStudentName = <span class="keyword">new</span> JTextField(<span class="number">12</span>);</span><br><span class="line">		jtxfStudentName.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jtxfStudentName);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblStudentPassword = <span class="keyword">new</span> JLabel(<span class="string">"密       码"</span>);</span><br><span class="line">		jlblStudentPassword.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblStudentPassword);</span><br><span class="line">		</span><br><span class="line">		JPasswordField jpswfPassword = <span class="keyword">new</span> JPasswordField(<span class="number">12</span>);</span><br><span class="line">		jpswfPassword.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jpswfPassword);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblStudentSex = <span class="keyword">new</span> JLabel(<span class="string">"性       别"</span>);</span><br><span class="line">		jlblStudentSex.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblStudentSex);</span><br><span class="line">		</span><br><span class="line">		jrdbtMale = <span class="keyword">new</span> JRadioButton(<span class="string">"男"</span>);</span><br><span class="line">		jrdbtMale.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jrdbtMale);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblPadding = <span class="keyword">new</span> JLabel(<span class="string">"                           "</span>);</span><br><span class="line">		jpnlConsole.add(jlblPadding);</span><br><span class="line">		</span><br><span class="line">		JRadioButton jrdbtFemale = <span class="keyword">new</span> JRadioButton(<span class="string">"女"</span>);</span><br><span class="line">		jrdbtFemale.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jrdbtFemale);</span><br><span class="line">		</span><br><span class="line">		ButtonGroup btgp = <span class="keyword">new</span> ButtonGroup();</span><br><span class="line">		btgp.add(jrdbtFemale);</span><br><span class="line">		btgp.add(jrdbtMale);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblBirthday = <span class="keyword">new</span> JLabel(<span class="string">"出生日期"</span>);</span><br><span class="line">		jlblBirthday.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblBirthday);</span><br><span class="line">		</span><br><span class="line">		jcmbYear = <span class="keyword">new</span> JComboBox&lt;&gt;();</span><br><span class="line">		jcmbYear.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jcmbYear);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblYear = <span class="keyword">new</span> JLabel(<span class="string">"年"</span>);</span><br><span class="line">		jlblYear.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblYear);</span><br><span class="line">		</span><br><span class="line">		jcmbMonth = <span class="keyword">new</span> JComboBox&lt;&gt;();</span><br><span class="line">		jcmbMonth.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jcmbMonth);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblMonth = <span class="keyword">new</span> JLabel(<span class="string">"月"</span>);</span><br><span class="line">		jlblMonth.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblMonth);</span><br><span class="line">		</span><br><span class="line">		jcmbDay = <span class="keyword">new</span> JComboBox&lt;&gt;();</span><br><span class="line">		jcmbDay.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jcmbDay);</span><br><span class="line">		</span><br><span class="line">		JLabel jlblDay = <span class="keyword">new</span> JLabel(<span class="string">"日"</span>);</span><br><span class="line">		jlblDay.setFont(normalFont);</span><br><span class="line">		jpnlConsole.add(jlblDay);</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlHobby = <span class="keyword">new</span> JPanel();</span><br><span class="line">		jpnlHobby.setLayout(<span class="keyword">new</span> GridLayout(<span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">		TitledBorder ttbdHobby = <span class="keyword">new</span> TitledBorder(<span class="string">"爱好"</span>);</span><br><span class="line">		ttbdHobby.setTitleFont(normalFont);</span><br><span class="line">		ttbdHobby.setTitleJustification(TitledBorder.TOP);</span><br><span class="line">		ttbdHobby.setTitleJustification(TitledBorder.CENTER);</span><br><span class="line">		jpnlHobby.setBorder(ttbdHobby);</span><br><span class="line">		jpnlConsole.add(jpnlHobby);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; hobbyList.length; i++) &#123;</span><br><span class="line">			jckbHobby[i] = <span class="keyword">new</span> JCheckBox(hobbyList[i]);</span><br><span class="line">			jckbHobby[i].setFont(normalFont);</span><br><span class="line">			jpnlHobby.add(jckbHobby[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		JPanel jpnlButton = <span class="keyword">new</span> JPanel();</span><br><span class="line">		jpnlButton.setLayout(<span class="keyword">new</span> FlowLayout(FlowLayout.LEFT, <span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line">		jpnlConsole.add(jpnlButton);</span><br><span class="line">		</span><br><span class="line">		jbtnAll = <span class="keyword">new</span> JButton(<span class="string">"全选"</span>);</span><br><span class="line">		jbtnAll.setFont(tinyFont);</span><br><span class="line">		jpnlButton.add(jbtnAll, FlowLayout.LEFT);</span><br><span class="line">		</span><br><span class="line">		jbtnFlush = <span class="keyword">new</span> JButton(<span class="string">"清空"</span>);</span><br><span class="line">		jbtnFlush.setFont(tinyFont);</span><br><span class="line">		jpnlButton.add(jbtnFlush, FlowLayout.CENTER);</span><br><span class="line">		</span><br><span class="line">		jbtnFanxuan = <span class="keyword">new</span> JButton(<span class="string">"反选"</span>);</span><br><span class="line">		jbtnFanxuan.setFont(tinyFont);</span><br><span class="line">		jpnlButton.add(jbtnFanxuan, FlowLayout.RIGHT);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		JTextArea jtxaIntroduce = <span class="keyword">new</span> JTextArea(<span class="number">4</span> , <span class="number">16</span>);</span><br><span class="line">		jtxaIntroduce.setFont(normalFont);</span><br><span class="line">		JScrollPane jscpIntroduce = <span class="keyword">new</span> JScrollPane(jtxaIntroduce);</span><br><span class="line">		TitledBorder ttbdIntroduce = <span class="keyword">new</span> TitledBorder(<span class="string">"个人简介"</span>);</span><br><span class="line">		ttbdIntroduce.setTitleFont(normalFont);</span><br><span class="line">		ttbdIntroduce.setTitlePosition(TitledBorder.TOP);</span><br><span class="line">		ttbdIntroduce.setTitleJustification(TitledBorder.CENTER);</span><br><span class="line">		jscpIntroduce.setBorder(ttbdIntroduce);</span><br><span class="line">		jpnlConsole.add(jscpIntroduce);</span><br><span class="line">		</span><br><span class="line">		DefaultListModel&lt;StudentInfoModel&gt; dfList = <span class="keyword">new</span> DefaultListModel&lt;&gt;();</span><br><span class="line">		JList&lt;StudentInfoModel&gt; jstudentList = <span class="keyword">new</span> JList&lt;&gt;(dfList);</span><br><span class="line">		JScrollPane jscpList = <span class="keyword">new</span> JScrollPane(jstudentList);</span><br><span class="line">		TitledBorder ttbdList = <span class="keyword">new</span> TitledBorder(<span class="string">"学生信息列表"</span>);</span><br><span class="line">		ttbdList.setTitleFont(normalFont);</span><br><span class="line">		ttbdList.setTitlePosition(TitledBorder.TOP);</span><br><span class="line">		ttbdList.setTitleJustification(TitledBorder.CENTER);</span><br><span class="line">		jscpList.setBorder(ttbdList);</span><br><span class="line">		jpnlStudentList.add(jscpList);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reinit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		jrdbtMale.setSelected(<span class="keyword">true</span>);</span><br><span class="line">		Util.setJComboboxMonth(jcmbMonth);</span><br><span class="line">		Util.setJComboboxYear(<span class="number">0</span>, <span class="number">22</span>, <span class="number">18</span>, jcmbYear);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		jfrmMain.addWindowListener(<span class="keyword">new</span> WindowAdapter() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">windowClosing</span><span class="params">(WindowEvent e)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					exitView();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (FrameIsNull e1) &#123;</span><br><span class="line">					e1.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;);</span><br><span class="line">		jbtnExit.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					exitView();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (FrameIsNull e1) &#123;</span><br><span class="line">					e1.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		jbtnAll.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">				Util.setJCheckboxsValue(jckbHobby, <span class="keyword">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		jbtnFlush.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">				Util.setJCheckboxsValue(jckbHobby, <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		jbtnFanxuan.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">				Util.setJCheckboxsReserve(jckbHobby);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		jcmbYear.addItemListener(<span class="keyword">new</span> ItemListener() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">itemStateChanged</span><span class="params">(ItemEvent e)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (e.getStateChange() == ItemEvent.SELECTED) &#123;</span><br><span class="line">					Util.setJComboboxDay(Integer.valueOf((String) jcmbYear.getSelectedItem()), </span><br><span class="line">							Integer.valueOf((String) jcmbMonth.getSelectedItem()), jcmbDay);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		jcmbMonth.addItemListener(<span class="keyword">new</span> ItemListener() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">itemStateChanged</span><span class="params">(ItemEvent e)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (e.getStateChange() == ItemEvent.SELECTED) &#123;</span><br><span class="line">					Util.setJComboboxDay(Integer.valueOf((String) jcmbYear.getSelectedItem()), </span><br><span class="line">							Integer.valueOf((String) jcmbMonth.getSelectedItem()), jcmbDay);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JFrame <span class="title">getJFrame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> jfrmMain;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">com.mec.studentInfo.util包里</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Util</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setJCheckboxsValue</span><span class="params">(JCheckBox[] jckbArray, <span class="keyword">boolean</span> value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (JCheckBox jckb : jckbArray) &#123;</span><br><span class="line">			jckb.setSelected(value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setJCheckboxsReserve</span><span class="params">(JCheckBox[] jckbArray)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (JCheckBox jckb : jckbArray) &#123;</span><br><span class="line">			jckb.setSelected(!jckb.isSelected());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setJComboboxMonth</span><span class="params">(JComboBox&lt;String&gt; jcmb)</span> </span>&#123;</span><br><span class="line">		jcmb.removeAllItems();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">12</span>; i++) &#123;</span><br><span class="line">			jcmb.addItem(String.valueOf(<span class="number">100</span> + i).substring(<span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setJComboboxYear</span><span class="params">(<span class="keyword">int</span> minAge, <span class="keyword">int</span> maxAge, <span class="keyword">int</span> defAge, JComboBox&lt;String&gt; jcmb)</span> </span>&#123;</span><br><span class="line">		jcmb.removeAllItems();</span><br><span class="line">		<span class="keyword">int</span> year = Calendar.getInstance().get(Calendar.YEAR);</span><br><span class="line">		<span class="keyword">int</span> smallYear = year - maxAge;</span><br><span class="line">		<span class="keyword">int</span> bigYear = year - minAge;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = smallYear; i &lt;= bigYear; i++) &#123;</span><br><span class="line">			jcmb.addItem(String.valueOf(i));</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//		jcmb.setSelectedItem(String.valueOf(defYear));</span></span><br><span class="line">		jcmb.setSelectedIndex(maxAge - defAge);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setJComboboxDay</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month, JComboBox&lt;String&gt;jcmb)</span> </span>&#123;</span><br><span class="line">		jcmb.removeAllItems();</span><br><span class="line">		Calendar theday = Calendar.getInstance();</span><br><span class="line">		theday.set(year, month, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">int</span> maxDate = theday.getActualMaximum(Calendar.DAY_OF_MONTH);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= maxDate; i++) &#123;</span><br><span class="line">			jcmb.addItem(String.valueOf(<span class="number">100</span> + i).substring(<span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		jcmb.setSelectedIndex(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">主函数</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		StudentInfoView siv = <span class="keyword">new</span> StudentInfoView();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			siv.showView();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (FrameIsNull e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



  <img src="/img/Swing/1.png" alt="1" style="zoom:100%;" /> 

<p>  上述都某些按钮（日期选取自动变化）的响应还是可以的，这个例子主要是为了练习控件类和布局方式，对于面向事件编程，因为这个例子不足够多，所以仅仅完成少部分按钮响应，以后拿出响应去真正的说。</p>
<p>  上述用到了<code>MVC</code>思想，具体的操作和对象model类分开，模型、界面、控制分开操作，各论各的，解耦。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/09/13/20200913@swing/" data-id="ckf2hi5jt000638i2hymh87wp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-20200911@接口@排序" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/11/20200911@%E6%8E%A5%E5%8F%A3@%E6%8E%92%E5%BA%8F/" class="article-date">
  <time datetime="2020-09-11T13:52:53.046Z" itemprop="datePublished">2020-09-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/20200911@%E6%8E%A5%E5%8F%A3@%E6%8E%92%E5%BA%8F/">20200911@接口@排序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="接口功能与特点"><a href="#接口功能与特点" class="headerlink" title="接口功能与特点"></a>接口功能与特点</h1><h2 id="类型的统一与保护"><a href="#类型的统一与保护" class="headerlink" title="类型的统一与保护"></a>类型的统一与保护</h2><p>​        我们在编程的时候，会不断的创建出许多类，类的本质就是类型，随着类得种类越来越多，数据类型也变得越来越多。假如我们有个需求，需要统一管理某些类，我们很容易就能想到使用<code>HashMap</code>，处理键值对的好帮手。在没有接口的情况下，我们可以使用万物的基类<code>Object</code>。<code>HashMap&lt;String, Object&gt;</code>，但是，问题也出在<code>Object</code>上，正是因为它的包容性，任何其他类类型的对象也可以存储到这个Map里，对这个Map进行捣乱。</p>
<p>​        上述问题本质是因为“<strong>类型保护的缺失</strong>“而造成的。现在可以用接口很轻松的解决这个问题。定义一个接口，里面可以什么都不做。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMyType</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        在让你需要归为一类的类实现这个接口，它们就可以用这个接口进行统一了。<code>HashMap&lt;String, IMyType&gt;</code>，之后对于Map的操作，满足实现接口<code>IMyType</code>的类的对象才可以进入Map进行操作。</p>
<p><strong>是的，一个空空如也的接口作用都有这么大的作用！！！</strong></p>
<p>​        但是，有一个问题，只能对自己定义的类进行操作，而对已有的类，我们没有办法接触到源代码，不能更改就不启作用了。还是有办法的：新建一个类，继承这个内部工具类，实现所有的构造方法，并让这个类实现<code>IMyType</code>接口，以后用这个新类替代原来的内部工具类。但是对于一些<code>final</code>修饰的类（<strong><code>String</code></strong>）就没有办法了。</p>
<hr>
<h2 id="规范方法"><a href="#规范方法" class="headerlink" title="规范方法"></a>规范方法</h2><p>​        接口在使用中有一个强有力的规定：<strong>凡是实现了该接口的非抽象类，就必须实现这个接口所规定的所有抽象方法</strong>。正是因为这个规定十分严格，也就有了<strong>规范行为</strong>的意义。有如下规范。</p>
<pre><code>1. 接口的所有方法必须实现，一个都不能少
  2. 规范了方法的名称
                3. 规范了方法的参数个数以及类型
            4. 规范了方法的返回值</code></pre><p>​        但是，规范是规范，规定你必须这样做并不涉及方法的具体实现，这一点在swing编程的适配器（Adapter）有体现。</p>
<hr>
<h2 id="方法的公开"><a href="#方法的公开" class="headerlink" title="方法的公开"></a>方法的公开</h2><p>​        同样是规范的作用，只不过这次看的角度不同，从应用角度看。如果我们已知一个接口，那么当我们遇到它的实现类后，我们就可以肆无忌惮的去调用接口里的方法，因为这个类一定实现了的。</p>
<p>​        <strong>我们甚至不用关心这个类具体是什么，只要判定这个类的对象是接口的实例，就可以调用接口的方法。</strong></p>
<hr>
<h2 id="分离原则"><a href="#分离原则" class="headerlink" title="分离原则"></a><font color = red>分离原则</font></h2><p>​        假如我们有这么一种需求，对数据进行排序，而这些数据可能来源并不相同。有的可能来自键入，有的可能来自文件，有的可能来自网络，也可能来自数据库。</p>
<p>​        首先可以写我们已知的数据排序类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ArrayList&lt;Integer&gt; dataList;	<span class="comment">//仅仅先假设我们处理的都是int数据</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DataSort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">getDataList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> dataList;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataList</span><span class="params">(ArrayList&lt;Integer&gt; dataList)</span> </span>&#123;	<span class="comment">//如何set最初始的数据？</span></span><br><span class="line">		<span class="keyword">this</span>.dataList = dataList;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> temp;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dataList.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = i +<span class="number">1</span>; j &lt; dataList.size(); j++) &#123;</span><br><span class="line">				<span class="keyword">int</span> num1 = dataList.get(i);</span><br><span class="line">				<span class="keyword">int</span> num2 = dataList.get(j);</span><br><span class="line">				<span class="keyword">if</span> (num1 &gt; num2) &#123;</span><br><span class="line">					temp = num1;</span><br><span class="line">					dataList.set(i, num2);</span><br><span class="line">					dataList.set(j, temp);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        可以先写由键入来的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataFromScanner</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DataFromScanner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">inputData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Scanner sc = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		ArrayList&lt;Integer&gt; dataSource = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">int</span> num;</span><br><span class="line">		<span class="keyword">while</span> (sc.hasNextInt()) &#123;</span><br><span class="line">			num = sc.nextInt();</span><br><span class="line">			dataSource.add(num);</span><br><span class="line">		&#125;</span><br><span class="line">		sc.close();</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		DataSort ds = <span class="keyword">new</span> DataSort();</span><br><span class="line">		DataFromScanner dfs = <span class="keyword">new</span> DataFromScanner();</span><br><span class="line">		ds.setDataList(dfs.inputData());</span><br><span class="line">		ds.sort();</span><br><span class="line">		ArrayList&lt;Integer&gt; result = ds.getDataList();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; result.size(); i++) &#123;</span><br><span class="line">			System.out.print((i == <span class="number">0</span> ? <span class="string">""</span> : <span class="string">", "</span>) + result.get(i));		</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        经过实验可以正常排序。但是，如果来自其他的输入源怎么办？再写个DataFromNet，DataFromFile吗？</p>
<blockquote>
<p><font color= red><strong>Java面向对象思想终极目标是代码复用</strong></font></p>
</blockquote>
<p>​        我们回过头再来考虑这件事，数据输入和数据排序的关系是什么呢？数据输入属于数据排序吗？其实，数据输入是数据排序必不可少的一项工作，因此应该把数据输入看作数据排序的一个成员。还是上面那个问题，是选择<code>DataFromScanner</code>作为成员呢？还是<code>DataFromNet</code>,还是<code>DataFromFile</code>?答案是都不是，但是需要它们全部，这又体现出接口的第一个功能了，统一起来用一个类型，<strong>接口类型</strong>！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">ArrayList&lt;Integer&gt; <span class="title">inputData</span><span class="params">()</span></span>;			<span class="comment">//方法规定好是数据输入，至于你怎么输入我只规定，后来去实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ArrayList&lt;Integer&gt; dataList;</span><br><span class="line">	<span class="keyword">private</span> IDataSource dataSource;		<span class="comment">//数据输入作为数据排序的成员，且是接口类型，就可以从多个源获取数据了</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DataSort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		dataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">getDataList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> dataList;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(IDataSource dataSource)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDataList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (dataSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.dataList = dataSource.inputData();	<span class="comment">//因为相关实现接口的的类一定完成了这个方法，一定能得到想要的dataList</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		setDataList();<span class="comment">//只要你把输入源头定好了，下一步可直接排序，因为输入数据是排序的一部分步骤</span></span><br><span class="line">		<span class="keyword">int</span> temp;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dataList.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = i +<span class="number">1</span>; j &lt; dataList.size(); j++) &#123;</span><br><span class="line">				<span class="keyword">int</span> num1 = dataList.get(i);</span><br><span class="line">				<span class="keyword">int</span> num2 = dataList.get(j);</span><br><span class="line">				<span class="keyword">if</span> (num1 &gt; num2) &#123;</span><br><span class="line">					temp = num1;</span><br><span class="line">					dataList.set(i, num2);</span><br><span class="line">					dataList.set(j, temp);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dataList.size(); i++) &#123;</span><br><span class="line">			System.out.print((i == <span class="number">0</span> ? <span class="string">""</span> : <span class="string">", "</span>) + dataList.get(i));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		DataSort ds = <span class="keyword">new</span> DataSort();</span><br><span class="line">		ds.setDataSource(<span class="keyword">new</span> DataFromScanner());  <span class="comment">//对于不同的数据源头只用改这里</span></span><br><span class="line">		ds.sort();</span><br><span class="line">		System.out.println(<span class="string">"排序后:"</span>);</span><br><span class="line">		ds.showList();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/img/Interface/1.png" alt="1" style="zoom:100%;" />



<hr>
<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><h2 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h2><p>​        外循环是排序需要的趟数，n个数，只需n-1趟，最后只剩一位就在该在的位置。</p>
<p>​        内循环是一趟相邻两数的比较，按需要的顺序写比较规则，要注意的是，因为每过一趟就有一个数排好了（一个泡泡到边边了），因此在减去躺次数。</p>
<p>​        平均时间复杂度：O（n^2）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>&#125;;	</span><br><span class="line">		<span class="keyword">int</span>[] sortArr = bubbleSort(arr);</span><br><span class="line">		System.out.println(Arrays.toString(sortArr));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] bubbleSort(<span class="keyword">int</span>[] array) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; array.length - <span class="number">1</span> - i; j++) &#123;</span><br><span class="line">				<span class="keyword">if</span> (array[j] &gt; array[j + <span class="number">1</span>]) &#123;</span><br><span class="line">					temp = array[j];</span><br><span class="line">					array[j] = array[j + <span class="number">1</span>];</span><br><span class="line">					array[j + <span class="number">1</span>] = temp;</span><br><span class="line">					flag = <span class="keyword">true</span>;</span><br><span class="line">				&#125;			</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (flag == <span class="keyword">false</span>) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> array;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        优化内容：外循环加个boolean值标志旗子，如果没有发生交换了说明都排好了，直接把外循环跳出，如果经过比较了，又要把旗子置回原位了。</p>
<hr>
<h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><p>​        快速排序其实就是每一轮处理将这一轮的基准数归位，直到所有数归位，排序就结束了。因为每次交换是跳跃式的，每次排序的时候设置一个基准点，将小于基准点的数全部放到基准数的左边，将大于基准数的数全部放到基准数的右边。这样不会像冒泡排序每次都只能在相邻的数交换，交换的距离变大，因此总的比较和交换次数就变得少了。但在最坏的情况下依然是相邻的两个数交换。</p>
<p>​        平均时间复杂度：O(NlogN)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuickSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span>[] array = &#123;<span class="number">6</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">8</span>&#125;;</span><br><span class="line">		quickSort(array, <span class="number">0</span>, array.length - <span class="number">1</span>);</span><br><span class="line">		System.out.println(Arrays.toString(array));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (left &gt; right) &#123;				<span class="comment">//对于函数有递归，一定要记得有退出递归的方法</span></span><br><span class="line">			<span class="keyword">return</span>;							<span class="comment">//如果左边索引比右边索引大，是不合法的，要退出</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> base = array[left];		<span class="comment">//保存基准数</span></span><br><span class="line">		<span class="keyword">int</span> i = left;						</span><br><span class="line">		<span class="keyword">int</span> j = right;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (i != j) &#123;				<span class="comment">//当i和j不相遇的时候，在循环中检索</span></span><br><span class="line">			<span class="keyword">while</span> (array[j] &gt;= base &amp;&amp; i &lt; j) &#123;	<span class="comment">//j从右往左检索，当发现小于基准数的停下，意味着大于等于基准数继续走</span></span><br><span class="line">				j--;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">while</span> (array[i] &lt;= base &amp;&amp; i &lt; j) &#123;	<span class="comment">//i从左往右检索，当发现大于基准数的停下，意味着小于等于基准数继续走</span></span><br><span class="line">				i++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//代码走到这，i和j都停下了，然后我们就需要交换。</span></span><br><span class="line">			<span class="keyword">int</span> temp = array[i];</span><br><span class="line">			array[i] = array[j];</span><br><span class="line">			array[j] = temp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//如果上面while循环条件不成立，说明i和j相遇了，把基准数和相遇位置元素进行交换。</span></span><br><span class="line">		array[left] = array[i];</span><br><span class="line">		array[j] = base;</span><br><span class="line">		<span class="comment">//基准数现在就排到正确的位置了，左边的数都比他小，右边都比他大。接下来就是递归快速排序左边和右边。</span></span><br><span class="line">		quickSort(array, left, i - <span class="number">1</span>);</span><br><span class="line">		quickSort(array, j + <span class="number">1</span>, right);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        优化内容：对于数组非常小，其实快速排序不如直接插入排序性能好（直接插入是简单排序中性能最好的）。因此可以设置一个阈值，当低于这个阈值，就用直接插入排序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_LENGTH_INSERT_SORT = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (right - left &gt; MAX_LENGTH_INSERT_SORT) &#123;</span><br><span class="line">		<span class="comment">//快排</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//直接插入排序</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2><p>​        该算法采用经典的<strong><font color= red>分治</font></strong>策略，<font color=red><strong>分</strong></font>：将大的问题分成一些小的问题然后再递归求解。<font color=red><strong>治</strong></font>：将分的阶段得到的各答案“修补“在一起。</p>
<img src="/img/Interface/2.png" alt="1" style="zoom:100%;" />

<img src="/img/Interface/3.png" alt="1" style="zoom:100%;" />

<img src="/img/Interface/4.png" alt="1" style="zoom:100%;" />


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span>[] array = &#123;<span class="number">1</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>&#125;;</span><br><span class="line">		<span class="keyword">int</span>[] temp = <span class="keyword">new</span> <span class="keyword">int</span>[array.length];</span><br><span class="line">		mergeSort(array, <span class="number">0</span>, array.length - <span class="number">1</span>, temp);</span><br><span class="line">		System.out.println(Arrays.toString(array));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//分+合方法</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(<span class="keyword">int</span>[] arr, <span class="keyword">int</span> left,<span class="keyword">int</span> right, <span class="keyword">int</span>[] temp)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (left &lt; right) &#123;</span><br><span class="line">			<span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">			<span class="comment">//左递归进行分解</span></span><br><span class="line">			mergeSort(arr, left, mid, temp);</span><br><span class="line">			<span class="comment">//右递归分解</span></span><br><span class="line">			mergeSort(arr, mid + <span class="number">1</span>, right, temp);</span><br><span class="line">			<span class="comment">//每分解一次就要合并一次，对称的</span></span><br><span class="line">			merge(arr, left, mid, right, temp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 合并</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> arr		排序的原始数组</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> left		左边有序序列的初始索引</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mid	中间索引</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> right	右边索引</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> temp	做中转的数组</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] arr, <span class="keyword">int</span> left, <span class="keyword">int</span> mid, <span class="keyword">int</span> right, <span class="keyword">int</span>[] temp)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> i = left;	<span class="comment">//初始化i，左边有序序列的初始索引</span></span><br><span class="line">		<span class="keyword">int</span> j = mid + <span class="number">1</span>; <span class="comment">//初始化j，右边有序序列的初始索引</span></span><br><span class="line">		<span class="keyword">int</span> t = <span class="number">0</span>; <span class="comment">//	指向temp数组的当前索引</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1.先把左右两边的数据（有序的）按照规则填充到temp数组，直到左右两边的有序序列，有一边处理完毕为止</span></span><br><span class="line">		<span class="keyword">while</span> (i &lt;= mid &amp;&amp; j &lt;=right) &#123;</span><br><span class="line">			<span class="keyword">if</span> (arr[i] &lt;= arr[j]) &#123;	<span class="comment">//如果发现左边的当前元素小于等于右边的当前元素，将左边的当前元素copy到temp数组</span></span><br><span class="line">				temp[t++] = arr[i++];</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				temp[t++] = arr[j++];  <span class="comment">//反之将右边当前元素copy进去</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.把有剩余数据的一边的数据以此全部填充到temp去</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (i &lt;= mid) &#123; <span class="comment">//说明左边有序序列还有剩余的元素，就全部填充过去</span></span><br><span class="line">			temp[t++] = arr[i++];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (j &lt;= right) &#123;</span><br><span class="line">			temp[t++] = arr[j++];</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3.将temp数组元素拷贝到array </span></span><br><span class="line">		<span class="comment">//temp长度和原数组是一样的，没排好顺序之前，每次只用一部分不能全覆盖</span></span><br><span class="line">		t = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> tempLeft = left;</span><br><span class="line">		<span class="keyword">while</span> (tempLeft &lt;= right) &#123;</span><br><span class="line">			arr[tempLeft++] = temp[t++];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/09/11/20200911@%E6%8E%A5%E5%8F%A3@%E6%8E%92%E5%BA%8F/" data-id="ckf2hi5js000538i2dtiz2pww" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-20200408@模拟简易Spring" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/08/20200408@%E6%A8%A1%E6%8B%9F%E7%AE%80%E6%98%93Spring/" class="article-date">
  <time datetime="2020-04-08T00:36:59.000Z" itemprop="datePublished">2020-04-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/08/20200408@%E6%A8%A1%E6%8B%9F%E7%AE%80%E6%98%93Spring/">20200408@模拟简易Spring</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>20200401、20200402</p>
<p>&emsp;&emsp;接下里的几篇博文里会模拟的实现简易的Spring，因此和真正的Spring有些不同，简易考虑的没真正的多，先不涉及相关介绍，当整个实现完了再去整体化理一遍。</p>
<p><font color= red>红色</font>：笔记重点。<font color= orange>橙色</font>：HR说。<font color= green>绿色</font>：去查找相关源代码。</p>
<p>为了解释Ioc（控制反转）和DI（依赖注入）给下面例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//OneClass类//</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> TwoClass two;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OneClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(two);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//TwoClass类//</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TwoClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"这是TwoClass的对象"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//测试</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		OneClass oneClass = <span class="keyword">new</span> OneClass();</span><br><span class="line">		oneClass.doSomething();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p>上面运行结果是我们很容易想到的，因为OneClass没有对成员two进行赋值操作，输出当然为null了。如果有一个工具，可以悄悄地，自动的对OneClass的成员进行初始化（注入），那么运行就可以有结果了。</p>
<p><code>依赖注入</code>：相关类的成员不是通过代码（new）完成的，而是靠一套工具来完成的，所以是依赖于工具注入。</p>
<p><code>控制反转</code>：本来应该是OneClass类对成员two进行控制，而现在是通过外面工具进行控制的，控制权从OneClass变为了工具。</p>
<p>Spring就是这个工具。下来就来完成简易的Spring。</p>
<hr>
<h2 id="四个注解"><a href="#四个注解" class="headerlink" title="四个注解"></a>四个注解</h2><h3 id="Component注解"><a href="#Component注解" class="headerlink" title="@Component注解"></a>@Component注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.TYPE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.RetentionPolicy.RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">singleton</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Component</code>注解：在类型上面使用的，说明该类型要加到IoC容器里面去，是该容器的一个组件。</p>
<h3 id="Autowired注解"><a href="#Autowired注解" class="headerlink" title="@Autowired注解"></a>@Autowired注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.FIELD;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.METHOD;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.RetentionPolicy.RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123; FIELD, METHOD &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Autowired</code>注解：该注解用于成员或成员设置方法的上面，其目的是对成员进行注入，这个成员的对象是从IoC容器中取出来。因此就要求被<code>@Autowired</code>注解标识的成员其类型必须有<code>@Component</code>注解。</p>
<h3 id="Bean注解"><a href="#Bean注解" class="headerlink" title="@Bean注解"></a>@Bean注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.METHOD;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.RetentionPolicy.RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Bean &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Bean</code>注解：这个注解用在方法上面，其用途随后再说。</p>
<p>@Configuration注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.TYPE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.RetentionPolicy.RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合Bean注解使用的，以后再谈。</p>
<hr>
<h2 id="模拟Spring的主要类"><a href="#模拟Spring的主要类" class="headerlink" title="模拟Spring的主要类"></a>模拟Spring的主要类</h2><h3 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanDefinition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> inject;</span><br><span class="line">	</span><br><span class="line">	BeanDefinition() &#123;</span><br><span class="line">		<span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	BeanDefinition(Class&lt;?&gt; klass, Object object) &#123;</span><br><span class="line">		<span class="keyword">this</span>.klass = klass;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">		<span class="keyword">this</span>.inject = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; getKlass() &#123;</span><br><span class="line">		<span class="keyword">return</span> klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setKlass</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.klass = klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isInject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> inject;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setInject</span><span class="params">(<span class="keyword">boolean</span> inject)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.inject = inject;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该类主要描述一个类，将其类型和对象本身封装起来。</p>
<hr>
<h3 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h3><p>前面说了那么久的IoC容器就是这里面的beanPool，其键为类名称，值为一个BeanDefinition的对象。</p>
<p>另外，我们不对八大基本类型和String类型进行注入，其实可以有解决方法就是在<code>@Autowired</code>里加value。</p>
<p>还有，我们这个类需要用到以前写过的包扫描工具。</p>
<hr>
<h2 id="关于注入的时机"><a href="#关于注入的时机" class="headerlink" title="关于注入的时机"></a>关于注入的时机</h2><p>&emsp;<font color= red><strong>在没有完全扫描所有需要的包以前，是没有办法确定依赖关系的完整性的，所以不能进行注入工作。所以注入工作应该在得到相关Bean的时候。这可以称为<em>懒汉模式</em>。懒：扫描完包，相关类的成员还没注入，等你要得到这个类的时候再去注入。饿：一扫描完，就立刻去进行注入。</strong></font></p>
<p>&emsp;同时不可以重复注入，第二次getBean()如果不加判断就会重复注入，重复注入根本没有必要，解决方法是在BeanDefinition中加是否注入(inject)了标识。</p>
<hr>
<h2 id="关于单例和多例"><a href="#关于单例和多例" class="headerlink" title="关于单例和多例"></a>关于单例和多例</h2><p>&emsp;&emsp;<code>单例模式</code>：单例模式的对象在整个系统中只有一份。使用场景：没必要对每一个请求都实例化对象，会<strong>浪费CPU和内存</strong>。</p>
<p>&emsp;&emsp;<code>多例模式</code>：多例模式的对象可以有很多个实例。使用场景：是为了防止<strong>并发</strong>问题，一个请求改变了该对象状态，此时该对象又处理另外一个请求，而之前请求对对象状态的改变导致了对象对另一个请求做了错误的处理。</p>
<p>&emsp;&emsp;使用单例和多例的判断标准只有一个：当该对象在应用中状态会改变，则用多例，否则用单例。</p>
<p>&emsp;&emsp;Spring里的IoC容器默认情况下管理的bean是单例的，即该bean只会创造一个对象，无论之后调用多少次该bean，都只会返回同一个对象。所以<code>@Component</code>注解加<code>singleton</code>，默认为true。</p>
<p>&emsp;&emsp;关于Spring里单例和多例对象的生命周期：bean在单例模式下，无论调用多少次getBean()获取该bean都是从IoC容器中获取该对象返回，一直是一个对象。此对象一直被IoC容器持有，直到容器退出时，随着容器的退出对象被销毁。</p>
<p>&emsp;&emsp;bean在多例模式下，每次使用 getBean()获取该bean时，IOC都会重新创建该对象返回，每次都是一个新的对象。这个对象IOC容器并不会持有，何时销毁取决于使用该对象的用户自己什么时候销毁该对象。</p>
<hr>
<h3 id="注入过程"><a href="#注入过程" class="headerlink" title="注入过程"></a>注入过程</h3><p>注入：给带有<code>@Autowired</code>注解的成员赋值。我们把它独立出来个方法做，需要什么参数呢？首先是给成员注入，那一定需要Class方便我们反射机制得到成员，其次对哪个对象的成员进行注入也需要给进来。过程：遍历整个从反射机制得到的Field，筛选有注解的成员，该成员的值是从beanPool中取得的，间接递归。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanPackage</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> PackageScanner() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealClass</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (klass.isPrimitive() || klass.isArray() || klass.isInterface() || klass == String<span class="class">.<span class="keyword">class</span> || <span class="title">klass</span>.<span class="title">isEnum</span>() || <span class="title">klass</span>.<span class="title">isAnnotation</span>()</span></span><br><span class="line"><span class="class">						|| !<span class="title">klass</span>.<span class="title">isAnnotationPresent</span>(<span class="title">Component</span>.<span class="title">class</span>) ) </span>&#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Component component = klass.getAnnotation(Component<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">					<span class="keyword">boolean</span> singleton = component.singleton();</span><br><span class="line">					<span class="keyword">if</span> (singleton == <span class="keyword">false</span>) &#123;</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					Object object = klass.getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;).newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">					BeanDefinition beanDefinition = <span class="keyword">new</span> BeanDefinition(klass, object);</span><br><span class="line">					beanPool.put(klass.getName(), beanDefinition);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.scanPackage(packageName);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		Component component = klass.getAnnotation(Component<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">boolean</span> singleton = component.singleton();</span><br><span class="line">		<span class="keyword">if</span> (singleton == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> (T) dealNotSingleton(klass);</span><br><span class="line">		&#125;</span><br><span class="line">		String className = klass.getName();</span><br><span class="line">		BeanDefinition beanDefinition = beanPool.get(className);</span><br><span class="line">		<span class="keyword">if</span> (beanDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(className + <span class="string">"不存在"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!beanDefinition.isInject()) &#123;</span><br><span class="line">			inject(klass, beanDefinition.getObject());</span><br><span class="line">			beanDefinition.setInject(<span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (T) beanDefinition.getObject();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">dealNotSingleton</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Object object = klass.getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;).newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">			inject(klass, object);</span><br><span class="line">			<span class="keyword">return</span> object;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Class&lt;?&gt; klass, Object object)</span> </span>&#123;</span><br><span class="line">		Field[] fields = klass.getDeclaredFields();</span><br><span class="line">		<span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!field.isAnnotationPresent(Autowired<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Class&lt;?&gt; fieldClass = field.getType();</span><br><span class="line">			Object value = getBean(fieldClass);</span><br><span class="line">			field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				field.set(object, value);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;就这样，最初的BeanFactory出来了。但是注入过程有大坑，有个<em>循环依赖</em>的问题，这个问题我先放一放以后解决。</p>
<hr>
<h2 id="Autowired注解应该在方法上而不是成员上"><a href="#Autowired注解应该在方法上而不是成员上" class="headerlink" title="Autowired注解应该在方法上而不是成员上"></a>Autowired注解应该在方法上而不是成员上</h2><p>&emsp;&emsp;前面实现的代码我们可以看到，对于私有成员的注入，用到了<code>field.setAccessible(true)</code>，本来硬性规定的私有成员，现在就这样被别人权限大开了，是否违反我们<code>private</code>关键字的初衷呢？所以说<font color= orange>反射机制是个双刃剑，给我们带了了遍历，也带来了危害。</font>对于setAccessible()方法是否会破坏类的访问规则，产生安全隐患，我在知乎上面看到的一篇回答貌似很有道理：</p>
<img src="/img/NOTE/7.png" alt="7"  />

<p>&emsp;&emsp;所以我们尽量将Autowired注解设置在公开的setter方法上。话虽这样说，但Spring大部分还是用在成员上，因为是在工具内部完成的，<font color= orange>但还是要说清楚危害。</font></p>
<p>讲Autowired注解用在公开的setter方法上面，考虑setter方法的共性：1. 参数只有一个，且该参数类型是相关成员类型 2.无返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectBySetterMethod</span><span class="params">(Class&lt;?&gt; klass, Object object)</span> </span>&#123;</span><br><span class="line">		Method[] methods = klass.getDeclaredMethods();</span><br><span class="line">		<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!method.isAnnotationPresent(Autowired<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">					|| !method.getName().startsWith("set")</span><br><span class="line">					|| method.getParameterCount() != <span class="number">1</span></span><br><span class="line">					|| method.getModifiers() != Modifier.PUBLIC) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Class&lt;?&gt; paraClass = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">			Object value = getBean(paraClass);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				method.invoke(object, <span class="keyword">new</span> Object[] &#123;value&#125;);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">/*加在BeanFactory代码*/</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;在做实验的期间，发现个很有意思的知识。是关于权限修饰符的类<code>Modifier</code>。在输出各个修饰符的值，发现<code>public：1</code>，<code>private：2</code>，<code>protected：4</code>，发现它们都是属于2的次方，这不由得想到了二进制，在类<code>Modifier</code>发现果然是二进制。继续<font color= orange><strong>横向学习Linxu的chmod命令</strong></font>也是这样的。在做实验，发现<code>final：16</code>，经过 <code>public final</code>修饰的值为17，从中得知原来多个权限符共同修饰的计算是 |（或计算），那当然了，在计算机位运算一定比加法快，由此得知开发Java的前辈为了使用位运算在底层做了功夫。从中也得知了学习要横向学习。</p>
<p>&emsp;&emsp;我们的模拟Spring必须需要set方法是public的，<font color= green>那么真正的Spring里set方法是否可以不带public还能运行成功这个我们不得而知</font>，我们带着这个问题，以后去学习源代码！</p>
<hr>
<h2 id="Bean注解详细介绍"><a href="#Bean注解详细介绍" class="headerlink" title="Bean注解详细介绍"></a><font color= red>Bean注解详细介绍</font></h2><p>&emsp;&emsp;Bean注解的出现是为了解决Autowired注解的缺陷；我们知道Autowired只能获取池子中的对象，而池中对象所对应的类都应该有Component注解，对于不可更改的jar包中的类，我们没有办法增加Component注解，也就不能实现注入操作。Bean注解主要就是为了解决这一问题的！</p>
<h3 id="Bean注解的使用场合"><a href="#Bean注解的使用场合" class="headerlink" title="Bean注解的使用场合"></a><font color= red>Bean注解的使用场合</font></h3><p>&emsp;&emsp;场合一：对于无法加注解的jar包！Bean注解可以加到相关得到jar包对象的方法上，这样就可以将jar包的对象加到beanPool里了。</p>
<p>&emsp;&emsp;场合二：若相关类没有无参构造方法（Component注解调用的是无参构造），或者相关无参构造方法权限我们不够没办法调用，或者相关类的对象根本不是通过无参构造产生的（例如Calendar类，其通过Calendar.getInstance()得到相关对象）。此时，可以通过Bean注解，调用合适的获取该类对象的方法，取得这个类的对象，并加入到beanPool中。</p>
<p>&emsp;&emsp;场合三：对于类对象的构造用户想个性化，或者类的对象不是简简单单通过无参构造出来后就直接能使用的，还要对这个对象做一些事（数据库的Connection设置），都可以在Bean注解标注的方法中进行。</p>
<p>&emsp;&emsp;(<em>对于个性化下面图片解释</em>)</p>
<p><img src="/img/NOTE/8.png" alt="8"></p>
<p>&emsp;&emsp;我不希望我从beanPool取出来的的Complex都是（0.0，0.0）。我想对它进行设定，除此之外，我还可以在返回前做我想做的事。如何初始化的数值都由写这个方法的人决定了。使得初始化更加<font color= red><strong>灵活</strong></font>！</p>
<p>&emsp;&emsp;学了Bean注解可以把Spring用的更好。</p>
<h3 id="Bean注解的实现"><a href="#Bean注解的实现" class="headerlink" title="Bean注解的实现"></a>Bean注解的实现</h3><p>&emsp;&emsp;因为Bean注解是在方法上面的，方法有必须需要类的支持，所以给出Configuration类，并且强调要带上无参构造。为什么要带上无参构造呢？答：无参构造出来的对象我们根本不必需要，也不需要加在beanPool中，他是是为了方便内部使用！这个Configuration类加<code>Configuration</code>注解。</p>
<p>BeanFactory修改过多，因此再次给出全部内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanPackage</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> PackageScanner() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealClass</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (klass.isPrimitive() || klass.isArray() || klass.isInterface() || klass == String<span class="class">.<span class="keyword">class</span> || <span class="title">klass</span>.<span class="title">isEnum</span>() || <span class="title">klass</span>.<span class="title">isAnnotation</span>()</span></span><br><span class="line"><span class="class">						|| (!<span class="title">klass</span>.<span class="title">isAnnotationPresent</span>(<span class="title">Component</span>.<span class="title">class</span>) &amp;&amp; !<span class="title">klass</span>.<span class="title">isAnnotationPresent</span>(<span class="title">Configuration</span>.<span class="title">class</span>))) </span>&#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (klass.isAnnotationPresent(Configuration<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">						BeanFactory.dealConfiguration(klass);</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					Component component = klass.getAnnotation(Component<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">					<span class="keyword">boolean</span> singleton = component.singleton();</span><br><span class="line">					<span class="keyword">if</span> (singleton == <span class="keyword">false</span>) &#123;</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					Object object = klass.getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;).newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">					BeanDefinition beanDefinition = <span class="keyword">new</span> BeanDefinition(klass, object);</span><br><span class="line">					beanPool.put(klass.getName(), beanDefinition);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.scanPackage(packageName);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		Component component = klass.getAnnotation(Component<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">boolean</span> singleton = component == <span class="keyword">null</span> ? <span class="keyword">true</span> : component.singleton();</span><br><span class="line">		<span class="keyword">if</span> (singleton == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> (T) dealNotSingleton(klass);</span><br><span class="line">		&#125;</span><br><span class="line">		String className = klass.getName();</span><br><span class="line">		BeanDefinition beanDefinition = beanPool.get(className);</span><br><span class="line">		<span class="keyword">if</span> (beanDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(className + <span class="string">"不存在"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!beanDefinition.isInject()) &#123;</span><br><span class="line">			inject(klass, beanDefinition.getObject());</span><br><span class="line">			beanDefinition.setInject(<span class="keyword">true</span>); <span class="comment">//TODO 有错误</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (T) beanDefinition.getObject();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">dealNotSingleton</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Object object = klass.getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;).newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">			inject(klass, object);</span><br><span class="line">			<span class="keyword">return</span> object;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Class&lt;?&gt; klass, Object object)</span> </span>&#123;</span><br><span class="line">		injectByField(klass, object);</span><br><span class="line">		injectBySetterMethod(klass, object);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectByField</span><span class="params">(Class&lt;?&gt; klass, Object object)</span> </span>&#123;</span><br><span class="line">		Field[] fields = klass.getDeclaredFields();</span><br><span class="line">		<span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!field.isAnnotationPresent(Autowired<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Class&lt;?&gt; fieldClass = field.getType();</span><br><span class="line">			Object value = getBean(fieldClass);</span><br><span class="line">			field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				field.set(object, value);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectBySetterMethod</span><span class="params">(Class&lt;?&gt; klass, Object object)</span> </span>&#123;</span><br><span class="line">		Method[] methods = klass.getDeclaredMethods();</span><br><span class="line">		<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!method.isAnnotationPresent(Autowired<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">					|| !method.getName().startsWith("set")</span><br><span class="line">					|| method.getParameterCount() != <span class="number">1</span></span><br><span class="line">					|| method.getModifiers() != Modifier.PUBLIC) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Class&lt;?&gt; paraClass = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">			Object value = getBean(paraClass);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				method.invoke(object, <span class="keyword">new</span> Object[] &#123;value&#125;);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dealConfiguration</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Object configObject = klass.getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;).newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">			Method[] methods = klass.getMethods();</span><br><span class="line">			<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!method.isAnnotationPresent(Bean<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">int</span> paraCount = method.getParameterCount();</span><br><span class="line">				Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">				<span class="keyword">if</span> (paraCount != <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="comment">//TODO 相关方法有参数做法</span></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					Object result = method.invoke(configObject, <span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">					BeanDefinition beanDefinition = <span class="keyword">new</span> BeanDefinition(returnType, result);</span><br><span class="line">					beanPool.put(returnType.getName(), beanDefinition);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;经过实验我们发现，如果想要是多例的，要用<code>Component</code>注解，并且赋singleton值为false即可。其他所有都是单例的。那就意味着通过<code>Bean</code>注解方法反射执行也只能是单例的，但可以多例吗？当然是可以的，这个问题我们以后解决。</p>
<p>&emsp;&emsp;<font color= green>去拿Spring做实验，是否Autowired注解的成员的类是否可以没有Component注解。</font></p>
<hr>
<h2 id="XML配置和注解区别"><a href="#XML配置和注解区别" class="headerlink" title="XML配置和注解区别"></a>XML配置和注解区别</h2><p>&emsp;&emsp;首先说明通过XML文件配置完成的注解也可以完成，注解完成的，XML也可以完成。两者各有利弊，要编程者自己斟酌用哪个。</p>
<p><font color= orange>XML配置：</font></p>
<p>&emsp;&emsp;优点：相关配置文件是独立于代码的，不侵害和更改代码，不用改代码就不需要测试。保证了<em>开闭原则</em>(对修改关闭，对扩展开放)。</p>
<p>&emsp;&emsp;缺点：如果相关类的关系很复杂，其就需要大量配置文件的抒写。（早些年的配置文件很长，一度被人们称为<em>“配置地狱”</em>）</p>
<p><font color= orange>注解方式：</font></p>
<p>&emsp;&emsp;优点：简单，明了，方便，程序可读性强，无需多写相关配置文件，使得开发效率高。</p>
<p>&emsp;&emsp;缺点：对注解进行更改，就需要进行重新的全面的严格的测试，因为修改了内部代码，一经改动就需进行大量测试以得到更改的正确性。</p>
<p>&emsp;&emsp;总而言之，<em>条条大路通罗马，不拘一格降人才</em>，XML和注解都可以解决问题，我们先学一样，再去找他们的相通之处就能学习到更多知识。</p>
<hr>
<h2 id="循环依赖"><a href="#循环依赖" class="headerlink" title="循环依赖"></a><font color= red>循环依赖</font></h2><h3 id="第一种循环依赖（循环注入）"><a href="#第一种循环依赖（循环注入）" class="headerlink" title="第一种循环依赖（循环注入）"></a>第一种循环依赖（循环注入）</h3><p>给三个类说明这个情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*三个类*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> B b;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> B <span class="title">getB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> b;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.b = b;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"A类中的b成员:"</span> + b;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> C c;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">getC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> c;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setC</span><span class="params">(C c)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.c = c;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"B类中的c成员:"</span> + c ;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> A a;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> A <span class="title">getA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> a;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(A a)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.a = a;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"C类中的a成员:"</span> + a;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*测试*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		BeanFactory.scanPackage(<span class="string">"com.mec.mSpring"</span>);		</span><br><span class="line">		A a = BeanFactory.getBean(A<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		System.out.println(a);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*结果*/</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.StackOverflowError</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;从结果我们可以看见，<em>栈溢出</em>，该错误一般是由错误递归造成的。仔细跟踪代码发现A需要注入的时候，去beanPool中找B，发现B也要注入，去beanPool中找C，发现C也需要注入，又去beanPool中找A，这样就循环注入了，所以栈溢出。</p>
<img src="/img/NOTE/9.png" alt="9" style="zoom:80%;" />

<p>再接着跟踪代码，发现出递归代码出现的地方。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*以前注入时的做法*/</span></span><br><span class="line"><span class="keyword">if</span> (!beanDefinition.isInject()) &#123;</span><br><span class="line">	inject(klass, beanDefinition.getObject());</span><br><span class="line">	beanDefinition.setInject(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*改过之后*/</span></span><br><span class="line"><span class="keyword">if</span> (!beanDefinition.isInject()) &#123;</span><br><span class="line">	beanDefinition.setInject(<span class="keyword">true</span>);</span><br><span class="line">	inject(klass, beanDefinition.getObject());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;是的，错误就在设置是否注入这里，如果设置在后面，则会一直卡在这里，因为它等它，它等它成了死循环的等待。我们的解决方法时，只要它没注入准备注入，那么就先把它设置为已经注入了再去做注入操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*再次测试发现结果还是有错误*/</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.StackOverflowError</span><br><span class="line"><span class="comment">/*原来是我们的toString方法出现了递归调用*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*修改C类中的toString方法*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"C类中的a成员"</span> + (a == <span class="keyword">null</span> ? <span class="string">"为"</span> : <span class="string">"不为"</span>) + <span class="string">"null"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*结果*/</span></span><br><span class="line">A类中的b成员:B类中的c成员:C类中的a成员不为<span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;问题成功解决。但是<code>setInject(true)</code>放前面是有风险的，如果注入过程<code>inject()</code>失败，这不就成谎报军情了吗？我们这就规定注入过程一定不能有错误。只要注入算法写的十分好，就不会出现上述循环注入问题，<font color= green>去看Spring源代码的注入过程如何巧妙。</font></p>
<p>&emsp;&emsp;<font color= orange>之所以不称它为循环依赖而叫循环注入，是因为依赖是放进beanPool的过程，在扫描的时候不会出现错误，它已经放在beanPool里面去了，依赖关系是成功的，而这个错误是出现在注入过程的，所以我认为他应该叫循环注入。</font></p>
<h3 id="循环依赖-1"><a href="#循环依赖-1" class="headerlink" title="循环依赖"></a><font color= red>循环依赖</font></h3><p>接下来这个例子才是真正的循环依赖，遇到这种问题神仙程序员都解决不了，只能看用户的细心程度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*没有Component注解的First类*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">First</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Second second;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">First</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Second <span class="title">getSecond</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> second;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecond</span><span class="params">(Second second)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.second = second;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"First类中的second"</span> + second);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*没有Componenet注解*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Second</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> First first;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Second</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> First <span class="title">getFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> first;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(First first)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.first = first;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Second类中的second"</span> + first);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Config类里面加方法*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> First <span class="title">getFirst</span><span class="params">(Second second)</span> </span>&#123;</span><br><span class="line">		First first = <span class="keyword">new</span> First();</span><br><span class="line">		first.setSecond(second);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> first;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Second <span class="title">getSecond</span><span class="params">(First first)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Second second = <span class="keyword">new</span> Second();</span><br><span class="line">		second.setFirst(first);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> second;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;很明显First和Second类都没有Componenet注解，也就意味着它们不会被扫描到，也就不会通过扫描的时候加在beanPool中，他俩是通过Bean注解通过方法得到的。<code>getFirst()</code>有first资源但没有second资源，<code>getSecond()</code>有two资源但没有one资源。两边都不松手，造成卡在这里了，类似于操作系统的死锁。</p>
<img src="/img/NOTE/10.bmp" alt="10" style="zoom: 50%;" />

<p>&emsp;&emsp;这种问题我说过了，编程根本无法解决，只能依靠用户自己设置的细心，别无他法。<font color= red>但是，我们可以将循环依赖的的依赖关系给用户输出出来！给用户看，知道自己在哪出错，就可以去改。</font></p>
<p>&emsp;&emsp;<font color= green>去拿这个例子去试试Spring，看Spring关于循环依赖的结果或者是否有输出？</font></p>
<hr>
<h2 id="带参数方法的解决-最精彩的地方"><a href="#带参数方法的解决-最精彩的地方" class="headerlink" title="带参数方法的解决(最精彩的地方)"></a><font color= red>带参数方法的解决(最精彩的地方)</font></h2><p>&emsp;&emsp;前面我们实现了在Config类中带<code>Bean</code>注解但不带参数的方法，可是以后实际情况一定会遇到带参数的情况，且我们规定该参数类型一定是能在beanPool中找到的，也就意味着参数类一定是有<code>Component</code>注解的。八大基本类型我们不管，在方法里自己设置，没有实用性意义。只要我们完成了参数们的准备，该方法就可以执行了。可是问题是，相关参数那个包还没扫描到怎么办？那方法就执行不了了。不能苛求用户写相关方法的线性关系。（实验发现method是按字典顺序）</p>
<p>&emsp;&emsp;<font color= red>带参bean方法处理：如果该方法的参数可以满足，那就去执行。如果参数不满足，我们先把它存起来，以后等到beanPool中数据有所变更（有新加入的），我们再去看看这个方法是否可以执行。关键在于如何存储。</font></p>
<p>&emsp;&emsp;首先，我们是对这些要完成的带参数的方法进行讨论的，那么根据<em>面对对象思想</em>，我们这个方法也就可以形成一个类。MethodDefinition。其里面应该存储方法反射执行所需要的内容。成员有：执行方法的对象，方法本身，参数，重点还是参数该怎么办？要根据类型去beanPool中找相对应的参数值，参数值可能是随机（不知道第几次）满足的。</p>
<p>&emsp;&emsp;通过下面这个工具解决这样的问题。</p>
<p>首先，有带参数的方法method1(arg1, arg2, arg3)；method2(arg4, arg3)；method3(arg1, arg3, arg4)</p>
<p><img src="/img/NOTE/11.png" alt="11"></p>
<p>&emsp;&emsp;其中beanPool就是我们前面那个beanPool，不满足列表是一个<code>List&lt;MethodDefinition&gt;</code>，放了不满足条件的方法；满足条件列表也是个<code>List&lt;MethodDefinition&gt;</code>，满足条件的放到这里来。最重要的是后面那个Map，其键为参数类型，值为因为缺少该参数的MethodDefinition形成的一个List。</p>
<p>经过一段时间arg3和arg4参数所在的包扫描到了，被加在beanPool中了，那么就要做以下事情。</p>
<p><img src="/img/NOTE/12.png" alt="12"></p>
<p>&emsp;&emsp;会检测到arg3和arg4参数已经在beanPool中存在，那么就去把那个Map里的依赖关系都一删掉，我们MethodDefinition类里当然还要准备个类似参数满足倒计时，如果满足了，就把它从不满足列表换到满足列表里面，先不急执行，等到最后在执行。就这样如此往复，就会慢慢被清空，最后依赖关系Map里如果没有任何东西了，说明都刚刚好满足，如果里面还有东西就说明存在循环依赖了！</p>
<p><font color= red>&emsp;&emsp;接下里就阐述下引入这个工具的考量</font>：Q：为什么用一张表来保存参数和依赖参数的方法。A：是为了查找速度，没有这张表，你就要每次在不满足的List里面一个个找。该Map里面还有循环依赖的关系！给他的目的是为了降低时间复杂度，以前查方法再查找方法参数时间复杂度O(n^2)，现在只需要O(n*logn)。存在意义是避免浪费时间。不满足的列表用<code>LinkList</code>，因为中间出去比较多。满足列表用<code>ArrayList</code>，最后一下顺序执行。</p>
<p>&emsp;&emsp;把这个工具封装起来！</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/04/08/20200408@%E6%A8%A1%E6%8B%9F%E7%AE%80%E6%98%93Spring/" data-id="ckf2hi5jm000138i25g9nfy9o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-20200405@定时器@代理机制@包扫描" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/05/20200405@%E5%AE%9A%E6%97%B6%E5%99%A8@%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6@%E5%8C%85%E6%89%AB%E6%8F%8F/" class="article-date">
  <time datetime="2020-04-05T00:36:59.000Z" itemprop="datePublished">2020-04-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/05/20200405@%E5%AE%9A%E6%97%B6%E5%99%A8@%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6@%E5%8C%85%E6%89%AB%E6%8F%8F/">20200405@定时器@代理机制@包扫描</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>20200401、20200402</p>
<h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><p>&emsp;&emsp;在我们以后的应用场合，需要定时地完成一些操作，这个时间是要求精准的，因此今天我们做一个定时器工具——didadida。意思是钟表指针摆动的声音。完成的方法是使用线程，这个线程经过指定的时间“醒来”，并执行外部要求的操作。</p>
<p>首先给个简单的定时器实现SimpleDidaDida类</p>
<h3 id="SimpleDidaDida"><a href="#SimpleDidaDida" class="headerlink" title="SimpleDidaDida"></a>SimpleDidaDida</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleDidaDida</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_DELAY = <span class="number">1000</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> delay;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	<span class="keyword">private</span> Object lock;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleDidaDida</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(DEFAULT_DELAY);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleDidaDida</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.delay = delay;</span><br><span class="line">		lock = <span class="keyword">new</span> Object();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		goon = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					lock.wait(delay);</span><br><span class="line">					doing();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					stop();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<code>startUp()</code>方法和<code>stop()</code>方法是某一个线程运行的，<code>run()</code>方法中也要访问goon。因此加<code>volatile</code>关键字，拒绝内存优化。定时我们需要用<code>wait(long timeout)</code>方法实现的，参数里的时间，JVM会产生个时钟监视器，监视时间到了，执行notify去唤醒它。</p>
<p>&emsp;&emsp;这里可不可以用<code>sleep()</code>方法我们提出这样的疑问？所以下面我们区分下<code>wait()</code>与<code>sleep()</code>的区别。</p>
<ul>
<li>sleep()是Thread类的静态方法，wait()是Object的方法。</li>
<li>sleep()不释放同步锁,wait()释放同步锁，同步锁的作用为了线程安全，限制共享资源的使用。</li>
<li>sleep()可以用时间指定来使他自动醒过来,如果时间不到你只能调用interreput()来强行打断，而wait()可以用notify()直接唤起。</li>
</ul>
<p>简易的定时器就完成了，下来是测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoSimpleDidadida</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SimpleDidaDida didadida;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DemoSimpleDidadida</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		didadida = <span class="keyword">new</span> SimpleDidaDida(<span class="number">500</span>) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(System.currentTimeMillis());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fiveSeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		didadida.startUp();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		didadida.stop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> DemoSimpleDidadida().fiveSeconds();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1586250032500</span></span><br><span class="line"><span class="attr">1586250033000</span></span><br><span class="line"><span class="attr">1586250033500</span></span><br><span class="line"><span class="attr">1586250034001</span></span><br><span class="line"><span class="attr">1586250034501</span></span><br><span class="line"><span class="attr">1586250035001</span></span><br><span class="line"><span class="attr">1586250035502</span></span><br><span class="line"><span class="attr">1586250036002</span></span><br><span class="line"><span class="attr">1586250036503</span></span><br><span class="line"><span class="attr">1586250037003</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;可以看出还是挺精确的，是我们定的500ms，结果在人的误差接收范围(1ms)内。但是，其实考虑这样的问题，我们这个实验<code>doing()</code>要做的事紧紧是个输出当前时间，很简单运行就会很快。如果我们以后的使用场景绝对不是简简单单的输出那么简单，应该有大量要做的事的代码。因此，我们继续做实验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*在DemoSimpleDidadida类加一点代码运行时间*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DemoSimpleDidadida</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		didadida = <span class="keyword">new</span> SimpleDidaDida(<span class="number">500</span>) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(System.currentTimeMillis());</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">50</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1586251880481</span></span><br><span class="line"><span class="attr">1586251881032</span></span><br><span class="line"><span class="attr">1586251881584</span></span><br><span class="line"><span class="attr">1586251882134</span></span><br><span class="line"><span class="attr">1586251882685</span></span><br><span class="line"><span class="attr">1586251883237</span></span><br><span class="line"><span class="attr">1586251883789</span></span><br><span class="line"><span class="attr">1586251884340</span></span><br><span class="line"><span class="attr">1586251884891</span></span><br><span class="line"><span class="attr">1586251885441</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;可以看到，如果把代码运行时间也算进去，我们简单的定时器并没有做到精准定时。</p>
<p>&emsp;&emsp;解决方法：不要在定时线程去做<code>doing()</code>，因为做的事情也会消耗时间的，这个要做的事我们拿个线程去跑它！我们的定时器线程只干一件事，定时睡觉，定时起来，再启动个<font color= red><strong>线程</strong></font>去做要做的事。</p>
<h3 id="Didadida"><a href="#Didadida" class="headerlink" title="Didadida"></a>Didadida</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Didadida</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_DELAY = <span class="number">1000</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> delay;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	<span class="keyword">private</span> Object lock;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Didadida</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(DEFAULT_DELAY);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Didadida</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.delay = delay;</span><br><span class="line">		lock = <span class="keyword">new</span> Object();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		goon = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					lock.wait(delay);</span><br><span class="line">					<span class="keyword">new</span> InnerWoker();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					stop();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerWoker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		InnerWoker() &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>).start();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			doing();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;它与简单的计时器不一样的地方是，<code>doing()</code>方法是通过一个内部类启动的，也就是内部类实现这个线程，和我计时线程区别开来。每一次计时线程醒来，就去实例化一个对象，去启动要做的事。</p>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DidadidaImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Didadida didadida;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DidadidaImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		didadida = <span class="keyword">new</span> Didadida(<span class="number">500</span>) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doing</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">				System.out.println(System.currentTimeMillis());</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">50</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fiveSeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		didadida.startUp();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		didadida.stop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> DidadidaImpl().fiveSeconds();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实验结果</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1586253591533</span></span><br><span class="line"><span class="attr">1586253592034</span></span><br><span class="line"><span class="attr">1586253592534</span></span><br><span class="line"><span class="attr">1586253593034</span></span><br><span class="line"><span class="attr">1586253593534</span></span><br><span class="line"><span class="attr">1586253594034</span></span><br><span class="line"><span class="attr">1586253594534</span></span><br><span class="line"><span class="attr">1586253595035</span></span><br><span class="line"><span class="attr">1586253595535</span></span><br><span class="line"><span class="attr">1586253596035</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;可以看到，结果是基本准确的，我们设置的计时器500ms左右。</p>
<p>&emsp;&emsp;但是，经过仔细思考，又出现新的问题。假设有如下情况，计时器1达到约定好的时间醒来了，去做要完成的事<code>doing()</code>，然而这个要做的事还么完成，计时器2也醒来了也同样去做要完成的事<code>doing()</code>。这时就是线程安全问题了，两个线程都在操作同样一段代码。</p>
<p>&emsp;&emsp;对于这个问题，就可以分析出两个计时器的优缺点了。</p>
<p>SimpleDidaDida简单计时器做法：lock.wait(delay);doing();</p>
<ul>
<li>&emsp;优点：不会出现线程安全问题，因为它把<code>doing()</code>要做的事放在了<code>lock</code>锁里面，只有第一个执行完了，第二个才会执行。</li>
<li>&emsp;缺点：它会导致我们的计时器计时不精准，因为<code>doing()</code>要做的事也有可能要运行一段时间，运行时间会算在我们的计时时间里。</li>
</ul>
<p>Didadida计时器做法：lock.wait(delay);new InnerWoker();</p>
<ul>
<li>&emsp;优点：精准计时，是多长时间就是多长时间，设置的时间一到就必做要做的事。</li>
<li>&emsp;缺点：可能会造成线程安全问题。解决方法有就是作为使用计时器工具的用户一定要考虑所要做的doing()能不能在规定时间做完，使延时时间大于操作时间。</li>
</ul>
<p>&emsp;&emsp;结语：其实我们做的定时器还不是最完美的，因为看到总有1~2ms的误差，这个误差对于一般使用者的要求可以满足，但要用到严格的工程上呢？<font color= red><strong>差之毫厘，谬以千里</strong></font>啊！为了更精确的定时，我们可以使用线程池，这个以后再说。</p>
<h2 id="代理机制"><a href="#代理机制" class="headerlink" title="代理机制"></a>代理机制</h2><p>&emsp;&emsp;今天来整理代理机制。先简单讲下我在网上看到的代理机制，有一个目标类的对象，他不直接面对用户，而是在它的基础之上有另外一个对象，称为代理对象，用户用的是这个代理对象，真正的操作还是用的目标对象。接下来给例子讲下两种动态代理JDK和Cglib。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISomething</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(String arg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单的一个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetClass</span> <span class="keyword">implements</span> <span class="title">ISomething</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TargetClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"正在执行doSomething方法"</span>);</span><br><span class="line">		System.out.println(<span class="string">"["</span> + arg + <span class="string">"]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealSomething</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"正在执行dealSomething方法"</span>);</span><br><span class="line">		System.out.println(<span class="string">"&#123;"</span> + arg + <span class="string">"&#125;"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>一个简单的接口实现类，实现的方法操作是给参数加上“[]”。另外还给了个与接口无关的方法<code>dealSomething()</code>，其给参数加上“{}”。</p>
<h3 id="JDK代理"><a href="#JDK代理" class="headerlink" title="JDK代理"></a>JDK代理</h3><p>首先简单的使用练习</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt; klass = TargetClass<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		TargetClass target = <span class="keyword">new</span> TargetClass();</span><br><span class="line">		ISomething targetProxy = (ISomething) Proxy.newProxyInstance(klass.getClassLoader(), klass.getInterfaces(), <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"前置拦截"</span>);</span><br><span class="line">				Object result = method.invoke(target, args);</span><br><span class="line">				System.out.println(<span class="string">"后置拦截"</span>);</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		targetProxy.doSomething(<span class="string">"abc"</span>);</span><br><span class="line"><span class="comment">//		targetProxy.dealSomething("abc");  这句话出错</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">前置拦截</span></span><br><span class="line"><span class="attr">正在执行doSomething方法</span></span><br><span class="line"><span class="attr">[abc]</span></span><br><span class="line"><span class="attr">后置拦截</span></span><br></pre></td></tr></table></figure>

<p><code>target</code>是源对象，用JDK代理得到一个代理对象<code>targetProxy</code>，调用代理对象的方法执行的是源对象的方法。出错的那句话说接口没有这个方法，所以不能调用，这个问题后面有深入说明。</p>
<p>几乎每个要代理的对象都要做这些过程，因此我们有必要把它做成一个工具。</p>
<h4 id="JDKProxy"><a href="#JDKProxy" class="headerlink" title="JDKProxy"></a>JDKProxy</h4><p>当然，现在只是简单的，以后会充满。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKProxy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JDKProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(T target)</span> </span>&#123;</span><br><span class="line">		Class&lt;?&gt; klass = target.getClass();</span><br><span class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(klass.getClassLoader(), klass.getInterfaces(), <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"前置拦截"</span>);</span><br><span class="line">				Object result = method.invoke(target, args);</span><br><span class="line">				System.out.println(<span class="string">"后置拦截"</span>);</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试就很简单了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		TargetClass target = <span class="keyword">new</span> TargetClass();</span><br><span class="line">		ISomething proxy = JDKProxy.getProxy(target);</span><br><span class="line">		proxy.doSomething(<span class="string">"abc"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Cglib代理"><a href="#Cglib代理" class="headerlink" title="Cglib代理"></a>Cglib代理</h3><p>做这个之前我们需要cglib的包并且add to build path。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		TargetClass target = <span class="keyword">new</span> TargetClass();</span><br><span class="line">		Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">		enhancer.setSuperclass(TargetClass<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object object, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"前置拦截"</span>);</span><br><span class="line">				Object result = method.invoke(target, args);</span><br><span class="line">				System.out.println(<span class="string">"后置拦截"</span>);</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		TargetClass targetProxy = (TargetClass) enhancer.create();</span><br><span class="line">		targetProxy.doSomething(<span class="string">"abc"</span>);</span><br><span class="line">		targetProxy.dealSomething(<span class="string">"qwe"</span>);</span><br><span class="line">        System.out.println(targetProxy <span class="keyword">instanceof</span> TargetClass);<span class="comment">//true</span></span><br><span class="line">		System.out.println(targetProxy <span class="keyword">instanceof</span> ISomething);<span class="comment">//true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*可能会有警告，该警告是Java版本太高了，1.8不会警告*/</span></span><br><span class="line">前置拦截</span><br><span class="line">正在执行doSomething方法</span><br><span class="line">[abc]</span><br><span class="line">后置拦截</span><br><span class="line">前置拦截</span><br><span class="line">正在执行dealSomething方法</span><br><span class="line">&#123;qwe&#125;</span><br><span class="line">后置拦截</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;和前面介绍基本是一样的，区别是这种方式可以调用目标类特有的方法<code>dealSomething()</code>(后面解释)，且加上了前置拦截和后置拦截。</p>
<h4 id="CglibProxy"><a href="#CglibProxy" class="headerlink" title="CglibProxy"></a>CglibProxy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibProxy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CglibProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(T target)</span> </span>&#123;</span><br><span class="line">		Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">		enhancer.setSuperclass(target.getClass());</span><br><span class="line">		enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object object, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"前置拦截"</span>);</span><br><span class="line">				Object result = method.invoke(target, args);</span><br><span class="line">				System.out.println(<span class="string">"后置拦截"</span>);</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">return</span> (T) enhancer.create();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;为什么可以Cglib可以调用特有的方法呢，而JDK不行呢？去做实验，Cglib产生的代理对象targetProxy instanceof TargetClass结果是为true的，targetProxy instanceof ISomething结果还是true。JDK产生的代理对象proxy instanceof TargetClass结果为false的，而proxy instanceof ISomething结果为true。</p>
<p>&emsp;&emsp;可以这样理解：JDK产生的代理对象和目标对象好像一个兄弟关系，共同的父亲是那个接口。Cglib产生的代理对象和目标对象是个父子关系，父为目标对象的类。</p>
<p>JDK代理模式：</p>
<ul>
<li>被代理的类，必须有接口。</li>
<li>产生的代理对象，其类型是接口类型的派生类类型。</li>
<li>代理对象只能调用接口方法。</li>
</ul>
<p>Cglib代理模式：</p>
<ul>
<li>被代理的类，不必须实现接口。</li>
<li>由于CGLib代理的原理是，创建一个被代理类的子类对象，因此，如果被代理的类存在不能被继承的方法，则，这个代理类对象当然就无法调用！即，被代理类中的final方法是不能被代理的；当然，若被代理类本身是final类，则，不能被代理！</li>
<li>代理对象可以只可以调用public修饰的。</li>
</ul>
<h2 id="包扫描"><a href="#包扫描" class="headerlink" title="包扫描"></a>包扫描</h2><p>&emsp;&emsp;包扫描工具目的是为了给一个包名字，能把这个包下的所有类都过一遍，方便以后我们结合注解进行编程。</p>
<h3 id="PackageScanner"><a href="#PackageScanner" class="headerlink" title="PackageScanner"></a>PackageScanner</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PackageScanner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanPackage</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">		String pathName = packageName.replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</span><br><span class="line">		ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Enumeration&lt;URL&gt; urls = classLoader.getResources(pathName);</span><br><span class="line">			<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">				URL url = urls.nextElement();</span><br><span class="line">				<span class="keyword">if</span> (url.getProtocol().equals(<span class="string">"jar"</span>)) &#123;</span><br><span class="line">					dealJar(url);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						File curFile = <span class="keyword">new</span> File(url.toURI());</span><br><span class="line">						dealPackage(curFile, packageName);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealClass</span><span class="params">(Class&lt;?&gt; klass)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dealJar</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			JarURLConnection connection = (JarURLConnection) url.openConnection();</span><br><span class="line">			JarFile jarFile = connection.getJarFile();</span><br><span class="line">			Enumeration&lt;JarEntry&gt; entryList = jarFile.entries();</span><br><span class="line">			<span class="keyword">while</span> (entryList.hasMoreElements()) &#123;</span><br><span class="line">				JarEntry jarEntry = entryList.nextElement();</span><br><span class="line">				String name = jarEntry.getName();</span><br><span class="line">				<span class="keyword">if</span> (jarEntry.isDirectory() || !name.endsWith(<span class="string">".class"</span>)) &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				name = name.replace(<span class="string">".class"</span>, <span class="string">""</span>);</span><br><span class="line">				String className = name.replace(<span class="string">'/'</span>, <span class="string">'.'</span>);</span><br><span class="line">				Class&lt;?&gt; klass = Class.forName(className);</span><br><span class="line">				dealClass(klass);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dealPackage</span><span class="params">(File curFile, String packageName)</span> </span>&#123;</span><br><span class="line">		File[] files = curFile.listFiles();</span><br><span class="line">		<span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">			<span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">				String fileName = file.getName();</span><br><span class="line">				<span class="keyword">if</span> (!fileName.endsWith(<span class="string">".class"</span>)) &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				fileName = fileName.replace(<span class="string">".class"</span>, <span class="string">""</span>);</span><br><span class="line">				String className = packageName + <span class="string">"."</span> + fileName;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Class&lt;?&gt; klass = Class.forName(className);</span><br><span class="line">					dealClass(klass);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">				dealPackage(file, packageName + <span class="string">"."</span> + file.getName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;需要注意的是：扫描自己的jar包可能扫描不出类很有可能是这个问题。</p>
<img src="/img/NOTE/6.png" alt="6" style="zoom: 80%;" />

<p>记得导出我们自己的包时，要将Add directory entries这一项勾上，否则扫描不到。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/04/05/20200405@%E5%AE%9A%E6%97%B6%E5%99%A8@%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6@%E5%8C%85%E6%89%AB%E6%8F%8F/" data-id="ckf2hi5jo000238i20n8z1qs6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-20200403@淘汰策略@BS@底层通信信息@文件操作@Communication初步" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/20200403@%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5@BS@%E5%BA%95%E5%B1%82%E9%80%9A%E4%BF%A1%E4%BF%A1%E6%81%AF@%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C@Communication%E5%88%9D%E6%AD%A5/" class="article-date">
  <time datetime="2020-04-03T00:36:59.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/20200403@%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5@BS@%E5%BA%95%E5%B1%82%E9%80%9A%E4%BF%A1%E4%BF%A1%E6%81%AF@%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C@Communication%E5%88%9D%E6%AD%A5/">20200403@淘汰策略@BS@底层通信信息@文件操作@Communication初步</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>video:20200330、20200331</p>
<h2 id="淘汰策略"><a href="#淘汰策略" class="headerlink" title="淘汰策略"></a>淘汰策略</h2><p>&emsp;&emsp;重做CSFramework，采用短连接。以前的Communication类的模式是否还能用？发现不行，Server和Client最底层都是这个Communication。在短连接模式下，实质上，客户端完全可以持有一个线程，该线程持续侦听服务器消息；而服务器不再针对每一个客户端维持一个线程。由Socket创建的DataInputStream和DataOutputStream都是需要占用内存空间的。</p>
<p>&emsp;&emsp;上节提到过服务器应该将“客户端网络连接”存储到一个池子中，并进行轮询。若池子已经满了，再来个新的连接，该怎么办？那肯定要淘汰以前老的连接。关于淘汰哪个就有了如下淘汰机制。</p>
<p>&emsp;&emsp;提到淘汰策略我就联想到了到了操作系统课讲的页面置换算法，两个基本思想是一样的。</p>
<h3 id="方案一FIFO（先进先出）"><a href="#方案一FIFO（先进先出）" class="headerlink" title="方案一FIFO（先进先出）"></a>方案一FIFO（先进先出）</h3><p>&emsp;&emsp;顾名思义就是断开池子里最早的连接，以便于新的连接加入。其优点在于实现起来十分方便，但是缺点是可能有这样的情况，最老的连接是和我一直保持说话，也就是活跃度很高的连接，淘汰它当然不应该。</p>
<h3 id="方案二LRU（最近最久未使用）"><a href="#方案二LRU（最近最久未使用）" class="headerlink" title="方案二LRU（最近最久未使用）"></a>方案二LRU（最近最久未使用）</h3><p>&emsp;&emsp;其提出的依据是：长时间没搭理我，那么较近的一段时间内，它和我在说话的概率会很低。其做法是在每一个连接中，增加一个计数器。</p>
<ul>
<li>做法一：某个连接的某一次请求，给该计数器增1；当池子满时，淘汰计数器值最小的那个连接。可能问题：若连接1有100个请求然后过了好久没发请求但它计数器高啊；连接100也是刚来的，虽然只发了一次请求但保不准还要发，现在连接101来了，就把无辜的100踢了，1这种没踢，很明显不应该这样。</li>
<li>做法二：某个连接的某次请求，给除了这个连接的其他连接计数器+1，淘汰最大的数值可以避免上面踢错人情况。但缺点在于操作次数频繁，给其他每个连接计数器+1（每一个连接就是一个o（100）操作），性能稍微弱一点，但淘汰准确。其实淘汰还是不一定准确，因为有积累数据。</li>
</ul>
<h3 id="方案三综合考虑"><a href="#方案三综合考虑" class="headerlink" title="方案三综合考虑"></a>方案三综合考虑</h3><p>&emsp;&emsp;在每一个连接中增加活跃度，发送请求活跃度+1，给别的连接活跃度-1。最后淘汰活跃度最低的。这个想法是好的可以操作花费时间会很多。</p>
<h2 id="底层通信信息"><a href="#底层通信信息" class="headerlink" title="底层通信信息"></a>底层通信信息</h2><p>&emsp;&emsp;连接要进行数据交互的，单纯的数据交互不受上层这些算法（淘汰策略）的影响。现在只讨论两个通信对端的信息传递，这个操作是最底层的，且双方是相同的。客户端向服务器发送请求，和服务器对请求进行响应。之后通信信道断开还是连接，还是连接池子该怎么捣鼓，我不管，我单单只管信息通信。C向S发请求，S向C发结果，这里是单纯的不受上层影响。就是最底层的Communicaion。只不过这个com是否维持个线程是个问题。对客户端需要维持这个线程，而服务器端不需要要不然压力太大。</p>
<p>&emsp;&emsp;客户端行为：向服务器端发送信息，然后等待服务器端返回信息；</p>
<p>&emsp;&emsp;服务器端行为：以两种方式获知客户端发来的消息；</p>
<p>&emsp;&emsp;第一种，侦听到客户端连接请求；</p>
<p>&emsp;&emsp;第二种，轮询池子中的连接，获知有消息传来。接着，可以激活(产生)一个独立线程，处理消息；再将消息的处理结果返回给客户端。</p>
<p>&emsp;&emsp;从上面的讨论可以知道，消息的传递本身，可以独立出来。communication只管发出和接受消息，上层怎么接受消息（服务器轮询接受）不归我管。</p>
<p>&emsp;&emsp;这次我们communication增强功能，还能处理二进制信息，因为网络传输图片、音频和视频等文件都是传递的该文件的二进制信息。之前在CSFramework里实现的Communication只负责收发字符串信息，而这些信息包含Command、action、parameter。Command和action依然维持字符串方式，仅对parameter用二进制进行传输。</p>
<p>&emsp;&emsp;parameter本身存在两大类情况：字符串和纯二进制。若parameter是字符串，可以将其转换为二进制。这样的想法，主要目的是简化传输内容的类型。于是，需要增加一个成员：type，其取值为BIN和STR。为了标识传输的东西。</p>
<p>&emsp;&emsp;因为二进制的收发，是要通过read()和write()方法实现的，且read()方法必须知道要接收的二进制信息的字节数。因此，还需要增加一个成员：len，其取值为parameter的字节数。实际上readUTF()本身是通过传递二进制信息完成的，且readUTF()必须知道要传递的二进制字节数。</p>
<p>&emsp;&emsp;用上述方式进行信息的传递，需要经过两个步骤：</p>
<p>&emsp;&emsp;第一步：只发送command、action、type和len；</p>
<p>&emsp;&emsp;第二步：无论如何，按照二进制接收para部分，再通过解析，将二进制消息转换成字符串。</p>
<p>&emsp;&emsp;如果是字符串相关的最高层没法直接得到字符串，于是加strPara。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BIN = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STR = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ENetCommand command;</span><br><span class="line">	<span class="keyword">private</span> String action;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> type;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> length;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] binPara;</span><br><span class="line">	<span class="keyword">private</span> String strPara;</span><br><span class="line">	</span><br><span class="line">	NetMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">ENetCommand <span class="title">getCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> command;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setCommand</span><span class="params">(ENetCommand command)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.command = command;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> action;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setAction</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.action = action;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.type = type;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getLength</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> length;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">byte</span>[] getBinPara() &#123;</span><br><span class="line">		<span class="keyword">return</span> binPara;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setBinPara</span><span class="params">(<span class="keyword">byte</span>[] binPara)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.binPara = binPara;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.type == STR) &#123;</span><br><span class="line">			<span class="keyword">this</span>.strPara = <span class="keyword">new</span> String(binPara);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.type = BIN;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.length = binPara.length;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getStrPara</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> strPara;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setStrPara</span><span class="params">(String strPara)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.strPara = strPara;</span><br><span class="line">		<span class="keyword">this</span>.type = STR;</span><br><span class="line">		<span class="keyword">this</span>.binPara = strPara.getBytes();</span><br><span class="line">		<span class="keyword">this</span>.length = binPara.length;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		StringBuffer str = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (type == STR) &#123;</span><br><span class="line">			<span class="keyword">if</span> (strPara == <span class="keyword">null</span>) &#123;</span><br><span class="line">				strPara = <span class="string">""</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			binPara = strPara.getBytes();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (binPara == <span class="keyword">null</span>) &#123;</span><br><span class="line">			binPara = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		length = binPara.length;</span><br><span class="line">		str.append(command.name()).append(<span class="string">'.'</span>).append(action == <span class="keyword">null</span> ? <span class="string">" "</span> : action)</span><br><span class="line">			.append(<span class="string">'.'</span>).append(type).append(<span class="string">'.'</span>).append(length);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> str.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	NetMessage(String message) &#123;</span><br><span class="line">		<span class="keyword">int</span> dotIndex = message.indexOf(<span class="string">'.'</span>);</span><br><span class="line">		<span class="keyword">this</span>.command = ENetCommand.valueOf(message.substring(<span class="number">0</span>, dotIndex));</span><br><span class="line">		message = message.substring(dotIndex + <span class="number">1</span>);</span><br><span class="line">		dotIndex = message.indexOf(<span class="string">'.'</span>);</span><br><span class="line">		<span class="keyword">this</span>.action = message.substring(<span class="number">0</span>, dotIndex);</span><br><span class="line">		<span class="keyword">this</span>.action = action.trim().length() &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : action;</span><br><span class="line">		message = message.substring(dotIndex + <span class="number">1</span>);</span><br><span class="line">		dotIndex = message.indexOf(<span class="string">'.'</span>);</span><br><span class="line">		<span class="keyword">this</span>.type = Integer.valueOf(message.substring(<span class="number">0</span>, dotIndex));</span><br><span class="line">		message = message.substring(dotIndex + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">this</span>.length = Integer.valueOf(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;总的来说就是先发有关信息的头部信息（command,action,type,len），然后再发真正的二进制信息。</p>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			File file = <span class="keyword">new</span> File(<span class="string">"bin/resource/road.mp3"</span>);</span><br><span class="line">			FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">			FileOutputStream fos = </span><br><span class="line">					<span class="keyword">new</span> FileOutputStream(<span class="string">"bin/target/copy.mp3"</span>);</span><br><span class="line">			<span class="keyword">int</span> value = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span> ((value = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">				fos.write(value);</span><br><span class="line">			&#125;</span><br><span class="line">			fis.close();</span><br><span class="line">			fos.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;FileInputStream相当于从哪来，FileOutputStream是到哪去。但是这样FileInputStream.read逐个字节的传输是十分慢的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1</span> &lt;&lt; <span class="number">13</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			File file = <span class="keyword">new</span> File(<span class="string">"bin/resource/road.mp3"</span>);</span><br><span class="line">			FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">			FileOutputStream fos = </span><br><span class="line">					<span class="keyword">new</span> FileOutputStream(<span class="string">"bin/target/copy.mp3"</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</span><br><span class="line">			<span class="keyword">int</span> readLen = <span class="number">0</span>;</span><br><span class="line">			readLen = fis.read(buffer);</span><br><span class="line">			<span class="keyword">while</span> (readLen != -<span class="number">1</span>) &#123;</span><br><span class="line">				fos.write(buffer);</span><br><span class="line">				readLen = fis.read(buffer);</span><br><span class="line">			&#125;</span><br><span class="line">			fis.close();</span><br><span class="line">			fos.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;可以FileOutputStream.write（缓冲数组），速度会提高的很快，但是copy过去的文件比源文件大了，这是正常的因为你的文件不一定是8k（缓冲区大小）整数倍，最后一次有可能小于8k，后面的就用倒数第二次的数据补上了。因此，这种方法速度很快但是，传输的文件不能保证大小一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1</span> &lt;&lt; <span class="number">13</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			File file = <span class="keyword">new</span> File(<span class="string">"bin/resource/road.mp3"</span>);</span><br><span class="line">			FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">			FileOutputStream fos = </span><br><span class="line">					<span class="keyword">new</span> FileOutputStream(<span class="string">"bin/target/copy.mp3"</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</span><br><span class="line">			<span class="keyword">int</span> readLen = <span class="number">0</span>;</span><br><span class="line">			readLen = fis.read(buffer);</span><br><span class="line">			<span class="keyword">while</span> (readLen != -<span class="number">1</span>) &#123;</span><br><span class="line">				fos.write(buffer, <span class="number">0</span>, readLen);</span><br><span class="line">				readLen = fis.read(buffer);</span><br><span class="line">			&#125;</span><br><span class="line">			fis.close();</span><br><span class="line">			fos.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;FileOutputStream.write.write(b, off, len);把buffer中，从偏移量为off，长度为len写到文件里面去。这样速度就快，并且文件大小还准确，完完全全的复制粘贴。</p>
<p>&emsp;&emsp;经过实验，发现调大缓冲区的大小，传输速度会越来越快，在本地传输你可以把缓冲区大小设置为小于内存容量的大小。但是考虑在网络传输，在网络中传输通过学习计算机网络我们知道一个ip数据报报文最大长度是2^16 - 1，即65535，但是考虑到ip数据报报文包含头部信息，因此实际数据量应该小于65535。最好以32KB作为一次传输的量。</p>
<p>&emsp;&emsp;原因：对于大于64KB的数据报文，会被路由器自动切割成小于64KB的片段。在发送端切割和在接收端拼凑都需要花费时间的。</p>
<h2 id="Communication初步"><a href="#Communication初步" class="headerlink" title="Communication初步"></a>Communication初步</h2><p>&emsp;&emsp;网络文件（二进制）信息传输主要分成两大部分。发送方：读取文件中一块内容（缓冲区），并发送；接收方：接受网络传输过来的一块内容，并写到文件中。对于大块数据的网络传输，可能需要多次发送和多次接收。</p>
<p>&emsp;&emsp;但是，对于我们要实现的Communication类所提供的信息发送与接受，只关心一次发送，多次接收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> NetConnection netConnection;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1</span> &lt;&lt; <span class="number">15</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communication</span><span class="params">(NetConnection netConnection)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.netConnection = netConnection;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (netConnection == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		DataOutputStream dataOutputStream = netConnection.getDataOutputStream();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dataOutputStream.writeUTF(message.toString());</span><br><span class="line">			dataOutputStream.write(message.getBinPara(), <span class="number">0</span>, message.getLength());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO 对端异常掉线</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">NetMessage <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (netConnection == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		NetMessage netMessage = <span class="keyword">null</span>;</span><br><span class="line">		DataInputStream dataInputStream = netConnection.getDataInputStream();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String message = dataInputStream.readUTF();</span><br><span class="line">			netMessage = <span class="keyword">new</span> NetMessage(message);</span><br><span class="line">			<span class="keyword">byte</span>[] binPara = readBinPara(dataInputStream, netMessage.getLength());</span><br><span class="line">			netMessage.setBinPara(binPara);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO 对端异常掉线</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> netMessage;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] readBinPara(DataInputStream dataInputStream, <span class="keyword">int</span> len) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">		<span class="keyword">int</span> restLen = len;</span><br><span class="line">		<span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> readLen = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (restLen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			length = restLen &gt; BUFFER_SIZE ? BUFFER_SIZE : restLen;</span><br><span class="line">			readLen = dataInputStream.read(result, offset, length);</span><br><span class="line">			restLen -= readLen;</span><br><span class="line">			offset += readLen;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;发送端send方法。先发送信息头部包含command,action,type和length。再发具体的二进制信息，因为要根据头部信息来知道二进制信息的属性。最重要的信息有后面二进制信息的长度，这对我以后应该如何接收有很大作用。以前一直以为TCP报文中报文长度len这个属性很鸡肋，总是产生疑问对端直接接收消息不行吗?为什么还需要长度？今天从代码角度我才算是认识了。通信信道不能想成电话线，你隔这儿一直听就知道有多少信息。从代码角度理解报文长度的重要性。</p>
<p>&emsp;&emsp;接收端receive方法。先接收信息头部，解析信息头部得到netMessage对象，其中包含command，action，type和length。根据length去开始接收二进制信息。再netMessage设置二进制信息，整体圆满了。<code>restLen</code>：还剩多少字节没读 <code>offset</code>：写在距最开始多少偏移量 <code>readLen</code>：真正读了多少字节 <code>length</code>：打算要读多少字节。</p>
<p>&emsp;&emsp;总的来说，发送是一次发送完，接收是多次接收。发送是纯纯粹粹的发送一段二进制信息，当然要通过高层保证信息不是很大，接收是多次接收的原因：因为网络传输过程是十分复杂的，接收对端信息的准确性才称为一次完美的对话。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/04/03/20200403@%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5@BS@%E5%BA%95%E5%B1%82%E9%80%9A%E4%BF%A1%E4%BF%A1%E6%81%AF@%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C@Communication%E5%88%9D%E6%AD%A5/" data-id="ckf2hi5jr000438i22jaq67gh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-20200401@DNS@BS@长连接和短连接" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/01/20200401@DNS@BS@%E9%95%BF%E8%BF%9E%E6%8E%A5%E5%92%8C%E7%9F%AD%E8%BF%9E%E6%8E%A5/" class="article-date">
  <time datetime="2020-04-01T00:36:59.000Z" itemprop="datePublished">2020-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/01/20200401@DNS@BS@%E9%95%BF%E8%BF%9E%E6%8E%A5%E5%92%8C%E7%9F%AD%E8%BF%9E%E6%8E%A5/">20200401@DNS@BS@长连接和短连接</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>video:20200329</p>
<p>&emsp;&emsp;我们使用电脑最常做的事情就是上网了。基本过程是打开自己的安装好的浏览器软件，进入主页，（不考虑用搜索引擎）在网址栏输入自己要访问的网址，等待一会就到了自己想要的界面了。今天我们就简单了解下在这简单过程下的具体过程。</p>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p>&emsp;&emsp;首先说什么是域名，也就是我们平时在网址栏输入的网址。</p>
<img src="/img/NOTE/1.png" alt="1" style="zoom:80%;" />

<p>&emsp;&emsp;DNS服务:简单的来说为 <strong>域名</strong>-&gt; <strong>ip地址</strong>。DNS为互联网的各种网络应用提供核心服务。为什么这么说呢？如果一个用户要与网络中某台主机进行通信的话，必须要知道对方的ip地址，我们知道ip的是为了区分互联网上的各个主机的，但是ip地址不方便且没有特殊的规律，使用起来不方便，因此被域名代替。域名人读和使用起来方便，但机器不行。所以为了平衡人机之间的问题，就有了DNS服务。</p>
<p>&emsp;&emsp;从理论上来讲，整个互联网可以使用一个域名服务器，让它记载所有域名和ip地址的映射关系，但这种做法并不可取。原因其一随着使用互联网的人越来越多，一个DNS服务器受到的压力就会越来越大，DNS服务器这边超负荷工作对机器不好，同时被服务的用户体验感也会不好会感到慢。其二一旦这个域名服务器崩溃了，整个全球的互联网就会瘫痪。因此需要使用<em>分布式的域名系统DNS</em>。</p>
<p><img src="/img/NOTE/2.png" alt="2"></p>
<p>&emsp;&emsp;根域名服务器：是最高层次的域名服务器，所有根域名服务器都知道所有顶级域名服务器的域名和ip地址的映射。它是最重要的域名服务器，因为不管是哪一个本地域名服务器，若要对互联网上任一个域名进行解析，只要自己无法解析，就首先求助根域名服务器。（看图不要以为全世界就一个，不同国家个数不同）</p>
<p>&emsp;&emsp;顶级域名服务器：这些域名服务器负责管理在该顶级域名服务器注册的二级域名。当收到DNS查询请求时，就给出相应回答。</p>
<p>&emsp;&emsp;本地域名服务器：当一台主机发出DNS查询请求时，这个请求报文发给离提请用户较近的本地域名服务器，当要解析的地址和提请用户是同一个地方时，该域名服务器就立即将查询结果返回给提请用户，不需要再去询问其他域名服务器。若不能解析，则求助根域名服务器。同时本地服务器有存有最近查询到的域名的缓存（就是近期常访问的域名ip地址映射），以便高速反馈给用户。</p>
<h2 id="C-S模式和B-S模式区别"><a href="#C-S模式和B-S模式区别" class="headerlink" title="C/S模式和B/S模式区别"></a>C/S模式和B/S模式区别</h2><p>&emsp;&emsp;C/S模式前面CSFramework就是此模式，该模式就是长连接，所谓长连接我们知道当Server端收到一个来自客户端的连接都会开启一个与该客户端进行通信的通信信道，并且正常情况下一直维持着这就是长连接。</p>
<img src="/img/NOTE/3.png" alt="3" style="zoom:80%;" />

<p>&emsp;&emsp;客户端给服务器发请求，服务器收到请求发回响应。这只是一个客户端的连接，它俩建立的通信信道也就是Communication是一直在运行的线程，所以它的通信是十分稳定的，两端都在一直听对端消息。服务器之所以称为服务器，是因为它可以接收和管理很多客户端。所以一定会有很多客户端的连接，服务器这边要维持的线程也就越来越多。所以，总结下长连接。</p>
<ul>
<li><p>长连接的优点：建立的通信信道稳定，接受对端消息不考虑网络时延的话都是实时接收到的。</p>
</li>
<li><p>长连接的缺点：随着客户端的越来越多，服务器建立的通信信道越来越多，并且每个还都要维持住，服务器收到的压力会愈发增大。</p>
</li>
</ul>
<hr>
<p>  &emsp;&emsp;B/S模式，B：浏览器（Browser），S：Web服务器（Web Server）。基本构成是这样的。</p>
<img src="/img/NOTE/4.png" alt="4" style="zoom:80%;" />

<p>浏览器可以分三部分主要功能去做。客户端，是应用程序，解释程序。</p>
<p>客户端：因为它要与Web服务器相连，所以它是客户端。http等众多协议都在这里编写和处理。</p>
<p>应用程序：它是编写好的，能直接执行的代码。</p>
<p>解释程序：他能解析html文件、css文件、js文件，还能解析wav、MP4文件。</p>
<p>所以一个浏览器是很不容易开发的，幸好我们有现成的可以用。Chrome、火狐、360等浏览器。</p>
<p>由图我们还可以知道浏览器所解析的资源文件在Web服务器的数据库中。</p>
<p>通过多次上网并且开启F12键（调试模式）可以总结出上网过程。</p>
<ol>
<li><p>开启浏览器；</p>
</li>
<li><p>指定需要连接的Web服务器(APP服务器)地址(域名)；</p>
</li>
<li><p>由浏览器向DNS(域名解析服务器)请求解析域名，以得到Web服务器IP地址；</p>
</li>
<li><p>向目标IP地址发出首页文件(通常是index.html文件)“请求”；</p>
</li>
<li><p>服务器将index.html资源“响应”给浏览器；</p>
</li>
<li><p>浏览器解释(执行)index.html的内容，并根据其内容，向服务器发出其它请求……</p>
</li>
</ol>
<p>&emsp;&emsp;因此你浏览一个网页不是只发了一次请求而是很多请求。输入网站域名只是请求资源的第一炮（index.html），还要请求好多资源都写在html文件里，请求到许多图片，浏览器在把它们安排到合适的位置，这样你才能看见一个个形形色色的网页。</p>
<p>浏览器与服务器的请求与响应过程：</p>
<ol>
<li>浏览器向服务器提请连接请求；</li>
<li>浏览器向服务器发送“请求”信息；</li>
<li>服务器接收并处理请求信息，得到响应结果；</li>
<li>服务器将“响应”信息回传给浏览器；</li>
<li>断开连接。</li>
</ol>
<p>每一个请求都是这样的。也许你会问，Q:<strong>为什么断开连接啊，连接是耗费时间的，先别急断开，等到最后一次响应完再断开不行吗？</strong></p>
<p>A：</p>
<ol>
<li>若维持这个连接，需要服务器对每一个客户端开辟一个线程；这个线程维持连接和会话就像前面的CSFramework一样；</li>
<li>同时进行上网访问的客户端(浏览器)数量是巨大的！这个数量是服务器通过建立线程维持会话，所不能承受的！上这个网页的人千千万万，不可能每个人都要一直占我服务器资源。</li>
<li>于是，需要抛弃“长连接”思路！产生了“短连接”工作模式！</li>
</ol>
<p>因此我们提出了短连接，过程是只发一个请求过去，服务器收到请求响应发出后就断开连接。后面的请求再请求就是了。简单来说就是一次请求，一次响应。</p>
<ul>
<li>短连接的优点：能“同时”响应数量巨大的浏览器请求，而不至于造成系统资源严重不足！且代码逻辑十分简单就是只发送一次就断开。</li>
<li>短连接的缺点：带来<strong>“无状态”</strong>这个问题。</li>
</ul>
<p>&emsp;&emsp;所谓无状态这样解释。站在服务器角度，客户端发出的请求是“相同的”；服务器不区分发出请求的客户端；也不判别这个请求是否是由以前曾经发送过请求的客户端发出的。简单的说：服务器根本不关心请求是由谁发出的；即，服务器无法知道发送信息的客户端的状态。无状态虽然简单，方便，但他存在安全问题，你的第一次访问和第100次访问我都认为是一次访问，是谁不知道，是第几次也不知道。</p>
<p>&emsp;&emsp;短连接存在不安全的例子：如果一个网页需要登陆才能查看相应的用户图片，可以通过F12找到那个图片所在的链接，然后直接通过链接再开一个浏览器可以直接访问到不用登陆了。</p>
<img src="/img/NOTE/5.png" alt="5" style="zoom:80%;" />

<p>&emsp;&emsp;C/S里我们知道我们的通信信道是一直打开的，为了侦听对端信息。而我们短连接如果Web服务器维持成千上万客户端的通信信道那么服务器这边压力就很大。同时服务器这里若不写read对端消息，根本读不到。就相当于打电话，服务器这里有很多电话，多个人说话的话筒都放在一起，但我没有人去听这些话筒有没有发出声音。好在我们有个容器（Set/Map）里面放着这些connection。可以扫描那个集合，每过几毫秒打开一个通信信道看有谁说话了，有说话就开个线程去处理信息，没有则换下一个。<strong><font color= red>轮询</font></strong>!</p>
<p>&emsp;&emsp;当听到对端说话了，我这个扫描线程不处理相应信息，他将产生一个线程去处理这个信息，处理完这个线程完毕。</p>
<p>&emsp;&emsp;但问题又出现了，大量客户端socket会出现在那个盒子中，多到一定程度，内存受不了，于是，给该空间最大连接数量，一旦超过，淘汰最长时间不说话的那个，把它替换掉。</p>
<p>&emsp;&emsp;同时如某一个客户端长时间不说话，我断开这个连接。</p>
<p>&emsp;&emsp;对这个集合操作太多了，所以要用线程。线程之间的配合。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/04/01/20200401@DNS@BS@%E9%95%BF%E8%BF%9E%E6%8E%A5%E5%92%8C%E7%9F%AD%E8%BF%9E%E6%8E%A5/" data-id="ckf2hi5jg000038i290ll4gxt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CSFramework的应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/20/CSFramework%E7%9A%84%E5%BA%94%E7%94%A8/" class="article-date">
  <time datetime="2020-03-20T01:50:00.000Z" itemprop="datePublished">2020-03-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/20/CSFramework%E7%9A%84%E5%BA%94%E7%94%A8/">CSFramework的应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;前面博文讲了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/20/CSFramework%E7%9A%84%E5%BA%94%E7%94%A8/" data-id="ckf2hi5jp000338i2f9hr2gcb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CSFramework小型开发工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-03-17T06:48:00.000Z" itemprop="datePublished">2020-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">CSFramework小型开发工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;我们在计算机网络课程中学过网络的OSI的七层模型，但只是理解其描述的一些概念，并没有真正的实现，只是个概念性框架。而另一种提出的TCP/IP参考模型被投入应用了。参考前两种层次模型，我们可以提出CSFramework使用的层次模型，如下图。</p>
<img src="/img/CSFramework/2.png" alt="2" style="zoom: 67%;" />

<p>&emsp;&emsp;首先是最底层<font color= red><strong>通信层</strong>（Communication）</font>，该层只关心最底层通信的事和对端异常掉线问题，但不关心接收到的相关信息该如何处理。信息的处理不在这一层，这一层没有权利处理信息，只是将信息发给对端的作用。</p>
<p>&emsp;&emsp;下来是<font color= red><strong>会话层</strong>（Conversation）</font>,该层会收到来自下层的包装好的信息（协议），根据信息的内容去处理信息。该层可以看出对等层的概念，ServerConversation和ClientConversation之间的交锋。在sever这边看ServerConversation就是客户端，在client这边看ClientConversation就是服务器。</p>
<p>&emsp;&emsp;工具的最后一层是<font color= red><strong>Server层</strong>和<strong>Client层</strong></font>，该层是提供给外面使用的，而下面层都是工具的内部东西，不提供给外面用。所以，层是一步步建立起来的，你虽然只看到最高层用的简单，却不知道底下要有多少层在默默支持着。工具也是这样，最后用户使用的十分方便，可工具制造者才能直到建立的艰辛。<em>“辛苦我一人，幸福千万家！”</em>工具制造者最终的追求。话题扯远了，因为是CSFramework的最后一层，那就要包括CS一些普遍且必要的一些内容。例如，服务器这边的启动服务器和关闭服务器，客户端那边的连接服务器和下线，单发消息，群发消息等功能。</p>
<p>&emsp;&emsp;再高层称为<font color= red><strong>应用层</strong></font>，该层的实现不管因为会因为不同的APP而不同，所以更高层的开发由CSFramework工具的使用者去完成，就不用关心我底层的实现了。</p>
<p>&emsp;&emsp;先把整体要搭建的框架一说，接下来就开始造我们的工具。<em>友情提示：可能有些类会突兀的出现，先不要纠结于此，因为我把这个代码已经写过好几次了，一步步实现叙述太麻烦了，所以给最终代码，当然期间细节思想会讲的</em></p>
<h2 id="CSFramework"><a href="#CSFramework" class="headerlink" title="CSFramework"></a>CSFramework</h2><h3 id="com-mec-csframework-core包"><a href="#com-mec-csframework-core包" class="headerlink" title="com.mec.csframework.core包"></a>com.mec.csframework.core包</h3><p>第一个肯定是我们最底层且是Server和Client都共有的通信层Communication类，前面也说了，该类只关心信息的传输，因此该层就是建立通信信道和接受发信息的过程。</p>
<h4 id="Communication类（通信层）"><a href="#Communication类（通信层）" class="headerlink" title="Communication类（通信层）"></a>Communication类（通信层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Communication</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//方法几乎都是包权限，因为只在工具中用，工具的保护</span></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communication</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socket = socket;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			goon = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"通信层"</span>).start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span></span>;<span class="comment">//处理对端信息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span></span>;<span class="comment">//对端异常掉线</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				message = dis.readUTF();</span><br><span class="line">				dealPeerMessage(<span class="keyword">new</span> NetMessage(message));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">					peerAbnormalDrop();</span><br><span class="line">				&#125;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dos.writeUTF(message.toString());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在想这么一种情况，我一个客户端要给另一个客户端发送“byebye”消息，该消息被服务器接收到后，服务器误认为它要下线（如上篇博文规定的那样），就去做下线操作了，实际上我们只是想把信息发给另一个客户端，并无下线的意思。因此，我认为如果Communication仅仅只传字符串String类型有点不够，我们应该对网络消息规范化，将网络命令和真正的会话内容区分开了，因此有了NetMessage类。</p>
<h4 id="NetMessage类（传输的网络信息）"><a href="#NetMessage类（传输的网络信息）" class="headerlink" title="NetMessage类（传输的网络信息）"></a>NetMessage类（传输的网络信息）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetMessage</span> </span>&#123;</span><br><span class="line">	<span class="comment">//发送和接受的信息必须是该类对象</span></span><br><span class="line">	<span class="keyword">private</span> ENetCommand command;</span><br><span class="line">	<span class="keyword">private</span> String action;</span><br><span class="line">	<span class="keyword">private</span> String parameter;</span><br><span class="line">	</span><br><span class="line">	NetMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	NetMessage(String message) &#123;<span class="comment">//根据制订的规矩解析</span></span><br><span class="line">		<span class="keyword">int</span> colonIndex = message.indexOf(<span class="string">':'</span>);</span><br><span class="line">		<span class="keyword">this</span>.command = ENetCommand.valueOf(message.substring(<span class="number">0</span>, colonIndex));</span><br><span class="line">		message = message.substring(colonIndex + <span class="number">1</span>);</span><br><span class="line">		colonIndex = message.indexOf(<span class="string">':'</span>);</span><br><span class="line">		String actionStr = message.substring(<span class="number">0</span>, colonIndex).trim();</span><br><span class="line">		<span class="keyword">this</span>.action = (actionStr.length() &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : actionStr);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.parameter = message.substring(colonIndex + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;<span class="comment">//规矩 命令:动作:信息</span></span><br><span class="line">		<span class="keyword">return</span> command + <span class="string">":"</span> + (action == <span class="keyword">null</span> ? <span class="string">" "</span> : action) + <span class="string">":"</span> + parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">ENetCommand <span class="title">getCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> command;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setCommand</span><span class="params">(ENetCommand command)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.command = command;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> action;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setAction</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.action = action;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setParameter</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.parameter = parameter;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传输的信息由command（命令），action（动作，这个以后会用到不必深究），parameter（真正的消息）组成。其中带参构造是解析过程，toString方法是封装一个信息过程。为了表示网络命令的简单，我们可以使用Enum（枚举）。</p>
<h4 id="ENetCommand（枚举命令）"><a href="#ENetCommand（枚举命令）" class="headerlink" title="ENetCommand（枚举命令）"></a>ENetCommand（枚举命令）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ENetCommand &#123;</span><br><span class="line"></span><br><span class="line">	ServerFoeceDown,</span><br><span class="line">	ServerFull,</span><br><span class="line">	WhoAreYou,</span><br><span class="line">	IAm,</span><br><span class="line">	EnsureOnline,</span><br><span class="line">	Offline,</span><br><span class="line">	ToOne,</span><br><span class="line">	ToAll,</span><br><span class="line">	</span><br><span class="line">	Request,</span><br><span class="line">	Response,</span><br><span class="line">	</span><br><span class="line">	ClientAbnormalDrop,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个肯定不是未卜先知就知道所有的命令，这个是最终代码效果。</p>
<p>至此，一个编程手法就出现了。<strong>我通过NetMessage这个类屏蔽了底层真正传输的信息，我只接受NetMessage类的对象的结果。不允许你发任意String。这样约束了你的行为，我的解析变得有章可循。这就叫做<font color= red>协议</font></strong>。</p>
<p>接下来就建立下一层会话层(Conversation)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现它们是继承Communication来的，然后什么都写不了。是呀，你根本没有需求啊，没有需求让他们之间进行交锋，所以当然什么都写不了。那就去建立更高层Client和Server。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>);</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//TODO 做侦听到一个客户端连接要做的事</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里出现了三个接口，有必要解释一下。首先是IDefaultNetConfig</p>
<h4 id="IDefaultNetConfig接口（默认配置）"><a href="#IDefaultNetConfig接口（默认配置）" class="headerlink" title="IDefaultNetConfig接口（默认配置）"></a>IDefaultNetConfig接口（默认配置）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDefaultNetConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> DEFAULT_PORT = <span class="number">54188</span>;		<span class="comment">//默认的端口号</span></span><br><span class="line">	String DEFAULT_SERVER_IP = <span class="string">"127.0.0.1"</span>;	<span class="comment">//默认服务器ip地址，本地地址</span></span><br><span class="line">	<span class="keyword">int</span> DEFAULT_MAX_Client_COUNT = <span class="number">200</span>;	<span class="comment">//默认服务器最大连接数量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单理解是默认的设置，仅仅是本地的一般测试，用户可以使用相关init方法进行修改。</p>
<p>而接下来就是讲一个重要的思想，<font color= red><strong>观察者模式</strong></font>。</p>
<p>我们知道，server有许多信息例如服务器启动、客户端上线等信息是要处理的，很明显我们server工具对于这些信息不能插手，要交给上面APP层去处理，但是APP处理该信息我们做工具的根本不得而知，它可以System.out.println()在控制台输出下，也有可能是命令行模式，还有可能是我们以后写的界面显示一下。所以这么多不确定性该如何操作？这个时候就要使用接口了。让APP层提供一个能够处理在Server层信息的方法，我们Server调用这个方法，而APP具体如何处理信息我们不管，这和我工具Server无关。</p>
<h4 id="IListener接口（倾听者）"><a href="#IListener接口（倾听者）" class="headerlink" title="IListener接口（倾听者）"></a>IListener接口（倾听者）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">processMessage</span><span class="params">(String message)</span></span>;	<span class="comment">//处理消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APP层去实现这个接口，去具体实现如何处理消息</p>
<h4 id="ISpeaker接口（倾诉者）"><a href="#ISpeaker接口（倾诉者）" class="headerlink" title="ISpeaker接口（倾诉者）"></a>ISpeaker接口（倾诉者）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span></span>;		<span class="comment">//添加听众</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span></span>;	<span class="comment">//删除听众</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span></span>;	<span class="comment">//发布消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server实现这个接口，其中方法包括增加听众（IListener的实现类），删除听众（不再倾听就删除），发布消息，向每个听众发送消息，你如何处理是你的事，我反正都发，所有听众都发。</p>
<p>如果你还是不理解我再举个简单例子。ISpeaker相当于一个报社，IListener相当于一个订报纸的人。报社根本不管用户拿到报纸如何读报纸，报社只管增加订报纸的人，删除退订的人，和向每个订了报纸的人送报纸。而订报纸的用户处理得到的报纸信息，各自有各自的处理办法。</p>
<p>这就是<em>观察者模式</em>。</p>
<p>好，接下来继续写Server层。我们做到了侦听到一个客户端（Socket），接下来该怎么做？该client是Client层那个吗？不是的，服务器和客户端是分别开发的，Server层这边根本没有任何Client层的东西，再看最开始的结构图，Server与Client进行通信必须向下经过Conversation层，因此应该用这个client去实例化个serverConversation，正如我前面所说的Conversation是对等层，在Server这边看serverConversation就是一个客户端。同时，我们在此提个疑问，难道侦听到一个连接就真的是一个正常的客户端吗？如果这个客户端连接上服务器，半天不说话，就会占用相关有效资源。假如有很多这种“僵尸机”，服务器的性能将会大打折扣。所以我们要准备两个客户端池，一个是真正有效的用户连接池，一个是临时的用户连接池，够不够资格当我的有效用户，要经过我服务器的测试才可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>);</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;	<span class="comment">//TODO</span></span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//TODO 通知所有在线客户端要强制宕机了</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//TODO 通知该客户端服务器爆满</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">//TODO 先加到tempClientList中，符合条件再说</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到Server多了两个类ClientPool和TemporaryClientList。</p>
<h4 id="ClientPool类（客户端连接池）"><a href="#ClientPool类（客户端连接池）" class="headerlink" title="ClientPool类（客户端连接池）"></a>ClientPool类（客户端连接池）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, ServerConversation&gt; clientPool;</span><br><span class="line">	</span><br><span class="line">	ClientPool() &#123;</span><br><span class="line">		clientPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientPool.isEmpty();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientPool.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientPool.keySet().contains(serverConversation.getId())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientPool.put(serverConversation.getId(), serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.keySet().contains(serverConversation.getId())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientPool.remove(serverConversation.getId());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">ServerConversation <span class="title">getClientById</span><span class="params">(String id)</span> </span>&#123;	<span class="comment">//得到某个特定的client，单发</span></span><br><span class="line">		<span class="keyword">if</span> (!clientPool.keySet().contains(id)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> clientPool.get(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;ServerConversation&gt; <span class="title">getClientListExceptId</span><span class="params">(String id)</span> </span>&#123;	<span class="comment">//得到除了某个的所有client，群发</span></span><br><span class="line">		List&lt;ServerConversation&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (String key : clientPool.keySet()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (key.equals(id)) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			result.add(clientPool.get(key));</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;ServerConversation&gt; <span class="title">getAllClient</span><span class="params">()</span> </span>&#123;	<span class="comment">//得到所有client</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> getClientListExceptId(<span class="keyword">null</span>);	<span class="comment">//只要调用上面方法传个绝不存在的键就行了</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>id是区分ServerConversation的键值，这个id如何来等下讲。</p>
<h4 id="TemporaryClientList类（临时客户端连接）"><a href="#TemporaryClientList类（临时客户端连接）" class="headerlink" title="TemporaryClientList类（临时客户端连接）"></a>TemporaryClientList类（临时客户端连接）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemporaryClientList</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;ServerConversation&gt; tempClientList;</span><br><span class="line">	</span><br><span class="line">	TemporaryClientList() &#123;</span><br><span class="line">		tempClientList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tempClientList.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (tempClientList.contains(serverConversation)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		tempClientList.add(serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!tempClientList.contains(serverConversation)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		tempClientList.remove(serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TemporaryClientList设置为LinkedList是因为在此徘徊进入的客户端很多所以用链表比数组好一点。</p>
<p>这两个类完全体现了<em>Java面对对象思想</em>里的分而治之，化繁为简的思想。ClientPool和TemporaryClientList的核心是里面的成员，所有方法都是围绕成员走的，相对纯粹，且逻辑不深，仅仅add和remove等操作，把它单独拿出来做一个类。</p>
<p><strong>核心思想：小部件做好经过测试，组成一个大部件，该部件一定是成功的</strong></p>
<p>因为有了客户端连接池，所以宕机的时候如果还有在线的用户则不能宕机。同时增加个强制宕机的方法。</p>
<p>好了，现在所有的TODO都是通信方面的问题了，这个我们先别着急，先去把Client层完善下，其实我在在做这个类的时候，也是许多类之间的跨越，所以自己一定要清晰该做什么，沿着主干去做。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到Client目前很简单就是一些初始化和最重要的连接服务器。现在想这样一种情况，连接服务器可能失败（服务器没开或者未找到相应服务器），失败后要提醒用户并且询问用户是否继续连接。同时还有许多用户操作例如服务器强制宕机、服务器爆满、服务器异常掉线，这些一定是会发生的事，我们可以在底层捕获到信息，但是没有权力处理他，处理权力只能在APP层。对于这种能够预知到要发生的事，但不能实现且完成，我们还是用<font color= red><strong>接口</strong></font>。</p>
<h4 id="IClientAction接口（客户端可能触发的行为）"><a href="#IClientAction接口（客户端可能触发的行为）" class="headerlink" title="IClientAction接口（客户端可能触发的行为）"></a>IClientAction接口（客户端可能触发的行为）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IClientAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">afterOnline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnormalDrop</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">beforeOffline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">confirmOffline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">afterOffline</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String sourceId, String message)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String sourceId, String message)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">otherClientDrop</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述还是最终代码，不必在意为什么一下能写这么多。和它相关的两个辅助类异常和适配器。</p>
<h4 id="ClientActionNotSetException类（用户行为未设置异常）"><a href="#ClientActionNotSetException类（用户行为未设置异常）" class="headerlink" title="ClientActionNotSetException类（用户行为未设置异常）"></a>ClientActionNotSetException类（用户行为未设置异常）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActionNotSetException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5752188492855205231L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientActionAdapter类（用户行为适配器）"><a href="#ClientActionAdapter类（用户行为适配器）" class="headerlink" title="ClientActionAdapter类（用户行为适配器）"></a>ClientActionAdapter类（用户行为适配器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActionAdapter</span> <span class="keyword">implements</span> <span class="title">IClientAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String sourceId, String message)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String sourceId, String message)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">otherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientActionNotSetException异常类是为了规定用户对ClientAction进行设置，ClientActionAdapter适配器类就和界面部分的适配器一样，不同的时候要用不同的方法。</p>
<p>接下来就可以根据IClientAction去完善Client。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client基本设置就完成了。现在就是完成基本通信的问题了。可以看回Server类的三个TODO。接下来就是Server、ServerConversation、Client、ClientConversation之间的来回频繁切换了。始终记得Conversation收发会话信息，最终操作到Server或者Client。</p>
<ul>
<li><p>通知所有在线客户端强制宕机：得到所有在线用户相关的的ServerConversation，发送ENetCommand.ServerFoeceDown会话信息，ClientConversation接收到此信息，去做用户规定的服务器强制关闭的行为。</p>
</li>
<li><p>通知客户端服务器爆满：发送ENetCommand.ServerFull会话信息，ClientConversation接收到此信息，去做服务器满相关行为。</p>
</li>
<li><p>上线这个过程要好好说一下。此时情形是这个客户端（serverConversation）存在在临时连接里，还未加到真正的用户池里，目的是为了防止“僵尸主机”。到后期我们可以使用一个计时器如果不通信就踢出去。现在考虑真正的有效用户。服务器首先发送会话信息ENetCommand.WhoAreYou，clientConversation收到该信息，并返回发送信息ENetCommand.IAm且是带参的，参数是什么呢？在网络中标识各个主机的是ip地址，所以参数是ip地址。serverConversation收到消息，根据ip来创造id值，注意id是用在clientPool里的，因此要不能重复，ip可能重复呀，一个主机多次登陆怎么办，所以我们要找个一直在变的东西，现实生活中有这个东西，就是<font color= red><strong>时间</strong></font>。所以id就是ip + ：+当前时间组合而成的。clientconversation收到后设置下自己的id，以便和服务器一致。同时去做上线成功后的操作。</p>
</li>
<li><p>还有就是对端异常掉线问题。客户端这边服务器异常掉线具体操作不是工具应该考虑的，所以还是用clientAction。服务器这里客户端异常掉线，除了从用户池中删除。还要通知其他在线客户端有异常掉线的，会话信息是ENetCommand.ClientAbnormalDrop，参数是异常掉线客户端id的值。clientConversation这里接收到，上传到client层由clientAction去完成。</p>
</li>
<li><p>还有就是客户端正常下线的问题了。这个请求是由客户端提出来的，因此加下线操作。clientAction里的confirmOffline()可以询问用户是否真的要下线，同时还有下线前操作和下线后操作方便一些资源的回收。下线过程就是clientConversation发送ENetCommand.Offline信息，serverConversation接收到做相应从用户池清除。</p>
<p>Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端[ "</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerConversation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> IAm:</span><br><span class="line">			ensureOnline(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> Offline:</span><br><span class="line">			server.offline(<span class="keyword">this</span>);</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientConversation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> ServerFoeceDown:</span><br><span class="line">			client.serverForcedown();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ServerFull:</span><br><span class="line">			client.serverFull();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WhoAreYou:</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EnsureOnline:</span><br><span class="line">			<span class="keyword">this</span>.id = parameter;</span><br><span class="line">			client.ensureOnline();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ClientAbnormalDrop:</span><br><span class="line">			client.dealOtherClientDrop(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>上述代码仅仅只是完成了服务器和客户端最基础的操作，例如上线下线。现在我们就要考虑更为重要的功能了。单聊和群聊，这是以后开发出来的APP的共有特性。例如聊天室的私聊和群聊。棋牌室的向大家展示牌。</p>
<p>私聊（toOne）和群聊（toAll）传递的信息都有个特性，都有源id（谁发送的），目标id（谁接收的）和真正发的信息组成的。因此，根据分而治之，我们在做一个类。</p>
<h4 id="InteractiveMessage类（交互信息）"><a href="#InteractiveMessage类（交互信息）" class="headerlink" title="InteractiveMessage类（交互信息）"></a>InteractiveMessage类（交互信息）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InteractiveMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String sourceId;</span><br><span class="line">	<span class="keyword">private</span> String targetId;</span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line">	</span><br><span class="line">	InteractiveMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	InteractiveMessage(String sourceId, String targetId, String message) &#123;</span><br><span class="line">		<span class="keyword">this</span>.sourceId = sourceId;</span><br><span class="line">		<span class="keyword">this</span>.targetId = targetId;</span><br><span class="line">		<span class="keyword">this</span>.message = message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getSourceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sourceId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setSourceId</span><span class="params">(String sourceId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sourceId = sourceId;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getTargetId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> targetId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setTargetId</span><span class="params">(String targetId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.targetId = targetId;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.message = message;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"from "</span> + sourceId + <span class="string">"to "</span> + targetId + <span class="string">":"</span> + message;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们知道我们在Communcation层传递真正的信息是String类型的，可不是现在写出的InteractiveMessage类，如何将对象变为字符串呢？以后对端得到字符串又可以转换回成相应的对象呢？这就需要大名鼎鼎的<font color= red><strong>Gson</strong></font>了。</p>
<ul>
<li>私聊过程：首先是由Client提出来的，参数是目标id和要发的信息，通过clientConversation将相应的交互信息通过Gson发送过去，服务器得到相应的字符串，再用Gson得到发送的对象的id，从用户池中得到相应的serverConversation，在发回给相应的客户端，相应的客户端有clientAction有专门的dealToOne。</li>
<li>群聊过程：和上述类似，不过改变时服务器得到除了发送者的所有其他serverConversation进行。</li>
</ul>
<p>现在就有个问题了，Gson那么好用，为什么底层NetMessage不用Gson呢？原因是：Gson将对象变为字符串，将字符串变为对象，一定有许多操作，而我们底层希望速度快，下标定位比Gson快。</p>
<h4 id="Server类（服务器层）"><a href="#Server类（服务器层）" class="headerlink" title="Server类（服务器层）"></a>Server类（服务器层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String targetId = interactiveMessage.getTargetId();</span><br><span class="line">		ServerConversation serverConversation = clientPool.getClientById(targetId);</span><br><span class="line">		<span class="keyword">if</span> (serverConversation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			serverConversation.toOne(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;ServerConversation&gt; serverConversations = clientPool.getClientListExceptId(interactiveMessage.getSourceId());</span><br><span class="line">		<span class="keyword">if</span> (serverConversations == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : serverConversations) &#123;</span><br><span class="line">			serverConversation.toAll(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerConversation类（服务器端会话层）"><a href="#ServerConversation类（服务器端会话层）" class="headerlink" title="ServerConversation类（服务器端会话层）"></a>ServerConversation类（服务器端会话层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> IAm:</span><br><span class="line">			ensureOnline(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> Offline:</span><br><span class="line">			server.offline(<span class="keyword">this</span>);</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToOne:</span><br><span class="line">			server.toOne(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToAll:</span><br><span class="line">			server.toAll(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientConversation类（客户端会话层）"><a href="#ClientConversation类（客户端会话层）" class="headerlink" title="ClientConversation类（客户端会话层）"></a>ClientConversation类（客户端会话层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> ServerFoeceDown:</span><br><span class="line">			client.serverForcedown();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ServerFull:</span><br><span class="line">			client.serverFull();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WhoAreYou:</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EnsureOnline:</span><br><span class="line">			<span class="keyword">this</span>.id = parameter;</span><br><span class="line">			client.ensureOnline();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ClientAbnormalDrop:</span><br><span class="line">			client.dealOtherClientDrop(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToOne:</span><br><span class="line">			client.dealToOne(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToAll:</span><br><span class="line">			client.dealToAll(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), targetId, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), <span class="keyword">null</span>, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client类（客户端）"><a href="#Client类（客户端）" class="headerlink" title="Client类（客户端）"></a>Client类（客户端）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toOne(targetId, message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToOne(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toAll(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToAll(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做到现在，我们已经完成了客户端基本的上线下线和最简单的私聊和群聊。但是在验证客户端登陆的时候，这个问题没有解决。所谓用户登陆，是用户将账号和密码输入后，需要传给服务器这些信息，然后服务器再在数据库中查询，并返回客户端相应的数据。</p>
<p>那么，该如何完成呢？可能会想在ENetCommand里再加新的命令UserLogin，这样当然可以解决问题，但是如果这样做以后客户端有许许多多的要在服务器端完成的操作，那就需要在ENetCommand加更多命令了。但是首先ENetCommand是我们工具的内部东西，你怎么让使用工具的人往里面加东西呢？其次ENetCommand可以增加的话，那里面所有的东西都需要增加东西了，再次强调我们做的是工具，工具内部不提供给外面！因此，<font color= red><strong>我们只打算给APP层提供一个开发框架，不能照顾到所有APP层实现的功能，对于这些功能，我们只能提供APP层实现相关功能的途径。</strong></font></p>
<p>结局方法在NetMessage里的action里。以前写的命令，都是C（客户端）给其他C发消息，但并没有返回给自己的情况，现在有了。C向S（服务端）发送请求并且希望得到回复。我们统一称为C向S发的是<font color= red>Request</font>，S获取到这个请求获取数据进行一系列操作，再给C返回结果称为<font color= red>Response</font>。</p>
<p>Client加sendRequest(String action, String parameter)方法，经过ClientConversation传到ServerConversation，然后问题来了，服务器收到这个该如何操作？仿照IClientAction写个IServerAction吗？提供给外面让其实现？里面是switch case case下去？那么要写几万个？每一个个要写几万行？每一个都是一个MVC模式，这样不行。我们再仔细考虑下，这些Request不都大同小异吗？都是S获得Request里面的数据，进行一系列操作，并返回一个东西给C。所以我可不可以让他自动执行？只要配置好相关XML文件。因此，想要自动完成要做以下三件事。</p>
<ul>
<li>APP层发送请求。例如：client.sendRequest(“userLogin”, 参数)。</li>
<li>在APP层的userAction写相关方法</li>
<li>配置相关XML文件</li>
</ul>
<p>相关XML文件格式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>= <span class="string">"userLogin"</span> <span class="attr">class</span>= <span class="string">"com.mec.test.server.user.action.UserAction"</span> <span class="attr">method</span>=<span class="string">"userLogin"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>= <span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>= <span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签action里的属性name是这个action的名字，就是sendRequest里参数的名字；class是完成这个action方法的包名称，method完成这个action的方法名称。标签parameter是方法的参数，name是参数名称，type是参数类型（八大基本类型直接写，其他类型带包名称）。</p>
<p>当然这里只写了一个action，随着APP开发功能的丰富，会不断增加的，并且这个不是在工具内部是可以随后任意按规则增加的XML文件。</p>
<p>难道每遇见一次action，就去解析一次XML吗？解析是外存操作，浪费时间，能不能一次解析。再分析XML文件，我们可以让action的属性name作为key键，后面其他部分都为value值。</p>
<h3 id="com-mec-csframework-action"><a href="#com-mec-csframework-action" class="headerlink" title="com.mec.csframework.action"></a>com.mec.csframework.action</h3><h4 id="ActionBeanDefinition类"><a href="#ActionBeanDefinition类" class="headerlink" title="ActionBeanDefinition类"></a>ActionBeanDefinition类</h4><p>简简单单描述value具体是由哪些组成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBeanDefinition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	<span class="keyword">private</span> Method method;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; parameterNameList;</span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionBeanDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		parameterNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		index = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getParameterNameListSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> hasNext = index &lt; parameterNameList.size();</span><br><span class="line">		<span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">			index = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> hasNext;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList.get(index++);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; getKlass() &#123;</span><br><span class="line">		<span class="keyword">return</span> klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setKlass</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.klass = klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Method <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> method;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.method = method;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addParameterName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		parameterNameList.add(name);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;String&gt; <span class="title">getParameterNameList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> klass + <span class="string">"\n\t"</span> + method;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActionBeanFactory类"><a href="#ActionBeanFactory类" class="headerlink" title="ActionBeanFactory类"></a>ActionBeanFactory类</h4><p>扫描XML任务，将所有扫面到的有效的action放进池子里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ActionBeanDefinition&gt; actionPool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		actionPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> ActionBeanDefinition <span class="title">getActionBeanDefinition</span><span class="params">(String actionName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> actionPool.get(actionName);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setObject</span><span class="params">(String action, Object object)</span> </span>&#123;</span><br><span class="line">		ActionBeanDefinition abd = actionPool.get(action);</span><br><span class="line">		<span class="keyword">if</span> (abd != <span class="keyword">null</span> &amp;&amp; abd.getObject() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			abd.setObject(object);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanActionMappingXMLPath</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		scanActionMappingXMLPath(<span class="string">"/actionMapping.xml"</span>);	<span class="comment">//默认扫描位置</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanActionMappingXMLPath</span><span class="params">(String xmlPath)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Document document = XMLParse.getDocument(xmlPath);</span><br><span class="line">		<span class="keyword">if</span> (document == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"配置文件不对"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String actionName = element.getAttribute(<span class="string">"actionName"</span>);</span><br><span class="line">				String className = element.getAttribute(<span class="string">"className"</span>);</span><br><span class="line">				String methodName =element.getAttribute(<span class="string">"methodName"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Class&lt;?&gt; klass = Class.forName(className);</span><br><span class="line">					ActionBeanDefinition actionBeanDefinition = <span class="keyword">new</span> ActionBeanDefinition();</span><br><span class="line">					actionBeanDefinition.setKlass(klass);</span><br><span class="line">					setMethod(element, klass, methodName, actionBeanDefinition);</span><br><span class="line">					actionPool.put(actionName, actionBeanDefinition);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(document, <span class="string">"action"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(Element element, Class&lt;?&gt; klass, String methodName, ActionBeanDefinition abd)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException </span>&#123;</span><br><span class="line">		List&lt;String&gt; parameterTypeNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String parameterName = element.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">				String typeName = element.getAttribute(<span class="string">"type"</span>);</span><br><span class="line">				abd.addParameterName(parameterName);</span><br><span class="line">				parameterTypeNameList.add(typeName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(element, <span class="string">"parameter"</span>);</span><br><span class="line">		<span class="keyword">int</span> parameterCount = parameterTypeNameList.size();</span><br><span class="line">		Class&lt;?&gt;[] parameterTypeArray = parameterCount &lt;=<span class="number">0</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Class&lt;?&gt;[parameterCount];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterCount; i++) &#123;</span><br><span class="line">			parameterTypeArray[i] = MecType.toType(parameterTypeNameList.get(i));</span><br><span class="line">		&#125;</span><br><span class="line">		Method method = klass.getMethod(methodName, parameterTypeArray);</span><br><span class="line">		abd.setMethod(method);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中XML解析工具，可以在以前写的博文查看到。还有一个类MecType。</p>
<h4 id="MecType类（工具包中的）"><a href="#MecType类（工具包中的）" class="headerlink" title="MecType类（工具包中的）"></a>MecType类（工具包中的）</h4><p>将字符串类型的String、int、boolean变为真正的类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MecType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MecType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; toType(String typeName) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"string"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> String<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"int"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"char"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">char</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"boolean"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"double"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">double</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"float"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">float</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"long"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">long</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"byte"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">byte</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"short"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">short</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> Class.forName(typeName);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="IActionProcessor接口（处理器接口）"><a href="#IActionProcessor接口（处理器接口）" class="headerlink" title="IActionProcessor接口（处理器接口）"></a>IActionProcessor接口（处理器接口）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IActionProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">dealRequest</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActionProcessorNotFound类（处理器未设置异常）"><a href="#ActionProcessorNotFound类（处理器未设置异常）" class="headerlink" title="ActionProcessorNotFound类（处理器未设置异常）"></a>ActionProcessorNotFound类（处理器未设置异常）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionProcessorNotFound</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">108844566290027953L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DefaultActionProcessor类（默认处理器）"><a href="#DefaultActionProcessor类（默认处理器）" class="headerlink" title="DefaultActionProcessor类（默认处理器）"></a>DefaultActionProcessor类（默认处理器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultActionProcessor</span> <span class="keyword">implements</span> <span class="title">IActionProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">dealRequest</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound </span>&#123;</span><br><span class="line">		ActionBeanDefinition actionBeanDefinition = ActionBeanFactory.getActionBeanDefinition(action);</span><br><span class="line">		<span class="keyword">if</span> (actionBeanDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ActionProcessorNotFound(<span class="string">"未找到对应处理器"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object object = actionBeanDefinition.getObject();</span><br><span class="line">		<span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				object = actionBeanDefinition.getKlass().getConstructor().newInstance();</span><br><span class="line">				actionBeanDefinition.setObject(object);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			Method method = actionBeanDefinition.getMethod();</span><br><span class="line">			ArgumentMaker argumentMaker = <span class="keyword">new</span> ArgumentMaker(parameter);</span><br><span class="line">			<span class="keyword">int</span> size = actionBeanDefinition.getParameterNameListSize();</span><br><span class="line">			Object[] valueList = size &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Object[size];</span><br><span class="line">			<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">			Parameter[] parameters = method.getParameters();</span><br><span class="line">			<span class="keyword">while</span> (actionBeanDefinition.hasNext()) &#123;</span><br><span class="line">				valueList[index] = argumentMaker.getArgumentByName(actionBeanDefinition.next(), parameters[index].getParameterizedType());</span><br><span class="line">				index++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Object result = method.invoke(object, valueList);</span><br><span class="line">				<span class="keyword">return</span> ArgumentMaker.gson.toJson(result);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound </span>&#123;</span><br><span class="line">		ActionBeanDefinition abd = ActionBeanFactory.getActionBeanDefinition(action);</span><br><span class="line">		<span class="keyword">if</span> (abd == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ActionProcessorNotFound(<span class="string">"未找到对应处理器"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object object = abd.getObject();</span><br><span class="line">		Method method = abd.getMethod();</span><br><span class="line">		Object[] value = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">		Parameter[] paramters = method.getParameters();</span><br><span class="line">		value[<span class="number">0</span>] = ArgumentMaker.gson.fromJson(parameter, paramters[<span class="number">0</span>].getParameterizedType());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			method.invoke(object, value);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过配置文件的方式，允许用户自己定义自己的类，通过反射机制来处理远端请求，分解出里面的action，根据action，将传过来的参数交给某一个类的方法，并且反射调用执行。</p>
<p><strong>分发器核心：</strong>分析action，找到action相应的处理方法，这就是分发器。</p>
<p>dealRequest方法和dealResponse方法都是为了调用以后APP层上写相关动作的方法，且都是通过反射机制调用执行的。方法的执行需要对象和参数值数组。</p>
<p>对于服务器端需要处理客户的的Request，其有可能有返回值也有可能没有返回值，有返回值的话其返回值类型是千变万化的，根本不能确定。因此又需要借助Gson了，将返回值作为Gson字符串对象，到时候也可以转换回来。</p>
<p>对于客户端要处理来自服务器的Response，且这时候得到服务器返回回来的Gson字符串，有一也且仅有一个。</p>
<p>这时，问题就出现了。</p>
<p>反射机制调用方法，invoke（对象，参数值数组）。问题就出现在参数值数组这里，这里的参数是由用户方法中参数确定的，正因为是用户自定义的，那参数类型就会千奇百怪且数量不定。如何将多个参数揉合在一起，那就要使用容器了List或者Map了。我们知道invoke方法的参数值数组的值顺序必须与方法参数顺序保持一致，所以乍一看使用顺序结构List比较方便，但做到后期发现有问题，Parameter类得到参数名字都是arg0,arg1的。所以还是用Map，键为参数名字，值为参数值，这样对应起来找的话也好找。再把Map对象变为Gson字符串，将Gson字符串在网络间通信，解析的时候再由得到的字符串变回为Map，从Map取各自的值。</p>
<p>但是还是有问题，我们知道Java会有<font color= blue><em>泛型擦除机制</em></font>，对于Map这种带有泛型的容器发送到对端根本不能解析。</p>
<p>幸运的是，办法总是比困难多，在网上找到Gson的高级使用方法——Typetoken。因此下来有了重要的一个类ArgumentMaker。</p>
<h4 id="ArgumentMaker类（工具包中的）"><a href="#ArgumentMaker类（工具包中的）" class="headerlink" title="ArgumentMaker类（工具包中的）"></a>ArgumentMaker类（工具包中的）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; argumentMap;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson gson = <span class="keyword">new</span> GsonBuilder().create();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Type type = <span class="keyword">new</span> TypeToken&lt;Map&lt;String, String&gt;&gt; () &#123;&#125;.getType();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ArgumentMaker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		argumentMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ArgumentMaker</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		argumentMap = gson.fromJson(parameter, type);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getArgumentByName</span><span class="params">(String name, Type type)</span> </span>&#123;</span><br><span class="line">		String json = argumentMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> gson.fromJson(json, type);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getArgumentByName</span><span class="params">(String name, Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		String json = argumentMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> gson.fromJson(json, klass);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ArgumentMaker <span class="title">add</span><span class="params">(String name, Object value)</span> </span>&#123;</span><br><span class="line">		argumentMap.put(name, gson.toJson(value));</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> gson.toJson(argumentMap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类核心操作都是围绕argumentMap这个成员走的。toString是构造，而带参构造方法则是解析。</p>
<p>总体来说，ArgumentMaker类出现是因为dealRequest和dealResponse的parameter参数会很复杂，如何将众多参数做成一个合起来的。发现参数有K、V关系。K：参数名，V：参数值。做成一个Map，再将Map进行Gson化，但是有泛型擦除机制，要借助Gson高级用法TypeToken。就这样一个工具产生了。</p>
<p>至此，CSFramework工具的所有类基本都介绍完了。</p>
<p>关于优化，不知道大家怎么感觉switch语句那里。反正个人觉得挺恶心的，写的有点长一个屏幕看不完，并且还会造成以下问题。</p>
<img src="/img/CSFramework/3.png" alt="3" style="zoom: 67%;" />

<p>我们知道，以后肯定是有很多客户端的，会造成多个线程都在这里停步，一个个进行switch的比对，或者这样说<strong>多进一出</strong>。这肯定会对性能造成影响，为了解决这个问题再次采用分发器（分析command，找到command的处理方法）处理。</p>
<h4 id="PeerMessageProcessor类（对端消息处理器）"><a href="#PeerMessageProcessor类（对端消息处理器）" class="headerlink" title="PeerMessageProcessor类（对端消息处理器）"></a>PeerMessageProcessor类（对端消息处理器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeerMessageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	</span><br><span class="line">	PeerMessageProcessor() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">		<span class="keyword">this</span>.klass = object.getClass();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String commandStr = command.name();</span><br><span class="line">		String methodName = <span class="string">"deal"</span> + commandStr;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Method method = klass.getDeclaredMethod(methodName, NetMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			method.invoke(object, message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server类（完整）"><a href="#Server类（完整）" class="headerlink" title="Server类（完整）"></a>Server类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String targetId = interactiveMessage.getTargetId();</span><br><span class="line">		ServerConversation serverConversation = clientPool.getClientById(targetId);</span><br><span class="line">		<span class="keyword">if</span> (serverConversation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			serverConversation.toOne(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;ServerConversation&gt; serverConversations = clientPool.getClientListExceptId(interactiveMessage.getSourceId());</span><br><span class="line">		<span class="keyword">if</span> (serverConversations == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : serverConversations) &#123;</span><br><span class="line">			serverConversation.toAll(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerConversation类（完整）"><a href="#ServerConversation类（完整）" class="headerlink" title="ServerConversation类（完整）"></a>ServerConversation类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	<span class="keyword">private</span> IActionProcessor actionProcessor;</span><br><span class="line">	<span class="keyword">private</span> PeerMessageProcessor peerMessageProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">		peerMessageProcessor = <span class="keyword">new</span> PeerMessageProcessor();</span><br><span class="line">		peerMessageProcessor.setObject(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setActionProcessor</span><span class="params">(IActionProcessor actionProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.actionProcessor = actionProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		peerMessageProcessor.dealPeerMessage(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealIAm</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ensureOnline(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOffline</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.offline(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.toOne(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.toAll(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealRequest</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		String action = message.getAction();</span><br><span class="line">		<span class="keyword">if</span> (actionProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actionProcessor = <span class="keyword">new</span> DefaultActionProcessor();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String requestResult = actionProcessor.dealRequest(action, parameter);</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Response)</span><br><span class="line">					.setAction(action)</span><br><span class="line">					.setParameter(requestResult));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ActionProcessorNotFound e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientConversation类（完整）"><a href="#ClientConversation类（完整）" class="headerlink" title="ClientConversation类（完整）"></a>ClientConversation类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> IActionProcessor actionProcessor;</span><br><span class="line">	<span class="keyword">private</span> PeerMessageProcessor peerMessageProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">		peerMessageProcessor = <span class="keyword">new</span> PeerMessageProcessor();</span><br><span class="line">		peerMessageProcessor.setObject(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setActionProcessor</span><span class="params">(IActionProcessor actionProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.actionProcessor = actionProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		peerMessageProcessor.dealPeerMessage(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealServerFoeceDown</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.serverForcedown();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealServerFull</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.serverFull();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealWhoAreYou</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealEnsureOnline</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = message.getParameter();</span><br><span class="line">		client.ensureOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealClientAbnormalDrop</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealOtherClientDrop(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealToOne(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealToAll(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		String action = message.getAction();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">if</span> (actionProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actionProcessor = <span class="keyword">new</span> DefaultActionProcessor();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			actionProcessor.dealResponse(action, parameter);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ActionProcessorNotFound e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), targetId, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), <span class="keyword">null</span>, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String action, String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Request)</span><br><span class="line">				.setAction(action).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client类（完整）"><a href="#Client类（完整）" class="headerlink" title="Client类（完整）"></a>Client类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toOne(targetId, message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToOne(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toAll(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToAll(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String action, String parameter)</span> </span>&#123;</span><br><span class="line">		clientConversation.sendRequest(action, parameter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，关于CSFramework的长连接就到此结束了。其中遇到的问题、问题的解决方法和心路历程都在博文里面写了，谢谢阅读。</p>
<p>感谢<strong>铁血教主</strong>的细心指导。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" data-id="ckf2hi5jx000b38i2b9rl3qhs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CSFramework的引出" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" class="article-date">
  <time datetime="2020-03-11T00:36:59.000Z" itemprop="datePublished">2020-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/">CSFramework的引出</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="CSFramework的引出：几个简单的网络通信例子"><a href="#CSFramework的引出：几个简单的网络通信例子" class="headerlink" title="CSFramework的引出：几个简单的网络通信例子"></a>CSFramework的引出：几个简单的网络通信例子</h2><p>&emsp;&emsp;现如今，互联网几乎在我身边随处可见，早已深入我们人类生活中。如今的软件如果没有网络功能，那是很不可思议的事情。(单机游戏都有局域网功能，小时候和朋友联机打的红警就是例子)。许多语言都支持网络编程，我见过C与Java有关网络的程序代码，从中深刻感受到有工具和没工具编代码效率是多么天差地别。就相当于在赛跑，C还在那里造车轮子，Java已经开始用别人给的车开始跑了。<br>&emsp;&emsp;最近一直在学习Java，因此用Java学习网络编程。C/S模式，又称客户端服务器模式。至少用两台计算机来分别充当客户机和服务器角色。C/S模式将应用（对于客户端来说）与服务（对于服务器来说）分离，两边各自开发自己的，两套程序。对于服务器，Java提供一个ServerSocket类来创建服务器，对于客户端，Java提供一个Socket类可以连接服务器。<br>&emsp;&emsp;接下来，就先写三个简单的网络通信的例子（一对一单次通信和一对一多次通信）来熟悉下相关类。</p>
<h3 id="一对一单次通信"><a href="#一对一单次通信" class="headerlink" title="一对一单次通信"></a>一对一单次通信</h3><p>&emsp;&emsp;一对一单次通信：一个服务器和一个客户端单次通信</p>
<p>服务器方代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> port = <span class="number">54188</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"开始启动服务器..."</span>);</span><br><span class="line">			ServerSocket server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">			System.out.println(<span class="string">"服务器启动成功!"</span>);</span><br><span class="line">			System.out.println(<span class="string">"开始侦听客户端连接请求..."</span>);</span><br><span class="line">			Socket client = server.accept();</span><br><span class="line">			InetAddress inetaddress = client.getInetAddress();</span><br><span class="line">			String clientIp = inetaddress.getHostAddress();	<span class="comment">//客户端ip地址</span></span><br><span class="line">			String clientName = inetaddress.getHostName(); <span class="comment">//客户端名称</span></span><br><span class="line">			System.out.println(<span class="string">"发现客户端(ip: "</span> + clientIp	+ <span class="string">", 主机名:"</span> + clientName + <span class="string">")请求连接服务器"</span>);</span><br><span class="line">			DataInputStream dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());  <span class="comment">//开始建立通信信道</span></span><br><span class="line">			DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">            System.out.println(<span class="string">"通信信道已建立完成"</span>);</span><br><span class="line">			</span><br><span class="line">			String message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自客户端的消息["</span> + message + <span class="string">"]"</span>);</span><br><span class="line">			dos.writeUTF(<span class="string">"我收到你的消息了"</span>);</span><br><span class="line">			</span><br><span class="line">			dis.close();</span><br><span class="line">			dos.close();</span><br><span class="line">			client.close();</span><br><span class="line">			server.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		String serverIp = <span class="string">"127.0.0.1"</span>;	</span><br><span class="line">        <span class="comment">//服务器ip地址，因为本地测试所以127.0.0.1</span></span><br><span class="line">		<span class="keyword">int</span> serverPort = <span class="number">54188</span>;</span><br><span class="line">        <span class="comment">//和服务器协商好的</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"开始连接服务器....."</span>);</span><br><span class="line">			Socket socket = <span class="keyword">new</span> Socket(serverIp, serverPort);</span><br><span class="line">			System.out.println(<span class="string">"连接成功"</span>);</span><br><span class="line">			DataInputStream dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			</span><br><span class="line">			dos.writeUTF(<span class="string">"你好，我是一个客户端"</span>);</span><br><span class="line">			String message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自服务器的消息:"</span> + message);</span><br><span class="line">			</span><br><span class="line">			dis.close();</span><br><span class="line">			dos.close();</span><br><span class="line">			socket.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;			<span class="comment">//服务器名称或地址不存在。未知主机异常</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">开始启动服务器...</span></span><br><span class="line"><span class="attr">服务器启动成功!</span></span><br><span class="line"><span class="attr">开始侦听客户端连接请求...</span></span><br><span class="line"><span class="meta">发现客户端(ip</span>: <span class="string">127.0.0.1, 主机名:127.0.0.1)请求连接服务器</span></span><br><span class="line"><span class="attr">通信信道已建立完成</span></span><br><span class="line"><span class="attr">来自客户端的消息[你好，我是一个客户端]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line"><span class="attr">开始连接服务器.....</span></span><br><span class="line"><span class="attr">连接成功</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">我收到你的消息了</span></span><br></pre></td></tr></table></figure>

<p>从上面一对一通信程序，希望你能了解到以下几点。</p>
<p>服务器方面:</p>
<ul>
<li>ServerSocket的建立需要port（端口号），且这个端口号必须和连接的客户端保持一直，也就是说要和客户端协商好。</li>
<li>如果没有客户端连接，程序会卡在accept()那个地方，可以类似于scanf函数，若没有客户端连接则程序会停在accept()那个地方，有客户端连接才会让程序向下进行</li>
<li>可以让客户端先不发消息（把发消息那里注释掉），观察情况，发现两个程序都卡住了，都卡在dis.readUTF()这里。所以dis.readUTF()这个方法也是类似于scanf函数，没有收到对端的消息就卡在这，程序不往下走。dis.readUTF()这个方法是读对端发来的消息，是被动的等，一直等，没有就停在这里</li>
<li>dos.writeUTF()相当于给对端发消息，主动的发消息。</li>
</ul>
<p>客户端方面:</p>
<ul>
<li>Socket的建立需要服务器的ip地址和和服务器协商好的port</li>
<li>也需要建立DataInputStream和DataOutputStream</li>
</ul>
<p>总结一下服务器和客户端都需要DataInputStream和DataOutputStream。它俩相当于什么呢？可以这么说就相当于我们学的通信原理里面的信道那个概念，两端进行信息交换的通信信道；也可以举个现实生活中的例子，就是我们的座机电话，他有两端，上面是听筒端（DataInputStream）和说话端（DataOutputStream）。</p>
<hr>
<h3 id="一对一多次通信"><a href="#一对一多次通信" class="headerlink" title="一对一多次通信"></a>一对一多次通信</h3><p>&emsp;&emsp;一对一多次通信:一个服务器和一个客户端多次通信</p>
<p>&emsp;&emsp;上述一对一单次通信的代码很简单，我们要从中熟悉一些需要用的类。但是，我相信肯定不是上面我们最终的目的吧？不可能通信只通信一句话吧？所以来进一步实现一个客户端和一个服务器多次通信。</p>
<p>&emsp;&emsp;如何进行多次通信呢？经过思考只要通信信道不关闭，就可以多次发送消息。但不能一直通信下去，要有办法停止，也就是可控性。所以定发特定的字符串就停止下来。</p>
<p>服务器代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> Socket client;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始建立服务器"</span>);</span><br><span class="line">		serverSocket = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		System.out.println(<span class="string">"服务器建立完成"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (client != <span class="keyword">null</span> &amp;&amp; !client.isClosed()) &#123;</span><br><span class="line">				client.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			client = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (serverSocket != <span class="keyword">null</span> &amp;&amp; !serverSocket.isClosed()) &#123;</span><br><span class="line">				serverSocket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			serverSocket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listeningClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">		client = serverSocket.accept();</span><br><span class="line">		System.out.println(<span class="string">"客户端["</span> + client.getInetAddress().getHostAddress() + <span class="string">", "</span> + client.getInetAddress().getHostName()</span><br><span class="line">				+ <span class="string">"]连入服务器"</span>);</span><br><span class="line">		</span><br><span class="line">		dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());</span><br><span class="line">		dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">		</span><br><span class="line">		String message = <span class="string">""</span>;</span><br><span class="line">        System.out.println(<span class="string">"接受来自客户端的消息..."</span>);</span><br><span class="line">		<span class="keyword">while</span> (!message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">			message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自客户端的消息:"</span> + message);</span><br><span class="line">			dos.writeUTF(<span class="string">"["</span> + message + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, IOException </span>&#123;</span><br><span class="line">		ip = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始连接服务器..."</span>);</span><br><span class="line">		socket = <span class="keyword">new</span> Socket(ip, port);</span><br><span class="line">		System.out.println(<span class="string">"连接服务器成功"</span>);</span><br><span class="line">		dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">		dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		String message = <span class="string">""</span>;</span><br><span class="line">		String messageFromServer;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">while</span>(!message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">				message = in.nextLine();</span><br><span class="line">				dos.writeUTF(message);</span><br><span class="line">				messageFromServer = dis.readUTF();</span><br><span class="line">				System.out.println(<span class="string">"来自服务器的消息:"</span> +messageFromServer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		in.close();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行代码。<strong>注意:</strong>要先运行服务器，在运行客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">new</span> SimpleServer().listeningClient();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">new</span> SimpleClient().talking();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显示结果如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">开始建立服务器</span></span><br><span class="line"><span class="attr">服务器建立完成</span></span><br><span class="line"><span class="attr">开始侦听客户端连接请求</span></span><br><span class="line"><span class="meta">客户端[127.0.0.1,</span> <span class="string">127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">接受来自客户端的消息...</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">你好</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">我是一个客户端</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">byebye</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line"><span class="attr">开始连接服务器...</span></span><br><span class="line"><span class="attr">连接服务器成功</span></span><br><span class="line"><span class="attr">你好</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[你好]</span></span><br><span class="line"><span class="attr">我是一个客户端</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[我是一个客户端]</span></span><br><span class="line"><span class="attr">byebye</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[byebye]</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="一对多多次通信"><a href="#一对多多次通信" class="headerlink" title="一对多多次通信"></a>一对多多次通信</h3><p>&emsp;&emsp;一对多多次通信:一个服务器和多个客户端的多次通信</p>
<p>&emsp;&emsp;前面的代码不是我们最终的目的，如果一个服务器只能接入一个客户端，你说他还能称为服务器吗？服务器作为网络节点中心管理者，要实现接入多个客户端的功能。经过分析上述代码得知之所以只接入了一个客户端的原因是，accept()方法只运行了一次，要想接入多个客户端，必须让accept()方法重复执行，我们可以把它放在循环里，条件是服务器关闭与否。但是还是有问题，前面说过accept()方法相当于scanf函数，没有接入它的客户端，程序会卡在那里阻止下面通信的代码。解决方法:用<font color= red><strong>线程</strong></font>。服务器accept()侦听客户端连接用线程并行去跑，不要影响我下面的代码。</p>
<p>&emsp;&emsp;同时分析上述代码我们可以知道每连接一个新的客户端都要新造一个独立的通信信道，这是当然啦，你要和服务器建立联系，就得造通信信道，该通信信道是只有你和服务器用的，独立的，不能让别人用。两端都要有通信信道(DataInputStream和DataOutputStream)所以我们最好把它单独拎出来做成一个类。同时我们知道dis.read()方法也相当于scanf函数，程序卡在这里不会运行以后的代码，你等待对端消息不能干扰我主动给对端发消息吧。因此，也用<font color= red><strong>线程</strong></font>解决。</p>
<p>&emsp;&emsp;只有做到以上两点，才能完成一对多多次通信。才能实现服务器边听（侦听客户端连接）边说（给对端发消息）！可以用以下图示来说明。</p>
<img src="/img/CSFramework/1.png" style="zoom: 50%;" />



<p>先写双方都需要建立的通信信道类Communcation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Communcation</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;	<span class="comment">//volatitle关键字:拒绝内存优化，这是线程安全相关问题</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communcation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socket = socket;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			goon = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"通信层"</span>).start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dos.writeUTF(message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				message = dis.readUTF();</span><br><span class="line">				dealPeerMessage(message);	<span class="comment">//处理对端消息具体做法让外面来决定</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">					dealPeerAbnoramlDrop();	<span class="comment">//当goon还是true的时候，说明是对端异常掉线，做法让外面来决定</span></span><br><span class="line">				&#125;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulServer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MulServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		System.out.println(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		goon = <span class="keyword">true</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始侦听客户端连接..."</span>);</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">false</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">		System.out.println(<span class="string">"服务器正常宕机"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> goon;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				System.out.println(<span class="string">"客户端["</span> + client.getInetAddress().getHostAddress() + </span><br><span class="line">						client.getInetAddress().getHostName() + <span class="string">"]连入服务器"</span>);</span><br><span class="line">				<span class="keyword">new</span> Communcation(client) &#123;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">						<span class="keyword">if</span> (message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">							System.out.println(<span class="string">"客户端正常下线"</span>);</span><br><span class="line">							close();</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						System.out.println(<span class="string">"收到来自客户端的消息:"</span> + message);</span><br><span class="line">						send(<span class="string">"["</span> + message +<span class="string">"]"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						System.out.println(<span class="string">"客户端异常掉线"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> Communcation communcation;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MulClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		serverIp = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (communcation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		communcation.send(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (communcation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		communcation.close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, IOException </span>&#123;</span><br><span class="line">		socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">		communcation = <span class="keyword">new</span> Communcation(socket) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"来自服务器的消息:"</span> + message);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"服务器异常宕机，服务停止"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		MulServer mulServer = <span class="keyword">new</span> MulServer();</span><br><span class="line">		Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		String command = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">boolean</span> finshed = <span class="keyword">false</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (!finshed) &#123;</span><br><span class="line">			command = in.next();</span><br><span class="line">			<span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"st"</span>)) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					mulServer.startUp();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"sd"</span>)) &#123;</span><br><span class="line">				mulServer.shutDown();</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"x"</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!mulServer.isStartup()) &#123;</span><br><span class="line">					finshed = <span class="keyword">true</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					System.out.println(<span class="string">"服务器尚未宕机!"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		in.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		MulClient client = <span class="keyword">new</span> MulClient();</span><br><span class="line">		<span class="keyword">boolean</span> finished = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client.connectToServer();</span><br><span class="line">			</span><br><span class="line">			Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">			</span><br><span class="line">			String message = <span class="string">""</span>;</span><br><span class="line">			<span class="keyword">while</span> (!finished) &#123;</span><br><span class="line">				message = in.next();</span><br><span class="line">				client.send(message);</span><br><span class="line">				<span class="keyword">if</span> (message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">					client.close();</span><br><span class="line">					finished = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			in.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行服务器测试代码，在运行客户端测试代码。进行测试结果如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">st</span></span><br><span class="line"><span class="attr">开始建立服务器...</span></span><br><span class="line"><span class="attr">服务器建立成功</span></span><br><span class="line"><span class="attr">开始侦听客户端连接...</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">123</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">456</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">789</span></span><br><span class="line"><span class="attr">客户端正常下线</span></span><br><span class="line"><span class="attr">客户端异常掉线</span></span><br><span class="line"><span class="attr">客户端正常下线</span></span><br><span class="line"><span class="attr">sd</span></span><br><span class="line"><span class="attr">服务器正常宕机</span></span><br><span class="line"><span class="attr">x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端1</span></span><br><span class="line"><span class="attr">123</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[123]</span></span><br><span class="line"><span class="attr">byebye</span></span><br><span class="line"><span class="comment">#客户端2 故意强制关闭</span></span><br><span class="line"><span class="attr">456</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[456]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端3</span></span><br><span class="line"><span class="attr">789</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[789]</span></span><br><span class="line"><span class="attr">byebye</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;&emsp;一对多多次通信就完成了。服务器可以接入多个客户端，客户端可以发消息给服务器。但是，这就完了吗？这就是我们想要的吗？我并不认为就完了，我们做的功能太简陋了，完全不够用。同时思考可不可以将底层通信的代码做成工具，做成普适性工具，这样以后开发不同需求的C/S程序就会方便很多。这就是框架的含义，也就是我们要做的工具CSFramework。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" data-id="ckf2hi5ju000738i27pylfhlc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-XML文件与Properites文件解析工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-03-06T08:19:34.669Z" itemprop="datePublished">2020-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/">XML文件与Properites文件解析工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp; &emsp;XML文件与Properties文件在我的Java学习中和以后要接触的框架中十分常见的文件类型。这些文件懂了相关的编写规则后会十分容易写出来，但是作为配置文件如何去用它才是关键。人根据自己要完成的目的编写相关文件，可是你把这个文件放在计算机面前它不懂啊，它只知道01序列。因此，对于这种高频出现的文件，我们有必要编程，编写一个工具来解析它，方便以后使用。我不是直接把相关解析工具代码直接贴出来，而是一步步写关于这个工具如何造出来，这样才能学习更深刻并且里面蕴含的工具思想也能写出来。</p>
<h2 id="XML文件解析工具"><a href="#XML文件解析工具" class="headerlink" title="XML文件解析工具"></a>XML文件解析工具</h2><p>​        XML(Extensible Markup Language)，中文翻译为可扩展标记语言。它可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。（<em>以上摘自百度百科</em>）使用它我们可以很容易的描述复杂的层次数据结构。例如，下面给的一个XML文件简单例子，学生基本信息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">students</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">student</span> <span class="attr">name</span>= <span class="string">"张三"</span> <span class="attr">id</span>= <span class="string">"20203035"</span> <span class="attr">sex</span>= <span class="string">"男"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hobbies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>打游戏<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>篮球<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>学习<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">hobbies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">student</span> <span class="attr">name</span>= <span class="string">"李四"</span> <span class="attr">id</span>= <span class="string">"20203036"</span> <span class="attr">sex</span>= <span class="string">"男"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hobbies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>足球<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>写作<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>摄影<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">hobbies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">student</span> <span class="attr">name</span>= <span class="string">"王五"</span> <span class="attr">id</span>= <span class="string">"20203037"</span> <span class="attr">sex</span>= <span class="string">"女"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hobbies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>购物<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>逛街<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>羽毛球<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">hobbies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">students</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        只是个简单的学生信息XML文件。对XML文件稍有了解，知道&lt;&gt;&lt;/&gt;是标签，标签里面带着的叫做属性。分析上面XML文件知，根标签是students(根标签必须有)，下一个标签student，其中有三个属性(name, id, sex)，下一个标签是hobbies，然后下一个标签是hobby。看到这个XML文件有没有觉得它特别像树形结构。因此，我们使用四种XML解析方式之一的DOM解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">			InputStream is = Test.class.getResourceAsStream("/studentInfo.xml");</span><br><span class="line">			<span class="comment">//这里是用当前类的class.getResourceAsStream。参数是相对路径。</span></span><br><span class="line">			Document document = documentBuilder.parse(is);</span><br><span class="line">			<span class="comment">//前面四句话是不是看的一头雾水？我最初学也是，这里没必要刨根问底，当作巫师的咒语吧！</span></span><br><span class="line">			</span><br><span class="line">			NodeList studentList = document.getElementsByTagName(<span class="string">"student"</span>);</span><br><span class="line">            <span class="comment">//根据标签名得到一个结点列表</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; studentList.getLength(); i++) &#123;</span><br><span class="line">				StudentInfo stu = <span class="keyword">new</span> StudentInfo();	</span><br><span class="line">                <span class="comment">//StudentInfo类只是为了最后显示好看。</span></span><br><span class="line">				Element student = (Element) studentList.item(i);</span><br><span class="line">                <span class="comment">//要把Node类型强转为Element类型</span></span><br><span class="line">				String name = student.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">				String id = student.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">				String sex = student.getAttribute(<span class="string">"sex"</span>);</span><br><span class="line">				stu.setId(id);</span><br><span class="line">				stu.setSex(sex);</span><br><span class="line">				stu.setName(name);</span><br><span class="line">				</span><br><span class="line">				NodeList hobbyList = student.getElementsByTagName(<span class="string">"hobby"</span>);</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; hobbyList.getLength(); j++) &#123;</span><br><span class="line">					String hobbyString = hobbyList.item(j).getTextContent();</span><br><span class="line">					stu.addHobby(hobbyString);</span><br><span class="line">				&#125;</span><br><span class="line">				System.out.println(stu);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        关于NodeList，Node，Element这几个类我需要说一下。</p>
<p>​        getElementsByTagName(“标签名”)获得的是个NodeList，没办法强转成Element。但可以遍历这个NodeList，item(index)方法取得相应的一个Node。Node与Element之间有关系。</p>
<p>​        对于一个出现多次的标签(student)，我们获得一个NodeList，遍历它，如果又遇到出现多次的标签(hobby)，再获得一个NodeList，遍历它，如此下去，直到所有标签都被过一遍。</p>
<p>​        总结:NodeList是标签多次出现组成，最终要访问到具体内容还是要提供Element，NodeList与Element之间转换通过Node完成。</p>
<img src="/img/XML/1.png" alt="1" style="zoom: 80%;" />

<p>要用的Model类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String sex;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; hobbies;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">StudentInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		hobbies = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sex;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sex = sex;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHobbies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> hobbies;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addHobby</span><span class="params">(String hobby)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (hobby == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (hobbies.contains(hobby)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		hobbies.add(hobby);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		StringBuffer stu = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">		stu.append(name).append(<span class="string">" "</span>)</span><br><span class="line">			.append(id).append(<span class="string">" "</span>)</span><br><span class="line">			.append(sex).append(<span class="string">" "</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (String hobby : hobbies) &#123;</span><br><span class="line">			stu.append(<span class="string">"\n"</span>).append(<span class="string">"\t"</span>).append(hobby);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> stu.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">张三 <span class="number">20203035</span> 男 </span><br><span class="line">	打游戏</span><br><span class="line">	篮球</span><br><span class="line">	学习</span><br><span class="line">李四 <span class="number">20203036</span> 男 </span><br><span class="line">	足球</span><br><span class="line">	写作</span><br><span class="line">	摄影</span><br><span class="line">王五 <span class="number">20203037</span> 女 </span><br><span class="line">	购物</span><br><span class="line">	逛街</span><br><span class="line">	羽毛球</span><br></pre></td></tr></table></figure>

<p>​        接下来就是制作工具了。所谓工具就是<strong>工具制造者把那些重复的、一成不变的代码提取出来做成工具，而那些会变部分的代码向外提供，由工具使用者去实现</strong>。就比如现在给你的不是这个学生信息XML表了，而换了另一个XML让你解析，再看解析代码，发现for循环上面的都是一成不变的（除了参数），而底下的真正解析过程会随着不同XML变化。</p>
<p>​        以后处理XML文件，在结构上任何XML文件都是相同的。只是在细节上标签名或者属性名有所差别而已。相同之处做成工具，造工具的人只编写XML相同的，结构相似的部分；差别之处拎出来提供给外面，让工具使用者去完成。</p>
<h3 id="XMLParse工具类"><a href="#XMLParse工具类" class="headerlink" title="XMLParse工具类"></a>XMLParse工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLParse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DocumentBuilderFactory dbf;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> DocumentBuilder db;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			db = dbf.newDocumentBuilder();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XMLParse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">getDocument</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">		Document document = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			document = db.parse(is);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> document;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">getDocument</span><span class="params">(String xmlPath)</span> </span>&#123;</span><br><span class="line">		InputStream is = XMLParse<span class="class">.<span class="keyword">class</span>.<span class="title">getResourceAsStream</span>(<span class="title">xmlPath</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"xmlPath["</span> +xmlPath + <span class="string">"不存在"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getDocument(is);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*getElementsByTagName写了两次，但两次前缀不一样，一个是doucument,一个是element类型的,覆盖就行了*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTag</span><span class="params">(Document document, String tagName)</span> </span>&#123;</span><br><span class="line">		NodeList nodeList = document.getElementsByTagName(tagName);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; nodeList.getLength(); index++) &#123;	</span><br><span class="line">			Element element = (Element) nodeList.item(index);	</span><br><span class="line">            <span class="comment">//底下的内容不同的xml解析不尽相同,工具写到这没法写了。</span></span><br><span class="line">			dealElement(element, index);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTag</span><span class="params">(Element element, String tagName)</span> </span>&#123;</span><br><span class="line">		NodeList nodeList = element.getElementsByTagName(tagName);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; nodeList.getLength(); index++) &#123;	</span><br><span class="line">			Element ele = (Element) nodeList.item(index);	</span><br><span class="line">            <span class="comment">//底下的内容不同的xml解析不尽相同,工具写到这没法写了。</span></span><br><span class="line">			<span class="comment">//后面对ele进一步解析：取属性，取textContent或进一步取Element都应该是未来的工具使用者操心的事，我要做的仅仅是是把ele交给对方</span></span><br><span class="line">			dealElement(ele, index);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span></span>;	</span><br><span class="line">    <span class="comment">//这个index让用户知道处理到第几项都能知道</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XML文件解析工具就写出来了。还是那句话将那些已经确定了的代码写好，对于以后操作者如何去用我不管，我也管不着，所以将它传给外面，尽量将有用的信息都传出去，因为这样使用工具的人才能多一些机会做自己的操作。</p>
<p>如何去用这个工具下面给个例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;		<span class="comment">//直接用匿名内部类去使用，方便快捷。</span></span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;<span class="comment">//循环都不用写了，因为这句话就在循环里</span></span><br><span class="line">				StudentInfo stu = <span class="keyword">new</span> StudentInfo();</span><br><span class="line">				String name = element.getAttribute(<span class="string">"name"</span>);	<span class="comment">//此时这个element就是标签student</span></span><br><span class="line">				String id = element.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">				String sex = element.getAttribute(<span class="string">"sex"</span>);</span><br><span class="line">				stu.setId(id);</span><br><span class="line">				stu.setSex(sex);</span><br><span class="line">				stu.setName(name);</span><br><span class="line">				<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//始终记得的这个是在循环里</span></span><br><span class="line">						<span class="comment">//可直接再使用匿名内部类解析下一个标签。也可以新建方法解析把这层提出去，这样可读性更强，且不会造成代码逻辑混乱。</span></span><br><span class="line">						String hobbyString = element.getTextContent();</span><br><span class="line">						stu.addHobby(hobbyString);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;.parseTag(element, <span class="string">"hobby"</span>);</span><br><span class="line">				System.out.println(stu);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(XMLParse.getDocument(<span class="string">"/studentInfo.xml"</span>), <span class="string">"student"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Properties文件解析工具"><a href="#Properties文件解析工具" class="headerlink" title="Properties文件解析工具"></a>Properties文件解析工具</h2><p>​        Properties文件就十分简单了，它的格式主要是以key-value键值对的形式存储，所以它的工具类就十分好建立了。既然是个键值对，就放在Map数据结构中，要遵循Map的规则（键值最好不要重复）。</p>
<p>​        下面给个简单的properties文件例子，该例子是我连接数据库的相关配置。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/mec_javase_201910?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p>其工具类因为它是键值对形式，所以放在一个大池子里，解析一个就放进去一个，想用就从池子取。</p>
<h3 id="PropertiesParse工具类"><a href="#PropertiesParse工具类" class="headerlink" title="PropertiesParse工具类"></a>PropertiesParse工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProperitiesParse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; pool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		pool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadProperities</span><span class="params">(String configFilePath)</span> </span>&#123;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(configFilePath));</span><br><span class="line">			loadding(<span class="keyword">new</span> InputStreamReader(is, <span class="string">"utf-8"</span>));</span><br><span class="line">            <span class="comment">//这里是有关编码格式的问题，不必深究，尽量使用utf-8格式。</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadding</span><span class="params">(InputStreamReader is)</span> </span>&#123;</span><br><span class="line">		Properties property = <span class="keyword">new</span> Properties();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			property.load(is);</span><br><span class="line">			Enumeration&lt;Object&gt;keys = property.keys();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">while</span>(keys.hasMoreElements()) &#123;</span><br><span class="line">				String key = (String) keys.nextElement();</span><br><span class="line">				String value = property.getProperty(key);</span><br><span class="line">				pool.put(key, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">keySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pool.keySet();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">value</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pool.get(key);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何使用和演示结果也很简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoropertiesTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		ProperitiesParse.loadProperities(<span class="string">"E:\\A大三\\大三上\\JavaProject\\20200306@XMLParse@PropertiesParse\\src\\connection.properties"</span>);</span><br><span class="line">        <span class="comment">//这里要跟绝对路径</span></span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"driver"</span>));</span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"url"</span>));</span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"user"</span>));</span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"password"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">演示结果</span></span><br><span class="line"><span class="comment">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment">jdbc:mysql://localhost:3306/mec_javase_201910?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br><span class="line"><span class="comment">root</span></span><br><span class="line"><span class="comment">123456</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h3 id="Properties文件解析乱码问题"><a href="#Properties文件解析乱码问题" class="headerlink" title="Properties文件解析乱码问题"></a>Properties文件解析乱码问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesParse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; pool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		pool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadding</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(is, <span class="string">"utf-8"</span>);</span><br><span class="line">			properties.load(isr);</span><br><span class="line">			Enumeration&lt;Object&gt; keys = properties.keys();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">while</span> (keys.hasMoreElements()) &#123;</span><br><span class="line">				String key = (String) keys.nextElement();</span><br><span class="line">				String value = properties.getProperty(key);</span><br><span class="line">				pool.put(key, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadCfgPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		InputStream is = PropertiesParse<span class="class">.<span class="keyword">class</span>.<span class="title">getResourceAsStream</span>(<span class="title">path</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"Path["</span> +path + <span class="string">"不存在"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		loadding(is);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadCfgAbsolutePath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(path));</span><br><span class="line">			loadding(is);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">value</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pool.get(key);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">getKeySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pool.keySet();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>乱码问题很有可能是输入流为其他格式的流的原因，解决方法强制转为utf-8流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(is, <span class="string">"utf-8"</span>);</span><br></pre></td></tr></table></figure>





<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​        至此，两个常用文件的简单解析工具就完成了。XML解析工具工具思想多一些，可以着重看也可以跟着敲一遍，才能收获更深。</p>
<p>//TODO 传文件至github上！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/" data-id="ckf2hi5jx000a38i21nwu8ik2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/13/20200913@swing/">20200913@swing</a>
          </li>
        
          <li>
            <a href="/2020/09/11/20200911@%E6%8E%A5%E5%8F%A3@%E6%8E%92%E5%BA%8F/">20200911@接口@排序</a>
          </li>
        
          <li>
            <a href="/2020/04/08/20200408@%E6%A8%A1%E6%8B%9F%E7%AE%80%E6%98%93Spring/">20200408@模拟简易Spring</a>
          </li>
        
          <li>
            <a href="/2020/04/05/20200405@%E5%AE%9A%E6%97%B6%E5%99%A8@%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6@%E5%8C%85%E6%89%AB%E6%8F%8F/">20200405@定时器@代理机制@包扫描</a>
          </li>
        
          <li>
            <a href="/2020/04/03/20200403@%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5@BS@%E5%BA%95%E5%B1%82%E9%80%9A%E4%BF%A1%E4%BF%A1%E6%81%AF@%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C@Communication%E5%88%9D%E6%AD%A5/">20200403@淘汰策略@BS@底层通信信息@文件操作@Communication初步</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 HonorZmj98<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>