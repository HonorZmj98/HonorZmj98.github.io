<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://honorzmj98.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="HonorZmj98">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://HonorZmj98.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-CSFramework小型开发工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-03-17T06:48:00.000Z" itemprop="datePublished">2020-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">CSFramework小型开发工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;我们在计算机网络课程中学过网络的OSI的七层模型，但只是理解其描述的一些概念，并没有真正的实现，只是个概念性框架。而另一种提出的TCP/IP参考模型被投入应用了。参考前两种层次模型，我们可以提出CSFramework使用的层次模型，如下图。</p>
<img src="/img/CSFramework/2.png" alt="2" style="zoom: 67%;" />

<p>&emsp;&emsp;首先是最底层<font color= red><strong>通信层</strong>（Communication）</font>，该层只关心最底层通信的事和对端异常掉线问题，但不关心接收到的相关信息该如何处理。信息的处理不在这一层，这一层没有权利处理信息，只是将信息发给对端的作用。</p>
<p>&emsp;&emsp;下来是<font color= red><strong>会话层</strong>（Conversation）</font>,该层会收到来自下层的包装好的信息（协议），根据信息的内容去处理信息。该层可以看出对等层的概念，ServerConversation和ClientConversation之间的交锋。在sever这边看ServerConversation就是客户端，在client这边看ClientConversation就是服务器。</p>
<p>&emsp;&emsp;工具的最后一层是<font color= red><strong>Server层</strong>和<strong>Client层</strong></font>，该层是提供给外面使用的，而下面层都是工具的内部东西，不提供给外面用。所以，层是一步步建立起来的，你虽然只看到最高层用的简单，却不知道底下要有多少层在默默支持着。工具也是这样，最后用户使用的十分方便，可工具制造者才能直到建立的艰辛。<em>“辛苦我一人，幸福千万家！”</em>工具制造者最终的追求。话题扯远了，因为是CSFramework的最后一层，那就要包括CS一些普遍且必要的一些内容。例如，服务器这边的启动服务器和关闭服务器，客户端那边的连接服务器和下线，单发消息，群发消息等功能。</p>
<p>&emsp;&emsp;再高层称为<font color= red><strong>应用层</strong></font>，该层的实现不管因为会因为不同的APP而不同，所以更高层的开发由CSFramework工具的使用者去完成，就不用关心我底层的实现了。</p>
<p>&emsp;&emsp;先把整体要搭建的框架一说，接下来就开始造我们的工具。<em>友情提示：可能有些类会突兀的出现，先不要纠结于此，因为我把这个代码已经写过好几次了，一步步实现叙述太麻烦了，所以给最终代码，当然期间细节思想会讲的</em></p>
<h2 id="CSFramework"><a href="#CSFramework" class="headerlink" title="CSFramework"></a>CSFramework</h2><h3 id="com-mec-csframework-core包"><a href="#com-mec-csframework-core包" class="headerlink" title="com.mec.csframework.core包"></a>com.mec.csframework.core包</h3><p>第一个肯定是我们最底层且是Server和Client都共有的通信层Communication类，前面也说了，该类只关心信息的传输，因此该层就是建立通信信道和接受发信息的过程。</p>
<h4 id="Communication类（通信层）"><a href="#Communication类（通信层）" class="headerlink" title="Communication类（通信层）"></a>Communication类（通信层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Communication</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//方法几乎都是包权限，因为只在工具中用，工具的保护</span></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communication</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socket = socket;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			goon = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"通信层"</span>).start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span></span>;<span class="comment">//处理对端信息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span></span>;<span class="comment">//对端异常掉线</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				message = dis.readUTF();</span><br><span class="line">				dealPeerMessage(<span class="keyword">new</span> NetMessage(message));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">					peerAbnormalDrop();</span><br><span class="line">				&#125;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dos.writeUTF(message.toString());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在想这么一种情况，我一个客户端要给另一个客户端发送“byebye”消息，该消息被服务器接收到后，服务器误认为它要下线（如上篇博文规定的那样），就去做下线操作了，实际上我们只是想把信息发给另一个客户端，并无下线的意思。因此，我认为如果Communication仅仅只传字符串String类型有点不够，我们应该对网络消息规范化，将网络命令和真正的会话内容区分开了，因此有了NetMessage类。</p>
<h4 id="NetMessage类（传输的网络信息）"><a href="#NetMessage类（传输的网络信息）" class="headerlink" title="NetMessage类（传输的网络信息）"></a>NetMessage类（传输的网络信息）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetMessage</span> </span>&#123;</span><br><span class="line">	<span class="comment">//发送和接受的信息必须是该类对象</span></span><br><span class="line">	<span class="keyword">private</span> ENetCommand command;</span><br><span class="line">	<span class="keyword">private</span> String action;</span><br><span class="line">	<span class="keyword">private</span> String parameter;</span><br><span class="line">	</span><br><span class="line">	NetMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	NetMessage(String message) &#123;<span class="comment">//根据制订的规矩解析</span></span><br><span class="line">		<span class="keyword">int</span> colonIndex = message.indexOf(<span class="string">':'</span>);</span><br><span class="line">		<span class="keyword">this</span>.command = ENetCommand.valueOf(message.substring(<span class="number">0</span>, colonIndex));</span><br><span class="line">		message = message.substring(colonIndex + <span class="number">1</span>);</span><br><span class="line">		colonIndex = message.indexOf(<span class="string">':'</span>);</span><br><span class="line">		String actionStr = message.substring(<span class="number">0</span>, colonIndex).trim();</span><br><span class="line">		<span class="keyword">this</span>.action = (actionStr.length() &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : actionStr);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.parameter = message.substring(colonIndex + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;<span class="comment">//规矩 命令:动作:信息</span></span><br><span class="line">		<span class="keyword">return</span> command + <span class="string">":"</span> + (action == <span class="keyword">null</span> ? <span class="string">" "</span> : action) + <span class="string">":"</span> + parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">ENetCommand <span class="title">getCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> command;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setCommand</span><span class="params">(ENetCommand command)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.command = command;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> action;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setAction</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.action = action;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">NetMessage <span class="title">setParameter</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.parameter = parameter;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传输的信息由command（命令），action（动作，这个以后会用到不必深究），parameter（真正的消息）组成。其中带参构造是解析过程，toString方法是封装一个信息过程。为了表示网络命令的简单，我们可以使用Enum（枚举）。</p>
<h4 id="ENetCommand（枚举命令）"><a href="#ENetCommand（枚举命令）" class="headerlink" title="ENetCommand（枚举命令）"></a>ENetCommand（枚举命令）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ENetCommand &#123;</span><br><span class="line"></span><br><span class="line">	ServerFoeceDown,</span><br><span class="line">	ServerFull,</span><br><span class="line">	WhoAreYou,</span><br><span class="line">	IAm,</span><br><span class="line">	EnsureOnline,</span><br><span class="line">	Offline,</span><br><span class="line">	ToOne,</span><br><span class="line">	ToAll,</span><br><span class="line">	</span><br><span class="line">	Request,</span><br><span class="line">	Response,</span><br><span class="line">	</span><br><span class="line">	ClientAbnormalDrop,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个肯定不是未卜先知就知道所有的命令，这个是最终代码效果。</p>
<p>至此，一个编程手法就出现了。<strong>我通过NetMessage这个类屏蔽了底层真正传输的信息，我只接受NetMessage类的对象的结果。不允许你发任意String。这样约束了你的行为，我的解析变得有章可循。这就叫做<font color= red>协议</font></strong>。</p>
<p>接下来就建立下一层会话层(Conversation)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现它们是继承Communication来的，然后什么都写不了。是呀，你根本没有需求啊，没有需求让他们之间进行交锋，所以当然什么都写不了。那就去建立更高层Client和Server。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>);</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//TODO 做侦听到一个客户端连接要做的事</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里出现了三个接口，有必要解释一下。首先是IDefaultNetConfig</p>
<h4 id="IDefaultNetConfig接口（默认配置）"><a href="#IDefaultNetConfig接口（默认配置）" class="headerlink" title="IDefaultNetConfig接口（默认配置）"></a>IDefaultNetConfig接口（默认配置）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDefaultNetConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> DEFAULT_PORT = <span class="number">54188</span>;		<span class="comment">//默认的端口号</span></span><br><span class="line">	String DEFAULT_SERVER_IP = <span class="string">"127.0.0.1"</span>;	<span class="comment">//默认服务器ip地址，本地地址</span></span><br><span class="line">	<span class="keyword">int</span> DEFAULT_MAX_Client_COUNT = <span class="number">200</span>;	<span class="comment">//默认服务器最大连接数量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单理解是默认的设置，仅仅是本地的一般测试，用户可以使用相关init方法进行修改。</p>
<p>而接下来就是讲一个重要的思想，<font color= red><strong>观察者模式</strong></font>。</p>
<p>我们知道，server有许多信息例如服务器启动、客户端上线等信息是要处理的，很明显我们server工具对于这些信息不能插手，要交给上面APP层去处理，但是APP处理该信息我们做工具的根本不得而知，它可以System.out.println()在控制台输出下，也有可能是命令行模式，还有可能是我们以后写的界面显示一下。所以这么多不确定性该如何操作？这个时候就要使用接口了。让APP层提供一个能够处理在Server层信息的方法，我们Server调用这个方法，而APP具体如何处理信息我们不管，这和我工具Server无关。</p>
<h4 id="IListener接口（倾听者）"><a href="#IListener接口（倾听者）" class="headerlink" title="IListener接口（倾听者）"></a>IListener接口（倾听者）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">processMessage</span><span class="params">(String message)</span></span>;	<span class="comment">//处理消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APP层去实现这个接口，去具体实现如何处理消息</p>
<h4 id="ISpeaker接口（倾诉者）"><a href="#ISpeaker接口（倾诉者）" class="headerlink" title="ISpeaker接口（倾诉者）"></a>ISpeaker接口（倾诉者）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span></span>;		<span class="comment">//添加听众</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span></span>;	<span class="comment">//删除听众</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span></span>;	<span class="comment">//发布消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server实现这个接口，其中方法包括增加听众（IListener的实现类），删除听众（不再倾听就删除），发布消息，向每个听众发送消息，你如何处理是你的事，我反正都发，所有听众都发。</p>
<p>如果你还是不理解我再举个简单例子。ISpeaker相当于一个报社，IListener相当于一个订报纸的人。报社根本不管用户拿到报纸如何读报纸，报社只管增加订报纸的人，删除退订的人，和向每个订了报纸的人送报纸。而订报纸的用户处理得到的报纸信息，各自有各自的处理办法。</p>
<p>这就是<em>观察者模式</em>。</p>
<p>好，接下来继续写Server层。我们做到了侦听到一个客户端（Socket），接下来该怎么做？该client是Client层那个吗？不是的，服务器和客户端是分别开发的，Server层这边根本没有任何Client层的东西，再看最开始的结构图，Server与Client进行通信必须向下经过Conversation层，因此应该用这个client去实例化个serverConversation，正如我前面所说的Conversation是对等层，在Server这边看serverConversation就是一个客户端。同时，我们在此提个疑问，难道侦听到一个连接就真的是一个正常的客户端吗？如果这个客户端连接上服务器，半天不说话，就会占用相关有效资源。假如有很多这种“僵尸机”，服务器的性能将会大打折扣。所以我们要准备两个客户端池，一个是真正有效的用户连接池，一个是临时的用户连接池，够不够资格当我的有效用户，要经过我服务器的测试才可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>);</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;	<span class="comment">//TODO</span></span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//TODO 通知所有在线客户端要强制宕机了</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//TODO 通知该客户端服务器爆满</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">//TODO 先加到tempClientList中，符合条件再说</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到Server多了两个类ClientPool和TemporaryClientList。</p>
<h4 id="ClientPool类（客户端连接池）"><a href="#ClientPool类（客户端连接池）" class="headerlink" title="ClientPool类（客户端连接池）"></a>ClientPool类（客户端连接池）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, ServerConversation&gt; clientPool;</span><br><span class="line">	</span><br><span class="line">	ClientPool() &#123;</span><br><span class="line">		clientPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientPool.isEmpty();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientPool.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientPool.keySet().contains(serverConversation.getId())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientPool.put(serverConversation.getId(), serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.keySet().contains(serverConversation.getId())) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientPool.remove(serverConversation.getId());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">ServerConversation <span class="title">getClientById</span><span class="params">(String id)</span> </span>&#123;	<span class="comment">//得到某个特定的client，单发</span></span><br><span class="line">		<span class="keyword">if</span> (!clientPool.keySet().contains(id)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> clientPool.get(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;ServerConversation&gt; <span class="title">getClientListExceptId</span><span class="params">(String id)</span> </span>&#123;	<span class="comment">//得到除了某个的所有client，群发</span></span><br><span class="line">		List&lt;ServerConversation&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (String key : clientPool.keySet()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (key.equals(id)) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			result.add(clientPool.get(key));</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;ServerConversation&gt; <span class="title">getAllClient</span><span class="params">()</span> </span>&#123;	<span class="comment">//得到所有client</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> getClientListExceptId(<span class="keyword">null</span>);	<span class="comment">//只要调用上面方法传个绝不存在的键就行了</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>id是区分ServerConversation的键值，这个id如何来等下讲。</p>
<h4 id="TemporaryClientList类（临时客户端连接）"><a href="#TemporaryClientList类（临时客户端连接）" class="headerlink" title="TemporaryClientList类（临时客户端连接）"></a>TemporaryClientList类（临时客户端连接）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemporaryClientList</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;ServerConversation&gt; tempClientList;</span><br><span class="line">	</span><br><span class="line">	TemporaryClientList() &#123;</span><br><span class="line">		tempClientList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tempClientList.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (tempClientList.contains(serverConversation)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		tempClientList.add(serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeClient</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!tempClientList.contains(serverConversation)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		tempClientList.remove(serverConversation);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TemporaryClientList设置为LinkedList是因为在此徘徊进入的客户端很多所以用链表比数组好一点。</p>
<p>这两个类完全体现了<em>Java面对对象思想</em>里的分而治之，化繁为简的思想。ClientPool和TemporaryClientList的核心是里面的成员，所有方法都是围绕成员走的，相对纯粹，且逻辑不深，仅仅add和remove等操作，把它单独拿出来做一个类。</p>
<p><strong>核心思想：小部件做好经过测试，组成一个大部件，该部件一定是成功的</strong></p>
<p>因为有了客户端连接池，所以宕机的时候如果还有在线的用户则不能宕机。同时增加个强制宕机的方法。</p>
<p>好了，现在所有的TODO都是通信方面的问题了，这个我们先别着急，先去把Client层完善下，其实我在在做这个类的时候，也是许多类之间的跨越，所以自己一定要清晰该做什么，沿着主干去做。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到Client目前很简单就是一些初始化和最重要的连接服务器。现在想这样一种情况，连接服务器可能失败（服务器没开或者未找到相应服务器），失败后要提醒用户并且询问用户是否继续连接。同时还有许多用户操作例如服务器强制宕机、服务器爆满、服务器异常掉线，这些一定是会发生的事，我们可以在底层捕获到信息，但是没有权力处理他，处理权力只能在APP层。对于这种能够预知到要发生的事，但不能实现且完成，我们还是用<font color= red><strong>接口</strong></font>。</p>
<h4 id="IClientAction接口（客户端可能触发的行为）"><a href="#IClientAction接口（客户端可能触发的行为）" class="headerlink" title="IClientAction接口（客户端可能触发的行为）"></a>IClientAction接口（客户端可能触发的行为）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IClientAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">afterOnline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnormalDrop</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">beforeOffline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">confirmOffline</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">afterOffline</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String sourceId, String message)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String sourceId, String message)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">otherClientDrop</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述还是最终代码，不必在意为什么一下能写这么多。和它相关的两个辅助类异常和适配器。</p>
<h4 id="ClientActionNotSetException类（用户行为未设置异常）"><a href="#ClientActionNotSetException类（用户行为未设置异常）" class="headerlink" title="ClientActionNotSetException类（用户行为未设置异常）"></a>ClientActionNotSetException类（用户行为未设置异常）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActionNotSetException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5752188492855205231L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientActionNotSetException</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientActionAdapter类（用户行为适配器）"><a href="#ClientActionAdapter类（用户行为适配器）" class="headerlink" title="ClientActionAdapter类（用户行为适配器）"></a>ClientActionAdapter类（用户行为适配器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActionAdapter</span> <span class="keyword">implements</span> <span class="title">IClientAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serverAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">confirmOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String sourceId, String message)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String sourceId, String message)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeOffline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">otherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientActionNotSetException异常类是为了规定用户对ClientAction进行设置，ClientActionAdapter适配器类就和界面部分的适配器一样，不同的时候要用不同的方法。</p>
<p>接下来就可以根据IClientAction去完善Client。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client基本设置就完成了。现在就是完成基本通信的问题了。可以看回Server类的三个TODO。接下来就是Server、ServerConversation、Client、ClientConversation之间的来回频繁切换了。始终记得Conversation收发会话信息，最终操作到Server或者Client。</p>
<ul>
<li><p>通知所有在线客户端强制宕机：得到所有在线用户相关的的ServerConversation，发送ENetCommand.ServerFoeceDown会话信息，ClientConversation接收到此信息，去做用户规定的服务器强制关闭的行为。</p>
</li>
<li><p>通知客户端服务器爆满：发送ENetCommand.ServerFull会话信息，ClientConversation接收到此信息，去做服务器满相关行为。</p>
</li>
<li><p>上线这个过程要好好说一下。此时情形是这个客户端（serverConversation）存在在临时连接里，还未加到真正的用户池里，目的是为了防止“僵尸主机”。到后期我们可以使用一个计时器如果不通信就踢出去。现在考虑真正的有效用户。服务器首先发送会话信息ENetCommand.WhoAreYou，clientConversation收到该信息，并返回发送信息ENetCommand.IAm且是带参的，参数是什么呢？在网络中标识各个主机的是ip地址，所以参数是ip地址。serverConversation收到消息，根据ip来创造id值，注意id是用在clientPool里的，因此要不能重复，ip可能重复呀，一个主机多次登陆怎么办，所以我们要找个一直在变的东西，现实生活中有这个东西，就是<font color= red><strong>时间</strong></font>。所以id就是ip + ：+当前时间组合而成的。clientconversation收到后设置下自己的id，以便和服务器一致。同时去做上线成功后的操作。</p>
</li>
<li><p>还有就是对端异常掉线问题。客户端这边服务器异常掉线具体操作不是工具应该考虑的，所以还是用clientAction。服务器这里客户端异常掉线，除了从用户池中删除。还要通知其他在线客户端有异常掉线的，会话信息是ENetCommand.ClientAbnormalDrop，参数是异常掉线客户端id的值。clientConversation这里接收到，上传到client层由clientAction去完成。</p>
</li>
<li><p>还有就是客户端正常下线的问题了。这个请求是由客户端提出来的，因此加下线操作。clientAction里的confirmOffline()可以询问用户是否真的要下线，同时还有下线前操作和下线后操作方便一些资源的回收。下线过程就是clientConversation发送ENetCommand.Offline信息，serverConversation接收到做相应从用户池清除。</p>
<p>Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端[ "</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerConversation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> IAm:</span><br><span class="line">			ensureOnline(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> Offline:</span><br><span class="line">			server.offline(<span class="keyword">this</span>);</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientConversation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> ServerFoeceDown:</span><br><span class="line">			client.serverForcedown();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ServerFull:</span><br><span class="line">			client.serverFull();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WhoAreYou:</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EnsureOnline:</span><br><span class="line">			<span class="keyword">this</span>.id = parameter;</span><br><span class="line">			client.ensureOnline();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ClientAbnormalDrop:</span><br><span class="line">			client.dealOtherClientDrop(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*不完整的*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>上述代码仅仅只是完成了服务器和客户端最基础的操作，例如上线下线。现在我们就要考虑更为重要的功能了。单聊和群聊，这是以后开发出来的APP的共有特性。例如聊天室的私聊和群聊。棋牌室的向大家展示牌。</p>
<p>私聊（toOne）和群聊（toAll）传递的信息都有个特性，都有源id（谁发送的），目标id（谁接收的）和真正发的信息组成的。因此，根据分而治之，我们在做一个类。</p>
<h4 id="InteractiveMessage类（交互信息）"><a href="#InteractiveMessage类（交互信息）" class="headerlink" title="InteractiveMessage类（交互信息）"></a>InteractiveMessage类（交互信息）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InteractiveMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String sourceId;</span><br><span class="line">	<span class="keyword">private</span> String targetId;</span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line">	</span><br><span class="line">	InteractiveMessage() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	InteractiveMessage(String sourceId, String targetId, String message) &#123;</span><br><span class="line">		<span class="keyword">this</span>.sourceId = sourceId;</span><br><span class="line">		<span class="keyword">this</span>.targetId = targetId;</span><br><span class="line">		<span class="keyword">this</span>.message = message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getSourceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sourceId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setSourceId</span><span class="params">(String sourceId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sourceId = sourceId;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getTargetId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> targetId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setTargetId</span><span class="params">(String targetId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.targetId = targetId;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">InteractiveMessage <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.message = message;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"from "</span> + sourceId + <span class="string">"to "</span> + targetId + <span class="string">":"</span> + message;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们知道我们在Communcation层传递真正的信息是String类型的，可不是现在写出的InteractiveMessage类，如何将对象变为字符串呢？以后对端得到字符串又可以转换回成相应的对象呢？这就需要大名鼎鼎的<font color= red><strong>Gson</strong></font>了。</p>
<ul>
<li>私聊过程：首先是由Client提出来的，参数是目标id和要发的信息，通过clientConversation将相应的交互信息通过Gson发送过去，服务器得到相应的字符串，再用Gson得到发送的对象的id，从用户池中得到相应的serverConversation，在发回给相应的客户端，相应的客户端有clientAction有专门的dealToOne。</li>
<li>群聊过程：和上述类似，不过改变时服务器得到除了发送者的所有其他serverConversation进行。</li>
</ul>
<p>现在就有个问题了，Gson那么好用，为什么底层NetMessage不用Gson呢？原因是：Gson将对象变为字符串，将字符串变为对象，一定有许多操作，而我们底层希望速度快，下标定位比Gson快。</p>
<h4 id="Server类（服务器层）"><a href="#Server类（服务器层）" class="headerlink" title="Server类（服务器层）"></a>Server类（服务器层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String targetId = interactiveMessage.getTargetId();</span><br><span class="line">		ServerConversation serverConversation = clientPool.getClientById(targetId);</span><br><span class="line">		<span class="keyword">if</span> (serverConversation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			serverConversation.toOne(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;ServerConversation&gt; serverConversations = clientPool.getClientListExceptId(interactiveMessage.getSourceId());</span><br><span class="line">		<span class="keyword">if</span> (serverConversations == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : serverConversations) &#123;</span><br><span class="line">			serverConversation.toAll(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerConversation类（服务器端会话层）"><a href="#ServerConversation类（服务器端会话层）" class="headerlink" title="ServerConversation类（服务器端会话层）"></a>ServerConversation类（服务器端会话层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> IAm:</span><br><span class="line">			ensureOnline(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> Offline:</span><br><span class="line">			server.offline(<span class="keyword">this</span>);</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToOne:</span><br><span class="line">			server.toOne(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToAll:</span><br><span class="line">			server.toAll(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientConversation类（客户端会话层）"><a href="#ClientConversation类（客户端会话层）" class="headerlink" title="ClientConversation类（客户端会话层）"></a>ClientConversation类（客户端会话层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">switch</span> (command) &#123;</span><br><span class="line">		<span class="keyword">case</span> ServerFoeceDown:</span><br><span class="line">			client.serverForcedown();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ServerFull:</span><br><span class="line">			client.serverFull();</span><br><span class="line">			close();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WhoAreYou:</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EnsureOnline:</span><br><span class="line">			<span class="keyword">this</span>.id = parameter;</span><br><span class="line">			client.ensureOnline();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ClientAbnormalDrop:</span><br><span class="line">			client.dealOtherClientDrop(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToOne:</span><br><span class="line">			client.dealToOne(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ToAll:</span><br><span class="line">			client.dealToAll(parameter);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), targetId, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), <span class="keyword">null</span>, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client类（客户端）"><a href="#Client类（客户端）" class="headerlink" title="Client类（客户端）"></a>Client类（客户端）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toOne(targetId, message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToOne(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toAll(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToAll(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做到现在，我们已经完成了客户端基本的上线下线和最简单的私聊和群聊。但是在验证客户端登陆的时候，这个问题没有解决。所谓用户登陆，是用户将账号和密码输入后，需要传给服务器这些信息，然后服务器再在数据库中查询，并返回客户端相应的数据。</p>
<p>那么，该如何完成呢？可能会想在ENetCommand里再加新的命令UserLogin，这样当然可以解决问题，但是如果这样做以后客户端有许许多多的要在服务器端完成的操作，那就需要在ENetCommand加更多命令了。但是首先ENetCommand是我们工具的内部东西，你怎么让使用工具的人往里面加东西呢？其次ENetCommand可以增加的话，那里面所有的东西都需要增加东西了，再次强调我们做的是工具，工具内部不提供给外面！因此，<font color= red><strong>我们只打算给APP层提供一个开发框架，不能照顾到所有APP层实现的功能，对于这些功能，我们只能提供APP层实现相关功能的途径。</strong></font></p>
<p>结局方法在NetMessage里的action里。以前写的命令，都是C（客户端）给其他C发消息，但并没有返回给自己的情况，现在有了。C向S（服务端）发送请求并且希望得到回复。我们统一称为C向S发的是<font color= red>Request</font>，S获取到这个请求获取数据进行一系列操作，再给C返回结果称为<font color= red>Response</font>。</p>
<p>Client加sendRequest(String action, String parameter)方法，经过ClientConversation传到ServerConversation，然后问题来了，服务器收到这个该如何操作？仿照IClientAction写个IServerAction吗？提供给外面让其实现？里面是switch case case下去？那么要写几万个？每一个个要写几万行？每一个都是一个MVC模式，这样不行。我们再仔细考虑下，这些Request不都大同小异吗？都是S获得Request里面的数据，进行一系列操作，并返回一个东西给C。所以我可不可以让他自动执行？只要配置好相关XML文件。因此，想要自动完成要做以下三件事。</p>
<ul>
<li>APP层发送请求。例如：client.sendRequest(“userLogin”, 参数)。</li>
<li>在APP层的userAction写相关方法</li>
<li>配置相关XML文件</li>
</ul>
<p>相关XML文件格式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>= <span class="string">"userLogin"</span> <span class="attr">class</span>= <span class="string">"com.mec.test.server.user.action.UserAction"</span> <span class="attr">method</span>=<span class="string">"userLogin"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>= <span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>= <span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签action里的属性name是这个action的名字，就是sendRequest里参数的名字；class是完成这个action方法的包名称，method完成这个action的方法名称。标签parameter是方法的参数，name是参数名称，type是参数类型（八大基本类型直接写，其他类型带包名称）。</p>
<p>当然这里只写了一个action，随着APP开发功能的丰富，会不断增加的，并且这个不是在工具内部是可以随后任意按规则增加的XML文件。</p>
<p>难道每遇见一次action，就去解析一次XML吗？解析是外存操作，浪费时间，能不能一次解析。再分析XML文件，我们可以让action的属性name作为key键，后面其他部分都为value值。</p>
<h3 id="com-mec-csframework-action"><a href="#com-mec-csframework-action" class="headerlink" title="com.mec.csframework.action"></a>com.mec.csframework.action</h3><h4 id="ActionBeanDefinition类"><a href="#ActionBeanDefinition类" class="headerlink" title="ActionBeanDefinition类"></a>ActionBeanDefinition类</h4><p>简简单单描述value具体是由哪些组成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBeanDefinition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	<span class="keyword">private</span> Method method;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; parameterNameList;</span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionBeanDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		parameterNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		index = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getParameterNameListSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList.size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> hasNext = index &lt; parameterNameList.size();</span><br><span class="line">		<span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">			index = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> hasNext;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList.get(index++);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; getKlass() &#123;</span><br><span class="line">		<span class="keyword">return</span> klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setKlass</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.klass = klass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Method <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> method;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.method = method;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addParameterName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		parameterNameList.add(name);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">List&lt;String&gt; <span class="title">getParameterNameList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameterNameList;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> klass + <span class="string">"\n\t"</span> + method;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActionBeanFactory类"><a href="#ActionBeanFactory类" class="headerlink" title="ActionBeanFactory类"></a>ActionBeanFactory类</h4><p>扫描XML任务，将所有扫面到的有效的action放进池子里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ActionBeanDefinition&gt; actionPool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		actionPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> ActionBeanDefinition <span class="title">getActionBeanDefinition</span><span class="params">(String actionName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> actionPool.get(actionName);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setObject</span><span class="params">(String action, Object object)</span> </span>&#123;</span><br><span class="line">		ActionBeanDefinition abd = actionPool.get(action);</span><br><span class="line">		<span class="keyword">if</span> (abd != <span class="keyword">null</span> &amp;&amp; abd.getObject() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			abd.setObject(object);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanActionMappingXMLPath</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		scanActionMappingXMLPath(<span class="string">"/actionMapping.xml"</span>);	<span class="comment">//默认扫描位置</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanActionMappingXMLPath</span><span class="params">(String xmlPath)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Document document = XMLParse.getDocument(xmlPath);</span><br><span class="line">		<span class="keyword">if</span> (document == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"配置文件不对"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String actionName = element.getAttribute(<span class="string">"actionName"</span>);</span><br><span class="line">				String className = element.getAttribute(<span class="string">"className"</span>);</span><br><span class="line">				String methodName =element.getAttribute(<span class="string">"methodName"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Class&lt;?&gt; klass = Class.forName(className);</span><br><span class="line">					ActionBeanDefinition actionBeanDefinition = <span class="keyword">new</span> ActionBeanDefinition();</span><br><span class="line">					actionBeanDefinition.setKlass(klass);</span><br><span class="line">					setMethod(element, klass, methodName, actionBeanDefinition);</span><br><span class="line">					actionPool.put(actionName, actionBeanDefinition);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(document, <span class="string">"action"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(Element element, Class&lt;?&gt; klass, String methodName, ActionBeanDefinition abd)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException </span>&#123;</span><br><span class="line">		List&lt;String&gt; parameterTypeNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String parameterName = element.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">				String typeName = element.getAttribute(<span class="string">"type"</span>);</span><br><span class="line">				abd.addParameterName(parameterName);</span><br><span class="line">				parameterTypeNameList.add(typeName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(element, <span class="string">"parameter"</span>);</span><br><span class="line">		<span class="keyword">int</span> parameterCount = parameterTypeNameList.size();</span><br><span class="line">		Class&lt;?&gt;[] parameterTypeArray = parameterCount &lt;=<span class="number">0</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Class&lt;?&gt;[parameterCount];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterCount; i++) &#123;</span><br><span class="line">			parameterTypeArray[i] = MecType.toType(parameterTypeNameList.get(i));</span><br><span class="line">		&#125;</span><br><span class="line">		Method method = klass.getMethod(methodName, parameterTypeArray);</span><br><span class="line">		abd.setMethod(method);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中XML解析工具，可以在以前写的博文查看到。还有一个类MecType。</p>
<h4 id="MecType类（工具包中的）"><a href="#MecType类（工具包中的）" class="headerlink" title="MecType类（工具包中的）"></a>MecType类（工具包中的）</h4><p>将字符串类型的String、int、boolean变为真正的类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MecType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MecType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; toType(String typeName) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"string"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> String<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"int"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"char"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">char</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"boolean"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"double"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">double</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"float"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">float</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"long"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">long</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"byte"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">byte</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (typeName.equalsIgnoreCase(<span class="string">"short"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">short</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> Class.forName(typeName);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="IActionProcessor接口（处理器接口）"><a href="#IActionProcessor接口（处理器接口）" class="headerlink" title="IActionProcessor接口（处理器接口）"></a>IActionProcessor接口（处理器接口）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IActionProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">dealRequest</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActionProcessorNotFound类（处理器未设置异常）"><a href="#ActionProcessorNotFound类（处理器未设置异常）" class="headerlink" title="ActionProcessorNotFound类（处理器未设置异常）"></a>ActionProcessorNotFound类（处理器未设置异常）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionProcessorNotFound</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">108844566290027953L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ActionProcessorNotFound</span><span class="params">(String message, Throwable cause, <span class="keyword">boolean</span> enableSuppression,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> writableStackTrace)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DefaultActionProcessor类（默认处理器）"><a href="#DefaultActionProcessor类（默认处理器）" class="headerlink" title="DefaultActionProcessor类（默认处理器）"></a>DefaultActionProcessor类（默认处理器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultActionProcessor</span> <span class="keyword">implements</span> <span class="title">IActionProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">dealRequest</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound </span>&#123;</span><br><span class="line">		ActionBeanDefinition actionBeanDefinition = ActionBeanFactory.getActionBeanDefinition(action);</span><br><span class="line">		<span class="keyword">if</span> (actionBeanDefinition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ActionProcessorNotFound(<span class="string">"未找到对应处理器"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object object = actionBeanDefinition.getObject();</span><br><span class="line">		<span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				object = actionBeanDefinition.getKlass().getConstructor().newInstance();</span><br><span class="line">				actionBeanDefinition.setObject(object);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			Method method = actionBeanDefinition.getMethod();</span><br><span class="line">			ArgumentMaker argumentMaker = <span class="keyword">new</span> ArgumentMaker(parameter);</span><br><span class="line">			<span class="keyword">int</span> size = actionBeanDefinition.getParameterNameListSize();</span><br><span class="line">			Object[] valueList = size &lt;= <span class="number">0</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Object[size];</span><br><span class="line">			<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">			Parameter[] parameters = method.getParameters();</span><br><span class="line">			<span class="keyword">while</span> (actionBeanDefinition.hasNext()) &#123;</span><br><span class="line">				valueList[index] = argumentMaker.getArgumentByName(actionBeanDefinition.next(), parameters[index].getParameterizedType());</span><br><span class="line">				index++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Object result = method.invoke(object, valueList);</span><br><span class="line">				<span class="keyword">return</span> ArgumentMaker.gson.toJson(result);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(String action, String parameter)</span> <span class="keyword">throws</span> ActionProcessorNotFound </span>&#123;</span><br><span class="line">		ActionBeanDefinition abd = ActionBeanFactory.getActionBeanDefinition(action);</span><br><span class="line">		<span class="keyword">if</span> (abd == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ActionProcessorNotFound(<span class="string">"未找到对应处理器"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object object = abd.getObject();</span><br><span class="line">		Method method = abd.getMethod();</span><br><span class="line">		Object[] value = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">		Parameter[] paramters = method.getParameters();</span><br><span class="line">		value[<span class="number">0</span>] = ArgumentMaker.gson.fromJson(parameter, paramters[<span class="number">0</span>].getParameterizedType());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			method.invoke(object, value);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过配置文件的方式，允许用户自己定义自己的类，通过反射机制来处理远端请求，分解出里面的action，根据action，将传过来的参数交给某一个类的方法，并且反射调用执行。</p>
<p><strong>分发器核心：</strong>分析action，找到action相应的处理方法，这就是分发器。</p>
<p>dealRequest方法和dealResponse方法都是为了调用以后APP层上写相关动作的方法，且都是通过反射机制调用执行的。方法的执行需要对象和参数值数组。</p>
<p>对于服务器端需要处理客户的的Request，其有可能有返回值也有可能没有返回值，有返回值的话其返回值类型是千变万化的，根本不能确定。因此又需要借助Gson了，将返回值作为Gson字符串对象，到时候也可以转换回来。</p>
<p>对于客户端要处理来自服务器的Response，且这时候得到服务器返回回来的Gson字符串，有一也且仅有一个。</p>
<p>这时，问题就出现了。</p>
<p>反射机制调用方法，invoke（对象，参数值数组）。问题就出现在参数值数组这里，这里的参数是由用户方法中参数确定的，正因为是用户自定义的，那参数类型就会千奇百怪且数量不定。如何将多个参数揉合在一起，那就要使用容器了List或者Map了。我们知道invoke方法的参数值数组的值顺序必须与方法参数顺序保持一致，所以乍一看使用顺序结构List比较方便，但做到后期发现有问题，Parameter类得到参数名字都是arg0,arg1的。所以还是用Map，键为参数名字，值为参数值，这样对应起来找的话也好找。再把Map对象变为Gson字符串，将Gson字符串在网络间通信，解析的时候再由得到的字符串变回为Map，从Map取各自的值。</p>
<p>但是还是有问题，我们知道Java会有<font color= blue><em>泛型擦除机制</em></font>，对于Map这种带有泛型的容器发送到对端根本不能解析。</p>
<p>幸运的是，办法总是比困难多，在网上找到Gson的高级使用方法——Typetoken。因此下来有了重要的一个类ArgumentMaker。</p>
<h4 id="ArgumentMaker类（工具包中的）"><a href="#ArgumentMaker类（工具包中的）" class="headerlink" title="ArgumentMaker类（工具包中的）"></a>ArgumentMaker类（工具包中的）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; argumentMap;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson gson = <span class="keyword">new</span> GsonBuilder().create();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Type type = <span class="keyword">new</span> TypeToken&lt;Map&lt;String, String&gt;&gt; () &#123;&#125;.getType();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ArgumentMaker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		argumentMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ArgumentMaker</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		argumentMap = gson.fromJson(parameter, type);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getArgumentByName</span><span class="params">(String name, Type type)</span> </span>&#123;</span><br><span class="line">		String json = argumentMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> gson.fromJson(json, type);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getArgumentByName</span><span class="params">(String name, Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">		String json = argumentMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> gson.fromJson(json, klass);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ArgumentMaker <span class="title">add</span><span class="params">(String name, Object value)</span> </span>&#123;</span><br><span class="line">		argumentMap.put(name, gson.toJson(value));</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> gson.toJson(argumentMap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类核心操作都是围绕argumentMap这个成员走的。toString是构造，而带参构造方法则是解析。</p>
<p>总体来说，ArgumentMaker类出现是因为dealRequest和dealResponse的parameter参数会很复杂，如何将众多参数做成一个合起来的。发现参数有K、V关系。K：参数名，V：参数值。做成一个Map，再将Map进行Gson化，但是有泛型擦除机制，要借助Gson高级用法TypeToken。就这样一个工具产生了。</p>
<p>至此，CSFramework工具的所有类基本都介绍完了。</p>
<p>关于优化，不知道大家怎么感觉switch语句那里。反正个人觉得挺恶心的，写的有点长一个屏幕看不完，并且还会造成以下问题。</p>
<img src="/img/CSFramework/3.png" alt="3" style="zoom: 67%;" />

<p>我们知道，以后肯定是有很多客户端的，会造成多个线程都在这里停步，一个个进行switch的比对，或者这样说<strong>多进一出</strong>。这肯定会对性能造成影响，为了解决这个问题再次采用分发器（分析command，找到command的处理方法）处理。</p>
<h4 id="PeerMessageProcessor类（对端消息处理器）"><a href="#PeerMessageProcessor类（对端消息处理器）" class="headerlink" title="PeerMessageProcessor类（对端消息处理器）"></a>PeerMessageProcessor类（对端消息处理器）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeerMessageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Object object;</span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; klass;</span><br><span class="line">	</span><br><span class="line">	PeerMessageProcessor() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.object = object;</span><br><span class="line">		<span class="keyword">this</span>.klass = object.getClass();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ENetCommand command = message.getCommand();</span><br><span class="line">		String commandStr = command.name();</span><br><span class="line">		String methodName = <span class="string">"deal"</span> + commandStr;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Method method = klass.getDeclaredMethod(methodName, NetMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			method.invoke(object, message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Server类（完整）"><a href="#Server类（完整）" class="headerlink" title="Server类（完整）"></a>Server类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ISpeaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> listeningClient;</span><br><span class="line">	<span class="keyword">private</span> List&lt;IListener&gt; listenerList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maxClientCount;</span><br><span class="line">	<span class="keyword">private</span> ClientPool clientPool;</span><br><span class="line">	<span class="keyword">private</span> TemporaryClientList tempClientList;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		listenerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		maxClientCount = IDefaultNetConfig.DEFAULT_MAX_Client_COUNT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;	<span class="comment">//方便用properties文件对server进行初始化</span></span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.maxClientCount = Integer.valueOf(ProperitiesParse.value(<span class="string">"maxClientCount"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">true</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		publishMessage(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		listeningClient = <span class="keyword">true</span>;</span><br><span class="line">		clientPool = <span class="keyword">new</span> ClientPool();</span><br><span class="line">		tempClientList = <span class="keyword">new</span> TemporaryClientList();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">		publishMessage(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!clientPool.isEmpty()) &#123;</span><br><span class="line">			publishMessage(<span class="string">"尚有客户端在线，不能宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器正常关闭"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listeningClient == <span class="keyword">false</span>) &#123;</span><br><span class="line">			publishMessage(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通知所有在线客户端要强制宕机了</span></span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : allOnlineClient) &#123;</span><br><span class="line">			serverConversation.serverForceDown();</span><br><span class="line">		&#125;</span><br><span class="line">		closeServer();</span><br><span class="line">		publishMessage(<span class="string">"服务器强制宕机成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> listeningClient;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		listeningClient = <span class="keyword">false</span>;</span><br><span class="line">		clientPool = <span class="keyword">null</span>;</span><br><span class="line">		tempClientList = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (listeningClient) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				<span class="comment">//做侦听到一个客户端连接要做的事</span></span><br><span class="line">				ServerConversation serverConversation = <span class="keyword">new</span> ServerConversation(client, <span class="keyword">this</span>);</span><br><span class="line">				<span class="keyword">if</span> (clientPool.getSize() + tempClientList.getSize() &gt;= maxClientCount) &#123;</span><br><span class="line">					<span class="comment">//通知该客户端服务器爆满</span></span><br><span class="line">					serverConversation.serverFull();</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				tempClientList.addClient(serverConversation);</span><br><span class="line">				<span class="comment">// 先加到tempClientList中，符合条件再说</span></span><br><span class="line">				serverConversation.whoAreYou();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				closeServer(); <span class="comment">//侦听客户端都不成功，说明server有问题直接关闭</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.add(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.addClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span>+ serverConversation.getId() +<span class="string">"]成功上线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clientAbnoramlDrop</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		List&lt;ServerConversation&gt; allOnlineClient = clientPool.getAllClient();</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation conversation : allOnlineClient) &#123;</span><br><span class="line">			conversation.noticeAbnormalDrop(serverConversation.getId());</span><br><span class="line">		&#125;</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]异常掉线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">(ServerConversation serverConversation)</span> </span>&#123;</span><br><span class="line">		tempClientList.removeClient(serverConversation);</span><br><span class="line">		clientPool.removeClient(serverConversation);</span><br><span class="line">		publishMessage(<span class="string">"客户端["</span> + serverConversation.getId()	+ <span class="string">"]正常下线"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		String targetId = interactiveMessage.getTargetId();</span><br><span class="line">		ServerConversation serverConversation = clientPool.getClientById(targetId);</span><br><span class="line">		<span class="keyword">if</span> (serverConversation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			serverConversation.toOne(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		List&lt;ServerConversation&gt; serverConversations = clientPool.getClientListExceptId(interactiveMessage.getSourceId());</span><br><span class="line">		<span class="keyword">if</span> (serverConversations == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (ServerConversation serverConversation : serverConversations) &#123;</span><br><span class="line">			serverConversation.toAll(parameter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(IListener listener)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!listenerList.contains(listener)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		listenerList.remove(listener);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (IListener listener : listenerList) &#123;</span><br><span class="line">			listener.processMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServerConversation类（完整）"><a href="#ServerConversation类（完整）" class="headerlink" title="ServerConversation类（完整）"></a>ServerConversation类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> Server server;</span><br><span class="line">	<span class="keyword">private</span> IActionProcessor actionProcessor;</span><br><span class="line">	<span class="keyword">private</span> PeerMessageProcessor peerMessageProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServerConversation</span><span class="params">(Socket socket, Server server)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.server = server;</span><br><span class="line">		peerMessageProcessor = <span class="keyword">new</span> PeerMessageProcessor();</span><br><span class="line">		peerMessageProcessor.setObject(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setActionProcessor</span><span class="params">(IActionProcessor actionProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.actionProcessor = actionProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForceDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFoeceDown));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ServerFull));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">whoAreYou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.WhoAreYou));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		peerMessageProcessor.dealPeerMessage(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealIAm</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		ensureOnline(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOffline</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.offline(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.toOne(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		server.toAll(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealRequest</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		String action = message.getAction();</span><br><span class="line">		<span class="keyword">if</span> (actionProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actionProcessor = <span class="keyword">new</span> DefaultActionProcessor();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String requestResult = actionProcessor.dealRequest(action, parameter);</span><br><span class="line">			sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Response)</span><br><span class="line">					.setAction(action)</span><br><span class="line">					.setParameter(requestResult));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ActionProcessorNotFound e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		server.clientAbnoramlDrop(<span class="keyword">this</span>);</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ip = parameter;</span><br><span class="line">		<span class="keyword">this</span>.id = parameter + <span class="string">":"</span> +System.currentTimeMillis();</span><br><span class="line">		server.ensureOnline(<span class="keyword">this</span>);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.EnsureOnline).setParameter(id));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">noticeAbnormalDrop</span><span class="params">(String abnormalId)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ClientAbnormalDrop).setParameter(abnormalId));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ClientConversation类（完整）"><a href="#ClientConversation类（完整）" class="headerlink" title="ClientConversation类（完整）"></a>ClientConversation类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientConversation</span> <span class="keyword">extends</span> <span class="title">Communication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> IActionProcessor actionProcessor;</span><br><span class="line">	<span class="keyword">private</span> PeerMessageProcessor peerMessageProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientConversation</span><span class="params">(Socket socket, Client client)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(socket);</span><br><span class="line">		<span class="keyword">this</span>.client = client;</span><br><span class="line">		peerMessageProcessor = <span class="keyword">new</span> PeerMessageProcessor();</span><br><span class="line">		peerMessageProcessor.setObject(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setActionProcessor</span><span class="params">(IActionProcessor actionProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.actionProcessor = actionProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		peerMessageProcessor.dealPeerMessage(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealServerFoeceDown</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.serverForcedown();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealServerFull</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.serverFull();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealWhoAreYou</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.IAm).setParameter(client.getIp()));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealEnsureOnline</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = message.getParameter();</span><br><span class="line">		client.ensureOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealClientAbnormalDrop</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealOtherClientDrop(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealToOne(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		client.dealToAll(message.getParameter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealResponse</span><span class="params">(NetMessage message)</span> </span>&#123;</span><br><span class="line">		String action = message.getAction();</span><br><span class="line">		String parameter = message.getParameter();</span><br><span class="line">		<span class="keyword">if</span> (actionProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actionProcessor = <span class="keyword">new</span> DefaultActionProcessor();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			actionProcessor.dealResponse(action, parameter);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ActionProcessorNotFound e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">peerAbnormalDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		client.serverAbnoramlDrop();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Offline));</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), targetId, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToOne)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = <span class="keyword">new</span> InteractiveMessage(<span class="keyword">this</span>.getId(), <span class="keyword">null</span>, message);</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.ToAll)</span><br><span class="line">				.setParameter(ArgumentMaker.gson.toJson(interactiveMessage)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String action, String parameter)</span> </span>&#123;</span><br><span class="line">		sendMessage(<span class="keyword">new</span> NetMessage().setCommand(ENetCommand.Request)</span><br><span class="line">				.setAction(action).setParameter(parameter));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client类（完整）"><a href="#Client类（完整）" class="headerlink" title="Client类（完整）"></a>Client类（完整）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> ClientConversation clientConversation;</span><br><span class="line">	<span class="keyword">private</span> IClientAction clientAction;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Client</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		port = IDefaultNetConfig.DEFAULT_PORT;</span><br><span class="line">		serverIp = IDefaultNetConfig.DEFAULT_SERVER_IP;</span><br><span class="line">		ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initConfig</span><span class="params">(String propertiesAbsolutePath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(propertiesAbsolutePath);</span><br><span class="line">		<span class="keyword">this</span>.port = Integer.valueOf(ProperitiesParse.value(<span class="string">"port"</span>));</span><br><span class="line">		<span class="keyword">this</span>.serverIp = ProperitiesParse.value(<span class="string">"serverIp"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientAction</span><span class="params">(IClientAction clientAction)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.clientAction = clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">IClientAction <span class="title">getClientAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> clientAction;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientActionNotSetException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClientActionNotSetException(<span class="string">"未设置ClientAction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">			clientConversation = <span class="keyword">new</span> ClientConversation(socket, <span class="keyword">this</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (clientAction.confirmOffline() == <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clientAction.beforeOffline();</span><br><span class="line">		clientConversation.offline();</span><br><span class="line">		clientAction.afterOffline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOne</span><span class="params">(String targetId, String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toOne(targetId, message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToOne</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToOne(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toAll</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		clientConversation.toAll(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealToAll</span><span class="params">(String parameter)</span> </span>&#123;</span><br><span class="line">		InteractiveMessage interactiveMessage = ArgumentMaker.gson.fromJson(parameter, InteractiveMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		clientAction.dealToAll(interactiveMessage.getSourceId(), interactiveMessage.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String action, String parameter)</span> </span>&#123;</span><br><span class="line">		clientConversation.sendRequest(action, parameter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverForcedown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverForcedown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverFull();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ensureOnline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.afterOnline();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">serverAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		clientAction.serverAbnormalDrop();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dealOtherClientDrop</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		clientAction.otherClientDrop(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，关于CSFramework的长连接就到此结束了。其中遇到的问题、问题的解决方法和心路历程都在博文里面写了，谢谢阅读。</p>
<p>感谢<strong>铁血教主</strong>的细心指导。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" data-id="ck8bqrj0e0003t4i2fbp17nun" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CSFramework的引出" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" class="article-date">
  <time datetime="2020-03-11T00:36:59.000Z" itemprop="datePublished">2020-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/">CSFramework的引出</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="CSFramework的引出：几个简单的网络通信例子"><a href="#CSFramework的引出：几个简单的网络通信例子" class="headerlink" title="CSFramework的引出：几个简单的网络通信例子"></a>CSFramework的引出：几个简单的网络通信例子</h2><p>&emsp;&emsp;现如今，互联网几乎在我身边随处可见，早已深入我们人类生活中。如今的软件如果没有网络功能，那是很不可思议的事情。(单机游戏都有局域网功能，小时候和朋友联机打的红警就是例子)。许多语言都支持网络编程，我见过C与Java有关网络的程序代码，从中深刻感受到有工具和没工具编代码效率是多么天差地别。就相当于在赛跑，C还在那里造车轮子，Java已经开始用别人给的车开始跑了。<br>&emsp;&emsp;最近一直在学习Java，因此用Java学习网络编程。C/S模式，又称客户端服务器模式。至少用两台计算机来分别充当客户机和服务器角色。C/S模式将应用（对于客户端来说）与服务（对于服务器来说）分离，两边各自开发自己的，两套程序。对于服务器，Java提供一个ServerSocket类来创建服务器，对于客户端，Java提供一个Socket类可以连接服务器。<br>&emsp;&emsp;接下来，就先写三个简单的网络通信的例子（一对一单次通信和一对一多次通信）来熟悉下相关类。</p>
<h3 id="一对一单次通信"><a href="#一对一单次通信" class="headerlink" title="一对一单次通信"></a>一对一单次通信</h3><p>&emsp;&emsp;一对一单次通信：一个服务器和一个客户端单次通信</p>
<p>服务器方代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> port = <span class="number">54188</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"开始启动服务器..."</span>);</span><br><span class="line">			ServerSocket server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">			System.out.println(<span class="string">"服务器启动成功!"</span>);</span><br><span class="line">			System.out.println(<span class="string">"开始侦听客户端连接请求..."</span>);</span><br><span class="line">			Socket client = server.accept();</span><br><span class="line">			InetAddress inetaddress = client.getInetAddress();</span><br><span class="line">			String clientIp = inetaddress.getHostAddress();	<span class="comment">//客户端ip地址</span></span><br><span class="line">			String clientName = inetaddress.getHostName(); <span class="comment">//客户端名称</span></span><br><span class="line">			System.out.println(<span class="string">"发现客户端(ip: "</span> + clientIp	+ <span class="string">", 主机名:"</span> + clientName + <span class="string">")请求连接服务器"</span>);</span><br><span class="line">			DataInputStream dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());  <span class="comment">//开始建立通信信道</span></span><br><span class="line">			DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">            System.out.println(<span class="string">"通信信道已建立完成"</span>);</span><br><span class="line">			</span><br><span class="line">			String message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自客户端的消息["</span> + message + <span class="string">"]"</span>);</span><br><span class="line">			dos.writeUTF(<span class="string">"我收到你的消息了"</span>);</span><br><span class="line">			</span><br><span class="line">			dis.close();</span><br><span class="line">			dos.close();</span><br><span class="line">			client.close();</span><br><span class="line">			server.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		String serverIp = <span class="string">"127.0.0.1"</span>;	</span><br><span class="line">        <span class="comment">//服务器ip地址，因为本地测试所以127.0.0.1</span></span><br><span class="line">		<span class="keyword">int</span> serverPort = <span class="number">54188</span>;</span><br><span class="line">        <span class="comment">//和服务器协商好的</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"开始连接服务器....."</span>);</span><br><span class="line">			Socket socket = <span class="keyword">new</span> Socket(serverIp, serverPort);</span><br><span class="line">			System.out.println(<span class="string">"连接成功"</span>);</span><br><span class="line">			DataInputStream dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			</span><br><span class="line">			dos.writeUTF(<span class="string">"你好，我是一个客户端"</span>);</span><br><span class="line">			String message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自服务器的消息:"</span> + message);</span><br><span class="line">			</span><br><span class="line">			dis.close();</span><br><span class="line">			dos.close();</span><br><span class="line">			socket.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;			<span class="comment">//服务器名称或地址不存在。未知主机异常</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">开始启动服务器...</span></span><br><span class="line"><span class="attr">服务器启动成功!</span></span><br><span class="line"><span class="attr">开始侦听客户端连接请求...</span></span><br><span class="line"><span class="meta">发现客户端(ip</span>: <span class="string">127.0.0.1, 主机名:127.0.0.1)请求连接服务器</span></span><br><span class="line"><span class="attr">通信信道已建立完成</span></span><br><span class="line"><span class="attr">来自客户端的消息[你好，我是一个客户端]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line"><span class="attr">开始连接服务器.....</span></span><br><span class="line"><span class="attr">连接成功</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">我收到你的消息了</span></span><br></pre></td></tr></table></figure>

<p>从上面一对一通信程序，希望你能了解到以下几点。</p>
<p>服务器方面:</p>
<ul>
<li>ServerSocket的建立需要port（端口号），且这个端口号必须和连接的客户端保持一直，也就是说要和客户端协商好。</li>
<li>如果没有客户端连接，程序会卡在accept()那个地方，可以类似于scanf函数，若没有客户端连接则程序会停在accept()那个地方，有客户端连接才会让程序向下进行</li>
<li>可以让客户端先不发消息（把发消息那里注释掉），观察情况，发现两个程序都卡住了，都卡在dis.readUTF()这里。所以dis.readUTF()这个方法也是类似于scanf函数，没有收到对端的消息就卡在这，程序不往下走。dis.readUTF()这个方法是读对端发来的消息，是被动的等，一直等，没有就停在这里</li>
<li>dos.writeUTF()相当于给对端发消息，主动的发消息。</li>
</ul>
<p>客户端方面:</p>
<ul>
<li>Socket的建立需要服务器的ip地址和和服务器协商好的port</li>
<li>也需要建立DataInputStream和DataOutputStream</li>
</ul>
<p>总结一下服务器和客户端都需要DataInputStream和DataOutputStream。它俩相当于什么呢？可以这么说就相当于我们学的通信原理里面的信道那个概念，两端进行信息交换的通信信道；也可以举个现实生活中的例子，就是我们的座机电话，他有两端，上面是听筒端（DataInputStream）和说话端（DataOutputStream）。</p>
<hr>
<h3 id="一对一多次通信"><a href="#一对一多次通信" class="headerlink" title="一对一多次通信"></a>一对一多次通信</h3><p>&emsp;&emsp;一对一多次通信:一个服务器和一个客户端多次通信</p>
<p>&emsp;&emsp;上述一对一单次通信的代码很简单，我们要从中熟悉一些需要用的类。但是，我相信肯定不是上面我们最终的目的吧？不可能通信只通信一句话吧？所以来进一步实现一个客户端和一个服务器多次通信。</p>
<p>&emsp;&emsp;如何进行多次通信呢？经过思考只要通信信道不关闭，就可以多次发送消息。但不能一直通信下去，要有办法停止，也就是可控性。所以定发特定的字符串就停止下来。</p>
<p>服务器代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> Socket client;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始建立服务器"</span>);</span><br><span class="line">		serverSocket = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		System.out.println(<span class="string">"服务器建立完成"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (client != <span class="keyword">null</span> &amp;&amp; !client.isClosed()) &#123;</span><br><span class="line">				client.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			client = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (serverSocket != <span class="keyword">null</span> &amp;&amp; !serverSocket.isClosed()) &#123;</span><br><span class="line">				serverSocket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			serverSocket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listeningClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"开始侦听客户端连接请求"</span>);</span><br><span class="line">		client = serverSocket.accept();</span><br><span class="line">		System.out.println(<span class="string">"客户端["</span> + client.getInetAddress().getHostAddress() + <span class="string">", "</span> + client.getInetAddress().getHostName()</span><br><span class="line">				+ <span class="string">"]连入服务器"</span>);</span><br><span class="line">		</span><br><span class="line">		dis = <span class="keyword">new</span> DataInputStream(client.getInputStream());</span><br><span class="line">		dos = <span class="keyword">new</span> DataOutputStream(client.getOutputStream());</span><br><span class="line">		</span><br><span class="line">		String message = <span class="string">""</span>;</span><br><span class="line">        System.out.println(<span class="string">"接受来自客户端的消息..."</span>);</span><br><span class="line">		<span class="keyword">while</span> (!message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">			message = dis.readUTF();</span><br><span class="line">			System.out.println(<span class="string">"来自客户端的消息:"</span> + message);</span><br><span class="line">			dos.writeUTF(<span class="string">"["</span> + message + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> String ip;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, IOException </span>&#123;</span><br><span class="line">		ip = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始连接服务器..."</span>);</span><br><span class="line">		socket = <span class="keyword">new</span> Socket(ip, port);</span><br><span class="line">		System.out.println(<span class="string">"连接服务器成功"</span>);</span><br><span class="line">		dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">		dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		String message = <span class="string">""</span>;</span><br><span class="line">		String messageFromServer;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">while</span>(!message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">				message = in.nextLine();</span><br><span class="line">				dos.writeUTF(message);</span><br><span class="line">				messageFromServer = dis.readUTF();</span><br><span class="line">				System.out.println(<span class="string">"来自服务器的消息:"</span> +messageFromServer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		in.close();</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行代码。<strong>注意:</strong>要先运行服务器，在运行客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">new</span> SimpleServer().listeningClient();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">new</span> SimpleClient().talking();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显示结果如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">开始建立服务器</span></span><br><span class="line"><span class="attr">服务器建立完成</span></span><br><span class="line"><span class="attr">开始侦听客户端连接请求</span></span><br><span class="line"><span class="meta">客户端[127.0.0.1,</span> <span class="string">127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">接受来自客户端的消息...</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">你好</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">我是一个客户端</span></span><br><span class="line"><span class="meta">来自客户端的消息</span>:<span class="string">byebye</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端</span></span><br><span class="line"><span class="attr">开始连接服务器...</span></span><br><span class="line"><span class="attr">连接服务器成功</span></span><br><span class="line"><span class="attr">你好</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[你好]</span></span><br><span class="line"><span class="attr">我是一个客户端</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[我是一个客户端]</span></span><br><span class="line"><span class="attr">byebye</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[byebye]</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="一对多多次通信"><a href="#一对多多次通信" class="headerlink" title="一对多多次通信"></a>一对多多次通信</h3><p>&emsp;&emsp;一对多多次通信:一个服务器和多个客户端的多次通信</p>
<p>&emsp;&emsp;前面的代码不是我们最终的目的，如果一个服务器只能接入一个客户端，你说他还能称为服务器吗？服务器作为网络节点中心管理者，要实现接入多个客户端的功能。经过分析上述代码得知之所以只接入了一个客户端的原因是，accept()方法只运行了一次，要想接入多个客户端，必须让accept()方法重复执行，我们可以把它放在循环里，条件是服务器关闭与否。但是还是有问题，前面说过accept()方法相当于scanf函数，没有接入它的客户端，程序会卡在那里阻止下面通信的代码。解决方法:用<font color= red><strong>线程</strong></font>。服务器accept()侦听客户端连接用线程并行去跑，不要影响我下面的代码。</p>
<p>&emsp;&emsp;同时分析上述代码我们可以知道每连接一个新的客户端都要新造一个独立的通信信道，这是当然啦，你要和服务器建立联系，就得造通信信道，该通信信道是只有你和服务器用的，独立的，不能让别人用。两端都要有通信信道(DataInputStream和DataOutputStream)所以我们最好把它单独拎出来做成一个类。同时我们知道dis.read()方法也相当于scanf函数，程序卡在这里不会运行以后的代码，你等待对端消息不能干扰我主动给对端发消息吧。因此，也用<font color= red><strong>线程</strong></font>解决。</p>
<p>&emsp;&emsp;只有做到以上两点，才能完成一对多多次通信。才能实现服务器边听（侦听客户端连接）边说（给对端发消息）！可以用以下图示来说明。</p>
<img src="/img/CSFramework/1.png" style="zoom: 50%;" />



<p>先写双方都需要建立的通信信道类Communcation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Communcation</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> DataInputStream dis;</span><br><span class="line">	<span class="keyword">private</span> DataOutputStream dos;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> goon;	<span class="comment">//volatitle关键字:拒绝内存优化，这是线程安全相关问题</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Communcation</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socket = socket;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dis = <span class="keyword">new</span> DataInputStream(socket.getInputStream());</span><br><span class="line">			dos = <span class="keyword">new</span> DataOutputStream(socket.getOutputStream());</span><br><span class="line">			goon = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"通信层"</span>).start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			dos.writeUTF(message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				message = dis.readUTF();</span><br><span class="line">				dealPeerMessage(message);	<span class="comment">//处理对端消息具体做法让外面来决定</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">					dealPeerAbnoramlDrop();	<span class="comment">//当goon还是true的时候，说明是对端异常掉线，做法让外面来决定</span></span><br><span class="line">				&#125;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed()) &#123;</span><br><span class="line">				socket.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			socket = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dis.close();</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dis = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (dos != <span class="keyword">null</span>) &#123;</span><br><span class="line">				dos.close();</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			dos = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulServer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServerSocket server;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> goon;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MulServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">true</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器已经启动，请勿重复启动"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"开始建立服务器..."</span>);</span><br><span class="line">		server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">		System.out.println(<span class="string">"服务器建立成功"</span>);</span><br><span class="line">		goon = <span class="keyword">true</span>;</span><br><span class="line">		System.out.println(<span class="string">"开始侦听客户端连接..."</span>);</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">this</span>, <span class="string">"服务器"</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (goon == <span class="keyword">false</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"服务器已经宕机，请勿重复宕机"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		close();</span><br><span class="line">		System.out.println(<span class="string">"服务器正常宕机"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> goon;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (goon) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Socket client = server.accept();</span><br><span class="line">				System.out.println(<span class="string">"客户端["</span> + client.getInetAddress().getHostAddress() + </span><br><span class="line">						client.getInetAddress().getHostName() + <span class="string">"]连入服务器"</span>);</span><br><span class="line">				<span class="keyword">new</span> Communcation(client) &#123;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">						<span class="keyword">if</span> (message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">							System.out.println(<span class="string">"客户端正常下线"</span>);</span><br><span class="line">							close();</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						System.out.println(<span class="string">"收到来自客户端的消息:"</span> + message);</span><br><span class="line">						send(<span class="string">"["</span> + message +<span class="string">"]"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						System.out.println(<span class="string">"客户端异常掉线"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		goon = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (server != <span class="keyword">null</span> &amp;&amp; !server.isClosed()) &#123;</span><br><span class="line">				server.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			server = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MulClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Socket socket;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">	<span class="keyword">private</span> String serverIp;</span><br><span class="line">	<span class="keyword">private</span> Communcation communcation;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MulClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		port = <span class="number">54188</span>;</span><br><span class="line">		serverIp = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (communcation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		communcation.send(message);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (communcation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		communcation.close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectToServer</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, IOException </span>&#123;</span><br><span class="line">		socket = <span class="keyword">new</span> Socket(serverIp, port);</span><br><span class="line">		communcation = <span class="keyword">new</span> Communcation(socket) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"来自服务器的消息:"</span> + message);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dealPeerAbnoramlDrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"服务器异常宕机，服务停止"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		MulServer mulServer = <span class="keyword">new</span> MulServer();</span><br><span class="line">		Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		String command = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">boolean</span> finshed = <span class="keyword">false</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (!finshed) &#123;</span><br><span class="line">			command = in.next();</span><br><span class="line">			<span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"st"</span>)) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					mulServer.startUp();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"sd"</span>)) &#123;</span><br><span class="line">				mulServer.shutDown();</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equalsIgnoreCase(<span class="string">"x"</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!mulServer.isStartup()) &#123;</span><br><span class="line">					finshed = <span class="keyword">true</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					System.out.println(<span class="string">"服务器尚未宕机!"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		in.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		MulClient client = <span class="keyword">new</span> MulClient();</span><br><span class="line">		<span class="keyword">boolean</span> finished = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client.connectToServer();</span><br><span class="line">			</span><br><span class="line">			Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">			</span><br><span class="line">			String message = <span class="string">""</span>;</span><br><span class="line">			<span class="keyword">while</span> (!finished) &#123;</span><br><span class="line">				message = in.next();</span><br><span class="line">				client.send(message);</span><br><span class="line">				<span class="keyword">if</span> (message.equalsIgnoreCase(<span class="string">"byebye"</span>)) &#123;</span><br><span class="line">					client.close();</span><br><span class="line">					finished = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			in.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行服务器测试代码，在运行客户端测试代码。进行测试结果如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器</span></span><br><span class="line"><span class="attr">st</span></span><br><span class="line"><span class="attr">开始建立服务器...</span></span><br><span class="line"><span class="attr">服务器建立成功</span></span><br><span class="line"><span class="attr">开始侦听客户端连接...</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="attr">客户端[127.0.0.1127.0.0.1]连入服务器</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">123</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">456</span></span><br><span class="line"><span class="meta">收到来自客户端的消息</span>:<span class="string">789</span></span><br><span class="line"><span class="attr">客户端正常下线</span></span><br><span class="line"><span class="attr">客户端异常掉线</span></span><br><span class="line"><span class="attr">客户端正常下线</span></span><br><span class="line"><span class="attr">sd</span></span><br><span class="line"><span class="attr">服务器正常宕机</span></span><br><span class="line"><span class="attr">x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端1</span></span><br><span class="line"><span class="attr">123</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[123]</span></span><br><span class="line"><span class="attr">byebye</span></span><br><span class="line"><span class="comment">#客户端2 故意强制关闭</span></span><br><span class="line"><span class="attr">456</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[456]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端3</span></span><br><span class="line"><span class="attr">789</span></span><br><span class="line"><span class="meta">来自服务器的消息</span>:<span class="string">[789]</span></span><br><span class="line"><span class="attr">byebye</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;&emsp;一对多多次通信就完成了。服务器可以接入多个客户端，客户端可以发消息给服务器。但是，这就完了吗？这就是我们想要的吗？我并不认为就完了，我们做的功能太简陋了，完全不够用。同时思考可不可以将底层通信的代码做成工具，做成普适性工具，这样以后开发不同需求的C/S程序就会方便很多。这就是框架的含义，也就是我们要做的工具CSFramework。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/" data-id="ck8bqrj020002t4i27m7xcx8j" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-XML文件与Properites文件解析工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-03-06T08:19:34.669Z" itemprop="datePublished">2020-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/">XML文件与Properites文件解析工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp; &emsp;XML文件与Properties文件在我的Java学习中和以后要接触的框架中十分常见的文件类型。这些文件懂了相关的编写规则后会十分容易写出来，但是作为配置文件如何去用它才是关键。人根据自己要完成的目的编写相关文件，可是你把这个文件放在计算机面前它不懂啊，它只知道01序列。因此，对于这种高频出现的文件，我们有必要编程，编写一个工具来解析它，方便以后使用。我不是直接把相关解析工具代码直接贴出来，而是一步步写关于这个工具如何造出来，这样才能学习更深刻并且里面蕴含的工具思想也能写出来。</p>
<h2 id="XML文件解析工具"><a href="#XML文件解析工具" class="headerlink" title="XML文件解析工具"></a>XML文件解析工具</h2><p>​        XML(Extensible Markup Language)，中文翻译为可扩展标记语言。它可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。（<em>以上摘自百度百科</em>）使用它我们可以很容易的描述复杂的层次数据结构。例如，下面给的一个XML文件简单例子，学生基本信息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">students</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">student</span> <span class="attr">name</span>= <span class="string">"张三"</span> <span class="attr">id</span>= <span class="string">"20203035"</span> <span class="attr">sex</span>= <span class="string">"男"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hobbies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>打游戏<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>篮球<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>学习<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">hobbies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">student</span> <span class="attr">name</span>= <span class="string">"李四"</span> <span class="attr">id</span>= <span class="string">"20203036"</span> <span class="attr">sex</span>= <span class="string">"男"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hobbies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>足球<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>写作<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>摄影<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">hobbies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">student</span> <span class="attr">name</span>= <span class="string">"王五"</span> <span class="attr">id</span>= <span class="string">"20203037"</span> <span class="attr">sex</span>= <span class="string">"女"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">hobbies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>购物<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>逛街<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">hobby</span>&gt;</span>羽毛球<span class="tag">&lt;/<span class="name">hobby</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">hobbies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">students</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        只是个简单的学生信息XML文件。对XML文件稍有了解，知道&lt;&gt;&lt;/&gt;是标签，标签里面带着的叫做属性。分析上面XML文件知，根标签是students(根标签必须有)，下一个标签student，其中有三个属性(name, id, sex)，下一个标签是hobbies，然后下一个标签是hobby。看到这个XML文件有没有觉得它特别像树形结构。因此，我们使用四种XML解析方式之一的DOM解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">			InputStream is = Test.class.getResourceAsStream("/studentInfo.xml");</span><br><span class="line">			<span class="comment">//这里是用当前类的class.getResourceAsStream。参数是相对路径。</span></span><br><span class="line">			Document document = documentBuilder.parse(is);</span><br><span class="line">			<span class="comment">//前面四句话是不是看的一头雾水？我最初学也是，这里没必要刨根问底，当作巫师的咒语吧！</span></span><br><span class="line">			</span><br><span class="line">			NodeList studentList = document.getElementsByTagName(<span class="string">"student"</span>);</span><br><span class="line">            <span class="comment">//根据标签名得到一个结点列表</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; studentList.getLength(); i++) &#123;</span><br><span class="line">				StudentInfo stu = <span class="keyword">new</span> StudentInfo();	</span><br><span class="line">                <span class="comment">//StudentInfo类只是为了最后显示好看。</span></span><br><span class="line">				Element student = (Element) studentList.item(i);</span><br><span class="line">                <span class="comment">//要把Node类型强转为Element类型</span></span><br><span class="line">				String name = student.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">				String id = student.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">				String sex = student.getAttribute(<span class="string">"sex"</span>);</span><br><span class="line">				stu.setId(id);</span><br><span class="line">				stu.setSex(sex);</span><br><span class="line">				stu.setName(name);</span><br><span class="line">				</span><br><span class="line">				NodeList hobbyList = student.getElementsByTagName(<span class="string">"hobby"</span>);</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; hobbyList.getLength(); j++) &#123;</span><br><span class="line">					String hobbyString = hobbyList.item(j).getTextContent();</span><br><span class="line">					stu.addHobby(hobbyString);</span><br><span class="line">				&#125;</span><br><span class="line">				System.out.println(stu);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        关于NodeList，Node，Element这几个类我需要说一下。</p>
<p>​        getElementsByTagName(“标签名”)获得的是个NodeList，没办法强转成Element。但可以遍历这个NodeList，item(index)方法取得相应的一个Node。Node与Element之间有关系。</p>
<p>​        对于一个出现多次的标签(student)，我们获得一个NodeList，遍历它，如果又遇到出现多次的标签(hobby)，再获得一个NodeList，遍历它，如此下去，直到所有标签都被过一遍。</p>
<p>​        总结:NodeList是标签多次出现组成，最终要访问到具体内容还是要提供Element，NodeList与Element之间转换通过Node完成。</p>
<img src="/img/XML/1.png" alt="1" style="zoom: 80%;" />

<p>要用的Model类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String sex;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; hobbies;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">StudentInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		hobbies = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sex;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sex = sex;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHobbies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> hobbies;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addHobby</span><span class="params">(String hobby)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (hobby == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (hobbies.contains(hobby)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		hobbies.add(hobby);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		StringBuffer stu = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">		stu.append(name).append(<span class="string">" "</span>)</span><br><span class="line">			.append(id).append(<span class="string">" "</span>)</span><br><span class="line">			.append(sex).append(<span class="string">" "</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (String hobby : hobbies) &#123;</span><br><span class="line">			stu.append(<span class="string">"\n"</span>).append(<span class="string">"\t"</span>).append(hobby);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> stu.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">张三 <span class="number">20203035</span> 男 </span><br><span class="line">	打游戏</span><br><span class="line">	篮球</span><br><span class="line">	学习</span><br><span class="line">李四 <span class="number">20203036</span> 男 </span><br><span class="line">	足球</span><br><span class="line">	写作</span><br><span class="line">	摄影</span><br><span class="line">王五 <span class="number">20203037</span> 女 </span><br><span class="line">	购物</span><br><span class="line">	逛街</span><br><span class="line">	羽毛球</span><br></pre></td></tr></table></figure>

<p>​        接下来就是制作工具了。所谓工具就是<strong>工具制造者把那些重复的、一成不变的代码提取出来做成工具，而那些会变部分的代码向外提供，由工具使用者去实现</strong>。就比如现在给你的不是这个学生信息XML表了，而换了另一个XML让你解析，再看解析代码，发现for循环上面的都是一成不变的（除了参数），而底下的真正解析过程会随着不同XML变化。</p>
<p>​        以后处理XML文件，在结构上任何XML文件都是相同的。只是在细节上标签名或者属性名有所差别而已。相同之处做成工具，造工具的人只编写XML相同的，结构相似的部分；差别之处拎出来提供给外面，让工具使用者去完成。</p>
<h3 id="XMLParse工具类"><a href="#XMLParse工具类" class="headerlink" title="XMLParse工具类"></a>XMLParse工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLParse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DocumentBuilderFactory dbf;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> DocumentBuilder db;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			db = dbf.newDocumentBuilder();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XMLParse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">getDocument</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">		Document document = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			document = db.parse(is);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> document;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">getDocument</span><span class="params">(String xmlPath)</span> </span>&#123;</span><br><span class="line">		InputStream is = XMLParse<span class="class">.<span class="keyword">class</span>.<span class="title">getResourceAsStream</span>(<span class="title">xmlPath</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"xmlPath["</span> +xmlPath + <span class="string">"不存在"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getDocument(is);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*getElementsByTagName写了两次，但两次前缀不一样，一个是doucument,一个是element类型的,覆盖就行了*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTag</span><span class="params">(Document document, String tagName)</span> </span>&#123;</span><br><span class="line">		NodeList nodeList = document.getElementsByTagName(tagName);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; nodeList.getLength(); index++) &#123;	</span><br><span class="line">			Element element = (Element) nodeList.item(index);	</span><br><span class="line">            <span class="comment">//底下的内容不同的xml解析不尽相同,工具写到这没法写了。</span></span><br><span class="line">			dealElement(element, index);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTag</span><span class="params">(Element element, String tagName)</span> </span>&#123;</span><br><span class="line">		NodeList nodeList = element.getElementsByTagName(tagName);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; nodeList.getLength(); index++) &#123;	</span><br><span class="line">			Element ele = (Element) nodeList.item(index);	</span><br><span class="line">            <span class="comment">//底下的内容不同的xml解析不尽相同,工具写到这没法写了。</span></span><br><span class="line">			<span class="comment">//后面对ele进一步解析：取属性，取textContent或进一步取Element都应该是未来的工具使用者操心的事，我要做的仅仅是是把ele交给对方</span></span><br><span class="line">			dealElement(ele, index);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span></span>;	</span><br><span class="line">    <span class="comment">//这个index让用户知道处理到第几项都能知道</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XML文件解析工具就写出来了。还是那句话将那些已经确定了的代码写好，对于以后操作者如何去用我不管，我也管不着，所以将它传给外面，尽量将有用的信息都传出去，因为这样使用工具的人才能多一些机会做自己的操作。</p>
<p>如何去用这个工具下面给个例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;		<span class="comment">//直接用匿名内部类去使用，方便快捷。</span></span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;<span class="comment">//循环都不用写了，因为这句话就在循环里</span></span><br><span class="line">				StudentInfo stu = <span class="keyword">new</span> StudentInfo();</span><br><span class="line">				String name = element.getAttribute(<span class="string">"name"</span>);	<span class="comment">//此时这个element就是标签student</span></span><br><span class="line">				String id = element.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">				String sex = element.getAttribute(<span class="string">"sex"</span>);</span><br><span class="line">				stu.setId(id);</span><br><span class="line">				stu.setSex(sex);</span><br><span class="line">				stu.setName(name);</span><br><span class="line">				<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//始终记得的这个是在循环里</span></span><br><span class="line">						<span class="comment">//可直接再使用匿名内部类解析下一个标签。也可以新建方法解析把这层提出去，这样可读性更强，且不会造成代码逻辑混乱。</span></span><br><span class="line">						String hobbyString = element.getTextContent();</span><br><span class="line">						stu.addHobby(hobbyString);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;.parseTag(element, <span class="string">"hobby"</span>);</span><br><span class="line">				System.out.println(stu);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(XMLParse.getDocument(<span class="string">"/studentInfo.xml"</span>), <span class="string">"student"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Properties文件解析工具"><a href="#Properties文件解析工具" class="headerlink" title="Properties文件解析工具"></a>Properties文件解析工具</h2><p>​        Properties文件就十分简单了，它的格式主要是以key-value键值对的形式存储，所以它的工具类就十分好建立了。既然是个键值对，就放在Map数据结构中，要遵循Map的规则（键值最好不要重复）。</p>
<p>​        下面给个简单的properties文件例子，该例子是我连接数据库的相关配置。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/mec_javase_201910?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p>其工具类因为它是键值对形式，所以放在一个大池子里，解析一个就放进去一个，想用就从池子取。</p>
<h3 id="PropertiesParse工具类"><a href="#PropertiesParse工具类" class="headerlink" title="PropertiesParse工具类"></a>PropertiesParse工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProperitiesParse</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; pool;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		pool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadProperities</span><span class="params">(String configFilePath)</span> </span>&#123;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(configFilePath));</span><br><span class="line">			loadding(<span class="keyword">new</span> InputStreamReader(is, <span class="string">"utf-8"</span>));</span><br><span class="line">            <span class="comment">//这里是有关编码格式的问题，不必深究，尽量使用utf-8格式。</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadding</span><span class="params">(InputStreamReader is)</span> </span>&#123;</span><br><span class="line">		Properties property = <span class="keyword">new</span> Properties();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			property.load(is);</span><br><span class="line">			Enumeration&lt;Object&gt;keys = property.keys();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">while</span>(keys.hasMoreElements()) &#123;</span><br><span class="line">				String key = (String) keys.nextElement();</span><br><span class="line">				String value = property.getProperty(key);</span><br><span class="line">				pool.put(key, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">keySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pool.keySet();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">value</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pool.get(key);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何使用和演示结果也很简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoropertiesTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		ProperitiesParse.loadProperities(<span class="string">"E:\\A大三\\大三上\\JavaProject\\20200306@XMLParse@PropertiesParse\\src\\connection.properties"</span>);</span><br><span class="line">        <span class="comment">//这里要跟绝对路径</span></span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"driver"</span>));</span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"url"</span>));</span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"user"</span>));</span><br><span class="line">		System.out.println(ProperitiesParse.value(<span class="string">"password"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">演示结果</span></span><br><span class="line"><span class="comment">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment">jdbc:mysql://localhost:3306/mec_javase_201910?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br><span class="line"><span class="comment">root</span></span><br><span class="line"><span class="comment">123456</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​        至此，两个常用文件的简单解析工具就完成了。XML解析工具工具思想多一些，可以着重看也可以跟着敲一遍，才能收获更深。</p>
<p>//TODO 传文件至github上！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/" data-id="ck8bqrj000001t4i29d5ld8m9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-EasySwing一键生成界面的工具" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/03/EasySwing%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90%E7%95%8C%E9%9D%A2%E7%9A%84%E5%B7%A5%E5%85%B7/" class="article-date">
  <time datetime="2020-03-03T07:23:58.000Z" itemprop="datePublished">2020-03-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/03/EasySwing%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90%E7%95%8C%E9%9D%A2%E7%9A%84%E5%B7%A5%E5%85%B7/">EasySwing一键生成界面的工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="EasySwing介绍"><a href="#EasySwing介绍" class="headerlink" title="EasySwing介绍"></a>EasySwing介绍</h2><p>&emsp;&emsp;不知道大家在编写Java界面部分的时候有没有这种感觉，就是设计界面这部分步骤大部分都大同小异，都是首先先new出一个新控件，然后设置这个新控件的一些属性，最后将这个控件加进相应的面板(例如:Jpanel)或者容器(例如:Container)里。反正我在设置界面的时候对于这些纷繁复杂的控件类的设置方法记不清，总要去网上查相应文档才能设置。例如<code>jfrmMain.setLocationRelativeTo(null);</code>设置窗口位于屏幕中央这句代码我总是漏写。<br>&emsp;&emsp;所以，对于这些大致逻辑相同的设置界面代码，我们可不可以方便点不写代码而进行写一些配置文件自动化（也就是一键）生成界面呢？答案是可以的，就是我准备写的EasySwing工具。  </p>
<p><strong>EasySwing</strong>：只需要写一个你想要的界面里的控件相关设置的XML文件，和有关的properties文件，就可以快速生成你想要的界面。编写这个Easyswing所需知识:XML文件解析、properties文件解析和最重要的反射机制。</p>
<h2 id="EasySwing的实现"><a href="#EasySwing的实现" class="headerlink" title="EasySwing的实现"></a>EasySwing的实现</h2><p>首先，我们可以先用以下代码简单的方式写个十分简单的界面。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	JFrame jfrmMain = <span class="keyword">new</span> JFrame(<span class="string">"这是EasySwing的一次尝试"</span>);</span><br><span class="line">	jfrmMain.setSize(<span class="number">680</span>, <span class="number">560</span>);</span><br><span class="line">	jfrmMain.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span><br><span class="line">	jfrmMain.setLocationRelativeTo(<span class="keyword">null</span>);</span><br><span class="line">	Container container = <span class="keyword">new</span> Container();</span><br><span class="line">	container.setLayout(<span class="keyword">new</span> BorderLayout());</span><br><span class="line">	jfrmMain.setContentPane(container);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	Font topicFont = <span class="keyword">new</span> Font(<span class="string">"微软雅黑"</span>, Font.BOLD, <span class="number">32</span>);</span><br><span class="line">	Color topicColor = <span class="keyword">new</span> Color(<span class="number">3</span>, <span class="number">31</span>, <span class="number">203</span>);</span><br><span class="line">	JLabel jlblTopic = <span class="keyword">new</span> JLabel(<span class="string">"EasySwing的尝试"</span>, JLabel.CENTER);</span><br><span class="line">	jlblTopic.setFont(topicFont);</span><br><span class="line">	jlblTopic.setForeground(topicColor);</span><br><span class="line">	container.add(jlblTopic, BorderLayout.NORTH);</span><br><span class="line">	</span><br><span class="line">	Font normalFont = <span class="keyword">new</span> Font(<span class="string">"微软雅黑"</span>, Font.PLAIN, <span class="number">16</span>);</span><br><span class="line">	JPanel jpnlFoot = <span class="keyword">new</span> JPanel();</span><br><span class="line">	container.add(jpnlFoot, BorderLayout.SOUTH);</span><br><span class="line">	JButton jbtnAdd = <span class="keyword">new</span> JButton(<span class="string">"添加"</span>);</span><br><span class="line">	jbtnAdd.setFont(normalFont);</span><br><span class="line">	jpnlFoot.add(jbtnAdd);</span><br><span class="line">	</span><br><span class="line">	JButton jbtnDelete = <span class="keyword">new</span> JButton(<span class="string">"删除"</span>);</span><br><span class="line">	jbtnDelete.setFont(normalFont);</span><br><span class="line">	jpnlFoot.add(jbtnDelete);</span><br><span class="line">	</span><br><span class="line">	JButton jbtnModify = <span class="keyword">new</span> JButton(<span class="string">"修改"</span>);</span><br><span class="line">	jbtnModify.setFont(normalFont);</span><br><span class="line">	jpnlFoot.add(jbtnModify);</span><br><span class="line">	</span><br><span class="line">	JButton jbtnExit = <span class="keyword">new</span> JButton(<span class="string">"退出"</span>);</span><br><span class="line">	jbtnExit.setFont(normalFont);</span><br><span class="line">	jpnlFoot.add(jbtnExit);</span><br><span class="line">	</span><br><span class="line">	jfrmMain.setVisible(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其运行结果如下，真的只是个简单的界面，甚至说简陋，大佬勿喷。最终我们就是要用工具和配置文件实现一键产生这个界面。 </p>
<img src="/img/EasySwing/1.png" alt="1" style="zoom:50%;" />  

<h3 id="XML文件的写法以及规则的制订"><a href="#XML文件的写法以及规则的制订" class="headerlink" title="XML文件的写法以及规则的制订"></a>XML文件的写法以及规则的制订</h3><p>xml文件其实是最难想的，因为它关乎这以后如何解析的基调；同时xml文件是最好写的，因为一旦规则定下来，方便给他人出个使用说明书，只需要按着规则去写即可。我写的EasySwing工具定的以下规则:</p>
<ul>
<li>首先根标签是view</li>
<li>下一级标签是controller(控件)<ol>
<li>&ensp; id:代表控件的名称，这个非常重要因为以后所有控件都是存在一个Map（控件池）中的，这个充当键值，所以请保证不要重复</li>
<li>&ensp; para:代表该控件new出来的时候所需要的参数，其中空串代表无参构造，null代表以<code>null</code>进行构造，若是多参构造则’’里是<code>字符串类型</code>，直接写数字带小数点是<code>double</code>类型，不带小数点是<code>int</code>类型，写true或者false就是<code>boolean</code>类型，加=代表去properties文件去找相应的写好的常量（也可以直接写对应的值，这里只是为了语义性更强些和方便阅读），加#代表去所谓的控件池去找。</li>
<li>&ensp; father:代表该控件要被加在哪个容器中，若无则可以不写，若有则写该父容器的id值。</li>
<li>&ensp; locate:代表该控件加在父容器中的位置，无父容器肯定不写，若直接加则写个空串</li>
<li>&ensp; mainView:代表该控件是否是最后用来显示的主体JFrame，是要写为true，不是可以不写。</li>
</ol>
</li>
<li>下一级标签是method。如果有的控件没有要执行的方法可以不写。<ol>
<li>&ensp; name:代表该方法的名字，直接去properties文件查找</li>
<li>&ensp; para:代表该方法需要的参数，与controller的para参数一样，在此不再累赘。</li>
</ol>
</li>
</ul>
<p><strong>总结下：</strong>就是=就在properties文件里找，#就在控件池里面找，其余按相应规则去写就行。其实我们可以从XML文件发现para这个属性逻辑有些多变且复杂，确实是，我们工具就是以它开始分析和建立的。<br>以下是根据以上代码和规则写出XML文件  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>=<span class="string">"boderLayout"</span> <span class="attr">para</span>=<span class="string">""</span> &gt;</span><span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"topicFont"</span> <span class="attr">para</span>= <span class="string">"'微软雅黑',=加粗字体, 32"</span> &gt;</span><span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"topicColor"</span> <span class="attr">para</span>= <span class="string">"3, 31, 203"</span> &gt;</span><span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"normalFont"</span> <span class="attr">para</span>= <span class="string">"'微软雅黑', =正常字体, 16"</span>&gt;</span><span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"container"</span> <span class="attr">para</span>=<span class="string">""</span> &gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置布局模式"</span> <span class="attr">para</span>= <span class="string">"#boderLayout"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"jfrmMain"</span> <span class="attr">para</span>= <span class="string">"'这是EasySwing的一次尝试'"</span> <span class="attr">mainView</span>= <span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置尺寸"</span> <span class="attr">para</span>=<span class="string">"680, 560"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置默认关闭操作"</span> <span class="attr">para</span>=<span class="string">"=退出时关闭"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置相对位置"</span> <span class="attr">para</span>= <span class="string">"null"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置底层面板"</span> <span class="attr">para</span>= <span class="string">"#container"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"jlblTopic"</span> <span class="attr">para</span>= <span class="string">"'EasySwing的尝试',=标签居中"</span> <span class="attr">father</span>= <span class="string">"container"</span> <span class="attr">locate</span>= <span class="string">"边界布局.北"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置字体"</span> <span class="attr">para</span>= <span class="string">"#topicFont"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置背景颜色"</span> <span class="attr">para</span>= <span class="string">"#topicColor"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"jpnlFoot"</span> <span class="attr">para</span>= <span class="string">""</span> <span class="attr">father</span>= <span class="string">"container"</span> <span class="attr">locate</span>= <span class="string">"边界布局.南"</span>&gt;</span>			<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span>= <span class="string">"jbtnAdd"</span> <span class="attr">para</span>= <span class="string">"'添加'"</span> <span class="attr">father</span>= <span class="string">"jpnlFoot"</span> <span class="attr">locate</span>= <span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置字体"</span> <span class="attr">para</span>= <span class="string">"#normalFont"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span> = <span class="string">"jbtnDelete"</span> <span class="attr">para</span>= <span class="string">"'删除'"</span> <span class="attr">father</span>= <span class="string">"jpnlFoot"</span> <span class="attr">locate</span>= <span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置字体"</span> <span class="attr">para</span>= <span class="string">"#normalFont"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span> = <span class="string">"jbtnModify"</span> <span class="attr">para</span>= <span class="string">"'修改'"</span> <span class="attr">father</span>= <span class="string">"jpnlFoot"</span> <span class="attr">locate</span>= <span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置字体"</span> <span class="attr">para</span>= <span class="string">"#normalFont"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">controller</span> <span class="attr">id</span> = <span class="string">"jbtnExit"</span> <span class="attr">para</span>= <span class="string">"'退出'"</span> <span class="attr">father</span>= <span class="string">"jpnlFoot"</span> <span class="attr">locate</span>= <span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>= <span class="string">"设置字体"</span> <span class="attr">para</span>= <span class="string">"#normalFont"</span>&gt;</span><span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="properties文件的写法"><a href="#properties文件的写法" class="headerlink" title="properties文件的写法"></a>properties文件的写法</h3><p>properties文件就好写多了，它就是一些有关的键值对集合。其中主要包括三种</p>
<ul>
<li>控件类型 键:控件名称 值:控件的包名称    <strong>备注</strong>:导一个类后，代码最上面就有</li>
<li>方法名称 键:方法名称 值:相应类中方法的具体写法    <strong>备注</strong>:一定要查对写对，否则方法会执行失败</li>
<li>一些常量 键:常量名称 值:常量真正的值    <strong>备注</strong>:一定要查对写对，否则可能达不到预期目的  </li>
</ul>
<p>根据代码写如下properties文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#控件类型</span></span><br><span class="line"><span class="comment">#jfrmMain=javax.swing.JFrame</span></span><br><span class="line"><span class="attr">jfrmMain</span>=<span class="string">com.mec.Easyswing.support.MJframe</span></span><br><span class="line"><span class="comment">#container=java.awt.Container</span></span><br><span class="line"><span class="attr">container</span>=<span class="string">com.mec.Easyswing.support.MContainer</span></span><br><span class="line"><span class="attr">jlblTopic</span>=<span class="string">javax.swing.JLabel</span></span><br><span class="line"><span class="attr">boderLayout</span>=<span class="string">java.awt.BorderLayout</span></span><br><span class="line"><span class="attr">topicFont</span>=<span class="string">java.awt.Font</span></span><br><span class="line"><span class="attr">topicColor</span>=<span class="string">java.awt.Color</span></span><br><span class="line"><span class="attr">normalFont</span>=<span class="string">java.awt.Font</span></span><br><span class="line"><span class="comment">#jpnlFoot=javax.swing.JPanel</span></span><br><span class="line"><span class="attr">jpnlFoot</span>=<span class="string">com.mec.Easyswing.support.MJpnlFoot</span></span><br><span class="line"><span class="attr">jbtnAdd</span>=<span class="string">javax.swing.JButton</span></span><br><span class="line"><span class="attr">jbtnDelete</span>=<span class="string">javax.swing.JButton</span></span><br><span class="line"><span class="attr">jbtnModify</span>=<span class="string">javax.swing.JButton</span></span><br><span class="line"><span class="attr">jbtnExit</span>=<span class="string">javax.swing.JButton</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法名称</span></span><br><span class="line"><span class="meta">设置尺寸</span>=<span class="string">setSize</span></span><br><span class="line"><span class="meta">设置默认关闭操作</span>=<span class="string">setDefaultCloseOperation</span></span><br><span class="line"><span class="meta">设置相对位置</span>=<span class="string">setLocationRelativeTo</span></span><br><span class="line"><span class="meta">设置底层面板</span>=<span class="string">setContentPane</span></span><br><span class="line"><span class="meta">设置布局模式</span>=<span class="string">setLayout</span></span><br><span class="line"><span class="meta">设置字体</span>=<span class="string">setFont</span></span><br><span class="line"><span class="meta">设置背景颜色</span>=<span class="string">setForeground</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#一些常量</span></span><br><span class="line"><span class="meta">退出时关闭</span>=<span class="string">3</span></span><br><span class="line"><span class="meta">正常字体</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">加粗字体</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">斜体字体</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">标签居中</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">边界布局.北</span>=<span class="string">North</span></span><br><span class="line"><span class="meta">边界布局.南</span>=<span class="string">South</span></span><br><span class="line"><span class="meta">边界布局.西</span>=<span class="string">West</span></span><br><span class="line"><span class="meta">边界布局.东</span>=<span class="string">East</span></span><br><span class="line"><span class="meta">边界布局.中间</span>=<span class="string">Center</span></span><br></pre></td></tr></table></figure>
<p>应该这样来说，代码出现一个新的控件，就去给XML文件和properties文件加东西，两个是同步的，相辅相成的一起走。  </p>
<p>接下来就是重头戏了，开始写我们的工具代码部分。</p>
<h3 id="EasySwing工具的编写"><a href="#EasySwing工具的编写" class="headerlink" title="EasySwing工具的编写"></a>EasySwing工具的编写</h3><p>&emsp; 首先一上来别急着直接去解析XML文件，也不要急于编写什么逻辑复杂的东西。我们观察XML文件可以发现每个标签都存在para这个属性，这个属性就好像是所有控件的数据一样，是啊，构造需要参数，方法的执行也需要参数，发现这个参数需要多次编写多次使用，因此根据<em>Java的面对对象思想</em>我们将para独立封装成一个类ViewParameterModel。</p>
<h4 id="ViewParameterModel类"><a href="#ViewParameterModel类" class="headerlink" title="ViewParameterModel类"></a>ViewParameterModel类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewParameterModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//任何参数都有两个属性:类型，值</span></span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; type;	 </span><br><span class="line">	<span class="keyword">private</span> Object value;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewParameterModel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setPara</span><span class="params">(String para)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (para.startsWith(<span class="string">"#"</span>)) &#123;</span><br><span class="line">			ViewFactory viewFactory = ViewFactory.currentInstance();		<span class="comment">//这个类先别管，以后会用到</span></span><br><span class="line">			Object controller = viewFactory.getController(para.substring(<span class="number">1</span>));</span><br><span class="line">			<span class="keyword">if</span> (controller == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.value = controller;</span><br><span class="line">			<span class="keyword">this</span>.type = controller.getClass();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (para.startsWith(<span class="string">"="</span>)) &#123;</span><br><span class="line">			para = ProperitiesParse.value(para.substring(<span class="number">1</span>));	<span class="comment">//这个PropertiesParse工具先忽略，我以后会给这个工具的链接</span></span><br><span class="line">		&#125;</span><br><span class="line">		setType(para);</span><br><span class="line">		setValue(para);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(String para)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (para.equalsIgnoreCase(<span class="string">"null"</span>)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.type = Object<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (para.startsWith(<span class="string">"'"</span>) &amp;&amp; para.endsWith(<span class="string">"'"</span>)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.type = String<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (para.equalsIgnoreCase(<span class="string">"true"</span>) || para.equalsIgnoreCase(<span class="string">"false"</span>)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.type = <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Integer.valueOf(para);</span><br><span class="line">			<span class="keyword">this</span>.type = <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Double.valueOf(para);</span><br><span class="line">			<span class="keyword">this</span>.type = <span class="keyword">double</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;			</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String para)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"XML文件para参数配置错误"</span>);	<span class="comment">//也可以自己写一个异常类</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(Object<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.value = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(String<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.value = para.substring(<span class="number">1</span>, para.length() - <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(<span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.value = Boolean.valueOf(para);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(<span class="keyword">int</span><span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.value = Integer.valueOf(para);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(<span class="keyword">double</span><span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.value = Double.valueOf(para);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; getType() &#123;</span><br><span class="line">		<span class="keyword">return</span> type;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到编写这个类的目的十分简单，任何参数都有两个共同的属性，一个是参数类型（这里只涉及简单的类型：<code>int</code>，<code>double</code>，<code>boolean</code>，<code>String</code>）,另一个是参数的值。这个类就是根据上面的XML编写规则的简单逻辑写出来的，不存在什么难度。关于代码中的ViewFactory（后面的工具类）和PropertiesPrase（以后我会给链接）。  </p>
<p><strong>tips:要记得局部性验证这个类对不对，可不可用，因为它是这个工具最基础的类，就像建高楼大厦一定要保证地基一样耐用。同时这个最基础的类不是一蹴而就写出来的，一定是经过再往前走一些步骤后才逐步完善出来的</strong></p>
<p><a href="https://honorzmj98.github.io/2020/03/06/XML文件与Properites文件解析工具/">Properties文件解析工具</a></p>
<hr>
<p>&emsp; 接下来，我们知道一个方法未必只有一个参数（ViewParameterModel只代表一个参数），且参数是有顺序关系的，所以考虑用List存储相关参数是一个解决方法。所以要把刚才的ViewParameterModel类当成个工具使用，再生成个类ViewParameters。</p>
<h4 id="ViewParameters类"><a href="#ViewParameters类" class="headerlink" title="ViewParameters类"></a>ViewParameters类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewParameters</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;ViewParameterModel&gt; parameters;</span><br><span class="line">	</span><br><span class="line">	ViewParameters(String para) <span class="keyword">throws</span> Exception &#123; 					<span class="comment">//传过来的参数直接就是XML文件para内容</span></span><br><span class="line">		String[] paras = para.split(<span class="string">","</span>);</span><br><span class="line">		<span class="keyword">if</span> (paras.length == <span class="number">1</span> &amp;&amp; paras[<span class="number">0</span>].trim().length() &lt;= <span class="number">0</span>) &#123;		<span class="comment">//这里代表para内容是""，空串</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		parameters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paras.length; i++) &#123;</span><br><span class="line">			ViewParameterModel viewParameterModel = <span class="keyword">new</span> ViewParameterModel();</span><br><span class="line">			viewParameterModel.setPara(paras[i].trim());</span><br><span class="line">			parameters.add(viewParameterModel);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	Class&lt;?&gt;[] getParametersType() &#123;	<span class="comment">//得到参数的类型数组，方便反射机制用来找方法</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (parameters == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123;&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> count = parameters.size();</span><br><span class="line">		Class&lt;?&gt;[] result = <span class="keyword">new</span> Class&lt;?&gt;[count];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">			result[i] = parameters.get(i).getType();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	Object[] getParametersValue() &#123;	<span class="comment">//得到参数的值数组，方便反射机制执行方法</span></span><br><span class="line">		<span class="keyword">if</span> (parameters == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Object[] &#123;&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> count = parameters.size();</span><br><span class="line">		Object[] result = <span class="keyword">new</span> Object[count];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">			result[i] = parameters.get(i).getValue();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个类的核心数据就是parameters，它是由ViewParameterModel类组成的List。构造方法是用来建立parameters的，然后其他两个方法得到参数类型数组和得到参数值数组都是以后反射机制需要用的。这个类完美的体现了<strong><em>Java的面向对象思想</em></strong>。  </p>
<blockquote>
<p>Java面向对象思想:一个类的核心是成员，类的建立就是通过考虑成员才建立出来的，该类的所有方法都是围绕这个成员来进行操作的。考虑问题不是考虑完成这个问题的具体步骤（面向过程思想），而是先考虑能把问题分成由哪些对象或者成员组成，由多个对象的联系来完成问题。  </p>
</blockquote>
<p><strong>tips:要记得进行局部性验证，保证做到现在为止是否正确。</strong></p>
<hr>
<p>&emsp;接下来就要考虑XML文件中各个控件的存放了，还没有进行真正的XML解析，还是只考虑XML文件中的一些数据。此时，XML文件中controller标签中id属性才能体现出作用，起id这个名字才能说的通，它是主键。存放XML中各个控件用Map存放，键为该控件名称，值为该控件真正的对象。<code>Map&lt;String, Object&gt;</code>关于这里值为Object类型，因为控件类型各有不同所以用Object来统一管理（Object是一切类的基类）。<br>&emsp;但是！！！<strong>问题也出在Object！</strong>如果值为Object，说明他什么都可以接收，什么都可以向这个Map里面放，也就意味着可以放入根本不属于控件类型的对象。这麻烦就大了。所以“<strong>万物皆可Object</strong>“这句话既是褒义词也是贬义词。因为它是所有类基类，所以我们可以很方便用它，但是，也正是因为它是所有类的基类，也会带来危险。<br>&emsp;说上面这些话是为了引出工具保护思想，就拿这里做例子，我们一定不能把这个存放控件的<code>Map</code>传到外面让他人使用，防止他人放不应该放的东西进行破坏。细心的人可能发现我前面的工具类基本很少有public，都是用的包权限。这就是工具的保护！只能在这个包下进行操作，包外无权处理。<strong>所以做工具一定要有工具保护思想！！！</strong>。<br>&emsp;上面说了这么多，只是提出一个小的工具编程思想。接下来真正的引出我们下一个工具类ViewFactory。</p>
<h4 id="ViewFactory类"><a href="#ViewFactory类" class="headerlink" title="ViewFactory类"></a>ViewFactory类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; viewControllerPool;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ViewFactory viewFactory;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ViewFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		viewControllerPool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewFactory <span class="title">newInstance</span><span class="params">()</span> </span>&#123;	<span class="comment">//代表新界面的ViewFactory</span></span><br><span class="line">		viewFactory = <span class="keyword">new</span> ViewFactory();</span><br><span class="line">		<span class="keyword">return</span> viewFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewFactory <span class="title">currentInstance</span><span class="params">()</span> </span>&#123;	<span class="comment">//代表当前界面的ViewFactory</span></span><br><span class="line">		<span class="keyword">return</span> viewFactory == <span class="keyword">null</span> ? newInstance() : viewFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">addController</span><span class="params">(String id, Object object)</span> </span>&#123;</span><br><span class="line">		viewControllerPool.put(id, object);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getController</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> viewControllerPool.get(id);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;这个类的核心是viewControllerPool，用来存放XML中相应控件的，关于增加控件和得到控件两个方法很简单，就不再赘述。<br>&emsp;但是关于另一个成员viewFactory我要说下。这是一种十分简单的单例模式，就意思这个类只需要也只能有一个对象。考虑下面一种问题，如果已经产生了个界面，然后又要产生界面怎么办？两个界面肯定控件不同呀，不能往pool里一直加东西吧，如果键重复了可不就出问题了吗？所以给了两个得到ViewFactory的方法，一个是<code>newnewInstance()</code>该方法表明新开个界面，其中的pool就重新申请了，不管以前的控件了。另一个是<code>currentInstance()</code>意思是当前的ViewFactory对象，如果没有则申请，如果有则可得到当前的pool里面放着当前界面的已经加进去的控件。  </p>
<hr>
<p>接下来，是EasySwing工具最后一个类了。终于在前面我们分析并解决了XML文件中一些数据的存储问题，接下来就是真正的解析XML文件了，然后用已经建好的工具类去存储相关数据了。</p>
<p><a href="https://honorzmj98.github.io/2020/03/06/XML文件与Properites文件解析工具/">XML文件解析工具</a></p>
<h4 id="ViewFactoryBuilder类"><a href="#ViewFactoryBuilder类" class="headerlink" title="ViewFactoryBuilder类"></a>ViewFactoryBuilder类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewFactoryBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String jframe = <span class="string">"mainView"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewFactoryBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ViewFactory viewFactory = ViewFactory.currentInstance();</span><br><span class="line">		JFrame mainView = (JFrame) viewFactory.getController(jframe);</span><br><span class="line">		mainView.setVisible(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadPropertiesFileConfigPath</span><span class="params">(String configPath)</span> </span>&#123;</span><br><span class="line">		ProperitiesParse.loadProperities(configPath);</span><br><span class="line">		<span class="comment">//加载相关的properties文件，要用绝对路径</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadXMLFileConfigPath</span><span class="params">(String configPath)</span> </span>&#123;	<span class="comment">//参数是相关XML文件路径，可以是相对路径</span></span><br><span class="line">		ViewFactory viewFactory = ViewFactory.newInstance();	<span class="comment">//解析一个新的XML文件代表新的一个ViewFactory里要存放新的控件</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String id = element.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">				String para = element.getAttribute(<span class="string">"para"</span>);</span><br><span class="line">				String father = element.getAttribute(<span class="string">"father"</span>);</span><br><span class="line">				String locate = element.getAttribute(<span class="string">"locate"</span>);</span><br><span class="line">				String mainView = element.getAttribute(<span class="string">"mainView"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Class&lt;?&gt; klass = Class.forName(ProperitiesParse.value(id));</span><br><span class="line">					ViewParameters viewParameters = <span class="keyword">new</span> ViewParameters(para);</span><br><span class="line">					Constructor&lt;?&gt; constructor = klass.getDeclaredConstructor(viewParameters.getParametersType());</span><br><span class="line">					Object controller = constructor.newInstance(viewParameters.getParametersValue());</span><br><span class="line">					<span class="keyword">if</span> (mainView.equalsIgnoreCase(<span class="string">"true"</span>)) &#123;</span><br><span class="line">						viewFactory.addController(jframe, controller);</span><br><span class="line">					&#125;</span><br><span class="line">					viewFactory.addController(id, controller);</span><br><span class="line">					parseMethod(element, klass, controller);</span><br><span class="line">					addController(father.trim(), locate.trim(), controller, viewFactory);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(XMLParse.getDocument(configPath), <span class="string">"controller"</span>);</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseMethod</span><span class="params">(Element element, Class&lt;?&gt; klass, Object controller)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> XMLParse() &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealElement</span><span class="params">(Element element, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">				String name = element.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">				String para = element.getAttribute(<span class="string">"para"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					ViewParameters viewParameters = <span class="keyword">new</span> ViewParameters(para);</span><br><span class="line">					Method method = klass.getMethod(ProperitiesParse.value(name), viewParameters.getParametersType());</span><br><span class="line">					method.invoke(controller, viewParameters.getParametersValue());</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;.parseTag(element, <span class="string">"method"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addController</span><span class="params">(String father, String locate, Object sonController, ViewFactory viewFactory)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (father.length() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		IPaneAddMethod fatherController = (IPaneAddMethod) viewFactory.getController(father);</span><br><span class="line">		<span class="keyword">if</span> (locate.length() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			fatherController.IAdd((Component) sonController);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			String location = ProperitiesParse.value(locate);</span><br><span class="line">			fatherController.IAdd((Component) sonController, location);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类是最容易出错的地方，记录下我所踩过的坑。</p>
<ol>
<li>反射得到方法，我用的是getDeclaredMethod()，这个可以获获得到本类的所有方法，包括public，private，protected修饰的，但是他不可以得到父类的方法。经过修改应该用getMethod()，能获取当前类和父类public修饰的方法，仅限public。因为有些控件的方法是父类的，所以要用getMethod()。</li>
<li>进行局部性验证的时候发现，总是出现NoSuchMethodException()异常，仔细查看，发现问题。<code>java.awt.Container.setLayout(java.awt.BorderLayout)</code>和<code>javax.swing.JFrame.setLocationRelativeTo(java.lang.Object)</code>经过查看源码发现是参数类型不对，所以找不到该方法。</li>
</ol>
<p>为了解决第二个问题，采用以下方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MJframe</span> <span class="keyword">extends</span> <span class="title">JFrame</span> </span>&#123;	<span class="comment">//继承JFrame，以便完成某些特定方法</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">324446629969726058L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MJframe</span><span class="params">()</span> <span class="keyword">throws</span> HeadlessException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MJframe</span><span class="params">(GraphicsConfiguration gc)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(gc);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MJframe</span><span class="params">(String title)</span> <span class="keyword">throws</span> HeadlessException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(title);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MJframe</span><span class="params">(String title, GraphicsConfiguration gc)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(title, gc);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocationRelativeTo</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.setLocationRelativeTo(<span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentPane</span><span class="params">(MContainer contentPane)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.setContentPane(contentPane);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPaneAddMethod</span> </span>&#123;<span class="comment">//该接口是为了方便以后容器里面加控件的方便。</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">IAdd</span><span class="params">(Component component)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">IAdd</span><span class="params">(Component component, Object object)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MContainer</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">IPaneAddMethod</span> </span>&#123; </span><br><span class="line">	<span class="comment">//继承Container类，以便完成某些方法，同时实现IPaneAddMethod接口，以便以后加控件</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7116483843211133420L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLayout</span><span class="params">(BorderLayout borderLayout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.setLayout(borderLayout);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLayout</span><span class="params">(FlowLayout flowLayout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.setLayout(flowLayout);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLayout</span><span class="params">(GridLayout gridLayout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.setLayout(gridLayout);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IAdd</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.add(component);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IAdd</span><span class="params">(Component component, Object object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.add(component, object);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MJpnlFoot</span> <span class="keyword">extends</span> <span class="title">JPanel</span> <span class="keyword">implements</span> <span class="title">IPaneAddMethod</span> </span>&#123;<span class="comment">//继承JPnel，方便以后加控件</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7489743937546425832L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IAdd</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">super</span>.add(component);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">IAdd</span><span class="params">(Component component, Object object)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">super</span>.add(component, object);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时去修改properties文件里的配置即可解决。<br>该类（ViewFactoryBuilder）的主要任务是扫面XML文件，并根据XML文件结合以前的工具类，并将加载配置方法和显示最后的主界面对外用。<br>至此，EasySwing工具的主要四个工具类就全部做完了！  </p>
<hr>
<h3 id="EasySwing工具具体的使用步骤"><a href="#EasySwing工具具体的使用步骤" class="headerlink" title="EasySwing工具具体的使用步骤"></a>EasySwing工具具体的使用步骤</h3><ol>
<li>首先将想要生成的界面有关配置文件（XML文件和properties文件）根据上面所述规则写好。</li>
<li>ViewFactoryBuilder.loadPropertiesFileConfigPath(“properties文件的绝对路径”)</li>
<li>ViewFactoryBuilder.loadXMLFileConfigPath(“XML文件的相对路径”);</li>
<li>ViewFactoryBuilder.showView();就可以生成想要的界面了。  </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		ViewFactoryBuilder.loadPropertiesFileConfigPath(<span class="string">"E:\\A大三\\大三上\\JavaProject\\20200303@Easyswing\\src\\initViewStore.properties"</span>);</span><br><span class="line">		ViewFactoryBuilder.loadXMLFileConfigPath(<span class="string">"/initViewCfg.xml"</span>);</span><br><span class="line">		ViewFactoryBuilder.showView();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>运行上述代码后，结果如下:<br><img src="/img/EasySwing/2.png" alt="1" style="zoom:50%;" /></p>
<p>我保证绝对不是只把上面图copy过来，就是用EasySwing工具运行出来的。不信你们可以用这个工具去试一试。我会将它上传到Github上。<br><strong>//TODO上传工具代码到github上</strong></p>
<hr>
<p>至此，EasySwing工具的编写告一段落了。<br><strong>但是！！！</strong> 其实这个工具还没有达到完美。有两个问题。  </p>
<ol>
<li>不知道你有没有发现我写的XML文件的顺序是不能变的，也就是说，一些必须要先生成的控件必须写在XML文件前面，后生成的控件才可以用它。这样给用户带来不便了，理想情况应该是写XML文件的顺序对于生成界面要没有影响。所以，我这还是有点瑕疵的，等待进一步完善。</li>
<li>控件的响应事件没有添加，按按钮应该要产生相应的事件啊。是，这是锦上添花的事，以后等我进一步完善。</li>
</ol>
<p><strong>在此感谢王兆阳同学和朱洪老师的耐心指导！</strong></p>
<p align="right">最后编辑于:2020-03-04 </p>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/03/EasySwing%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90%E7%95%8C%E9%9D%A2%E7%9A%84%E5%B7%A5%E5%85%B7/" data-id="ck8bqrizv0000t4i2bpmr886b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-我的第一篇博客" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/" class="article-date">
  <time datetime="2020-03-02T06:58:20.220Z" itemprop="datePublished">2020-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/">我的第一篇博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;这是我的第一篇博客，首先要感谢一个B站up主，根据他的视频<a href="https://www.bilibili.com/video/av44544186" target="_blank" rel="noopener">搭建个人博客</a>，我才建立起自己的Hexo博客的。因为是第一次写博客，所以对一些内容还不是很熟悉，并且排版也不是很美观，以后会尽量多学习和多写博客，争取写出排版美观，内容充实的好博文。</p>
<p>&emsp;&emsp;先来简要说说我的大一大二生活吧，我大一大二就是玩上来的基本没有学习，倒是游戏的Rank分打的挺高，还自诩自己是西邮GuXue和西邮第一辅助，为了游戏上分，我经常熬夜打游戏，就这样浑浑噩噩过了两年，荒废了两年时光。直到大二下才彻底醒悟，觉得我游戏打那么好也不算什么特长以后也不能写在简历上拿这个去找工作。还想到曾经老师讲过的一句话:“一个人虚拟世界等级越高，他在现实生活中就越空虚。”我发现说的真对，我在现实生活中就和网上是截然不同性格的两个人，网络中我打字飞快，和网友什么骚话和梗都能说得出，现实生活中唯唯诺诺，参加聚会就一个人独自在旁边听，一句话也不说。  </p>
<p>&emsp;&emsp;因此，我从大二下就开始改变了。我开始听课了，并且有一些喜欢的课程。我有好习惯的，喜欢总结东西，有整理笔记的好习惯。但纸质笔记有个缺点，不易携带，且我个人不喜欢写标题而且字有点潦草，每次翻阅查找都很麻烦。直到知道了博客，完全可以解决上述缺点，因此我准备把写笔记的好习惯改为写博文的好习惯，用来记录我在学习中的问题。下面来写下我自己认为写博文的好处。</p>
<h2 id="写博客的好处"><a href="#写博客的好处" class="headerlink" title="写博客的好处"></a>写博客的好处</h2><ol>
<li>&emsp;写博客可以系统的整合自己某一阶段的学习成果。以前我的写在本子上的笔记就是这样的，先听老师上课讲，我就旁边放上草稿纸，记住关键性的内容，课后利用时间去整理，再去查资料完善笔记。现在就是把记笔记的过程换成写博客的过程，两者都是对自己某一阶段的学习做个总结。在这里我对自己提出要求：一定不能拖，讲完的内容趁热打铁，尽快写成自己通俗易懂的文字进行总结。  </li>
<li>&emsp;提高总结能力。这点是我缺乏的，我需要锻炼的，因为我在做老师给的小项目的时候，总喜欢把问题划分到很细，总是考虑细枝末节，就偏离了主心骨了。就像一棵树，考虑问题一定要先完成树干主心骨这里的问题，不能盲目直接考虑到树枝枝芽，那样说不定会被陷在里面不能自拔。所以我要写博文提高自己总结能力，以到达问问题和总结问题一针见血的目的。</li>
<li>&emsp;提高表达能力。我这个人不爱说话,但是和熟人却能畅谈，这可能就是人们说的性格:闷骚。网络看不见陌生人，或者都是陌生人，我就不在乎了，心理上就不会有所畏惧，就能大胆放心说话了。（反正你们又不认识我，也没见过我，更不能隔着屏幕来打我^_^）。还是要提高表达和与他人交流的能力的！因为以后面试的时候要面对面试官，当然要把自己所知道的知识大大方方的给面试官说出来。</li>
</ol>
<h2 id="对自己的要求"><a href="#对自己的要求" class="headerlink" title="对自己的要求"></a>对自己的要求</h2><ol>
<li>&emsp;对于我这种编程小白来说现在写博文就写自己学习上遇到的问题和自己做的小项目，同时我将保证自己写的每个代码可以复现，这样为别人带来方便。给现在自己定的最大的目标:可以在秋招找个好工作。而现在小目标就是编程中遇到的问题，经过总结写成博文。就这样，一步步实现每个目标。</li>
<li>&emsp;要把博客空间看做自己的网络小家，就像以前非主流时期（黑历史）打理自己空间一样精心打理博客。里面放着我在网上贡献的一切，以后希望回头看能看到充实的大学生活。</li>
<li>&emsp;一定要坚持下来！坚持就是胜利。写博客要变成一种习惯，要成为每天必做的事。吾日三省吾身，今天博文写了吗？今天在写博文吗？今天有什么要写成博文的吗？一定要坚持，开始是很难的，排版也不美观，写的也没什么技术含量，但只要坚持写，一切都会变好的！</li>
</ol>
<p><br></br><br>&emsp;&emsp;好了，话不多说，现在就开始去写一篇技术博客。<br><br></br><br><br></br></p>
<p align="right">最后编辑于:2020-03-03 14:54:57 星期二</p>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://honorzmj98.github.io/2020/03/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/" data-id="ck8bqrj0q0004t4i26spy1i6u" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/17/CSFramework%E5%B0%8F%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">CSFramework小型开发工具</a>
          </li>
        
          <li>
            <a href="/2020/03/11/CSFramework%E7%9A%84%E5%BC%95%E5%87%BA/">CSFramework的引出</a>
          </li>
        
          <li>
            <a href="/2020/03/06/XML%E6%96%87%E4%BB%B6%E4%B8%8EProperites%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7/">XML文件与Properites文件解析工具</a>
          </li>
        
          <li>
            <a href="/2020/03/03/EasySwing%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90%E7%95%8C%E9%9D%A2%E7%9A%84%E5%B7%A5%E5%85%B7/">EasySwing一键生成界面的工具</a>
          </li>
        
          <li>
            <a href="/2020/03/02/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/">我的第一篇博客</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 HonorZmj98<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>